// ====================================================================
// 명사 사전 (상위 1000개 고빈도 명사)
// ====================================================================
const NOUN_DICT = new Set([
    "영어", "미국", "대한민국", "선수", "일본", "일본어", "배우", "위치", "음반", "축구",
    "사용", "영화", "지역", "인구", "도시", "세계", "독일", "발매", "활동", "이름",
    "영국", "국가", "기준", "프랑스", "대표", "정치인", "올림픽", "독일어", "포함", "가수",
    "감독", "밴드", "포지션", "이후", "스튜디오", "리그", "유럽", "소속", "대통령", "이탈리아",
    "프로", "스페인어", "시절", "프랑스어", "사이", "활약", "출신", "철도", "사람", "유명",
    "구성", "한국", "시대", "러시아", "면적", "제작", "개발", "게임", "지구", "그룹",
    "지정", "최초", "일반", "시작", "기록", "음악", "일부", "중국어", "드라마", "여성",
    "중국", "의미", "발견", "지방", "대학", "하계", "역사", "처음", "작품", "데뷔",
    "여자", "연방", "기관", "공화국", "주요", "수상", "세포", "동안", "브라질", "당시",
    "이상", "국도", "획득", "연구", "현재", "역임", "학교", "레코드", "독립", "행정",
    "문화", "설립", "존재", "목록", "교육", "스위스", "러시아어", "철도역", "사회", "현역",
    "역할", "센터", "세기", "제국", "야구", "작가", "시간", "대전", "서울", "발생",
    "스페인", "전쟁", "그리스", "주도", "노래", "정부", "공립", "구역", "이전", "해당",
    "조선", "인도", "소설", "길이", "가운데", "국제", "도쿄", "중심", "경기", "노선",
    "구조", "녹음", "도로", "대회", "농구", "다양", "대학교", "참가", "스웨덴", "출연",
    "병음", "최고", "국립", "전투", "미드필더", "제도", "운영", "시리즈", "동쪽", "일종",
    "유래", "수도", "캐나다", "교수", "보컬", "클럽", "최대", "대부분", "장관", "고등학교",
    "북부", "명칭", "남쪽", "은퇴", "발표", "전직", "나라", "포르투갈어", "북쪽", "이용",
    "텔레비전", "태양", "멤버", "공식", "기능", "의원", "참여", "연결", "시즌", "서쪽",
    "앨범", "인간", "종목", "높이", "형태", "회사", "사망", "건물", "용어", "마지막",
    "중앙", "로마", "오스트리아", "생산", "과정", "종류", "분야", "문화어", "장치", "네덜란드",
    "유일", "남부", "우크라이나", "부문", "관할", "아르헨티나", "정치", "모양", "평가",
    "형성", "시기", "자유", "산업", "세대", "영향", "신경", "총리", "소련", "기술",
    "번호", "수비수", "거리", "상태", "경기장", "공개", "규모", "제품", "단위", "스포츠",
    "지도자", "제공", "동물", "베트남", "관계", "공항", "시스템", "차지", "스타", "공원",
    "모델", "결합", "프로듀서", "동부", "항공", "남자", "정규", "작곡가", "아프리카",
    "위원", "사건", "전통", "판매", "언어", "진행", "버스", "효소", "발음", "대상",
    "빌보드", "현대", "아랍어", "육군", "뉴욕", "예술", "초대", "일원", "지진",
    "공군", "제임스", "공간", "아일랜드", "기반", "폴란드", "수행", "바이러스", "지원",
    "기업", "조직", "능력", "성공", "특정", "문자", "등장", "래퍼", "사운드", "서비스",
    "영화배우", "연기", "고대", "교회", "경제", "단백질", "후보", "방법", "분포", "종교",
    "인기", "물질", "전체", "프로그램", "교통", "공격수", "해군", "중요", "공동", "선정",
    "컴퓨터", "구간", "사립", "주의", "주변", "관련", "차트", "자동차", "학명", "설계",
    "건설", "과거", "서울특별시", "서부", "민족", "동계", "우승", "조약", "사단", "등록",
    "관리", "박물관", "여객", "크기", "노벨", "본부", "육상", "금메달", "본관", "작업",
    "그리스어", "은메달", "주연", "군인", "승강장", "운동가", "산맥", "전철", "도서관",
    "생성", "강원", "비디오", "선거", "디자인", "줄무늬", "설치", "지배", "구분",
    "아래", "황제", "목적", "공격", "자리", "소행성", "말레이시아", "멕시코", "군사",
    "분자", "발전", "문제", "인물", "대만", "중심지", "약칭", "리드", "종합",
    "시설", "골키퍼", "사진", "이론", "통합", "정보", "전기", "넓이", "소프트웨어",
    "결정", "중부", "전역", "아카데미", "위원회", "개념", "이집트", "개통", "전선",
    "치료", "지명", "고전", "분류", "신호", "운동", "이야기", "헝가리", "고체",
    "태풍", "시인", "전자", "빙하", "연주자", "전달", "온도", "투수", "콜롬비아",
    "국민", "가능", "작전", "부대", "전차", "칠레", "결과", "보호", "자연",
    "표준", "네트워크", "세균", "상징", "계열", "파리", "인정", "담당", "핸드볼",
    "선거구", "집단", "구별", "다음", "국경", "카운티", "협회", "본사", "랠리",
    "사고", "대사", "화학", "생활", "출생", "기간", "정상", "정책", "범죄",
    "상대", "포도", "민주", "학자", "출시", "계획", "관측", "영역", "워싱턴",
    "합성", "민주당", "표현", "무역", "작곡", "메이저", "서식", "탄생", "국회",
    "초기", "특징", "영상", "대신", "성장", "중간", "주장", "임시", "소비자",
    "안전", "의회", "마이클", "방송", "실험", "건축", "측정", "오픈", "정교회",
    "우주", "호른", "필리핀", "필터", "아미노", "제외", "기계", "로버트", "열차",
    "현상", "전용", "건축물", "아들", "묘사", "유산", "개봉", "지바", "연구소",
    "비교", "붕괴", "빌딩", "중학교", "화학자", "작용", "지대", "골든", "궤도",
    "공관", "정의", "통과", "간주", "표기", "유기", "내각", "조사", "프로젝트",
    "자신", "제목", "요리", "문서", "시장", "계약", "기타", "아시아", "윌리엄",
    "평론가", "노르웨이", "홍콩", "탈퇴", "꼬리", "왕국", "학생", "외부", "상업",
    "출전", "국립공원", "선수단", "수록", "지점", "운행", "루이스", "연극", "지하철",
    "남동부", "과학", "생물", "태국", "태평양", "방식", "식물", "행성", "미국인",
    "성당", "한국어", "전문", "주니어", "전지", "성분", "자회사", "설치류", "연속",
    "칼리지", "제조", "오늘날", "정점", "별명", "애플", "개최", "아버지", "경계",
    "시각", "음악가", "공무원", "업무", "대중", "지지", "추정", "밀도", "스타일",
    "기본", "추산", "순위", "다리", "원래", "이동", "회의", "동맥", "재즈",
    "체계", "시리아", "이란", "계단", "갤럭시", "바다", "식품", "저장", "유지",
    "코치", "보유", "화합물", "일대", "남아메리카", "마드리드", "방향", "데이비스",
    "정맥", "문신", "일제", "강점기", "경주", "방영", "타워", "마천루", "사랑",
    "동메달", "인근", "그림", "이미지", "모바일", "올해", "계급", "카드", "설명",
    "피터", "문화재", "필요", "복합", "달성", "볼리비아", "생물학", "트랙", "기념",
    "천체", "원작", "신화", "여신", "라틴어", "소설가", "혁명", "사용자", "연합",
    "악기", "변화", "영향력", "효과", "미술", "브라운", "국왕", "결성", "기체",
    "데이터", "속도", "분리", "찰스", "영토", "디스크", "개인", "점령", "소니",
    "소재지", "차례", "아이", "근육", "장소", "제정", "역대", "메달", "런던",
    "동명", "박쥐", "렌즈", "구단", "솔로", "냉장고", "이하", "히트", "대체",
    "회장", "물건", "기구", "평균", "우수", "정체", "국군", "아내", "안정",
    "라이트", "진도", "박사", "일정", "이온", "항성", "확인", "차이", "전력",
    "체육", "요소", "유전자", "북동부", "글로브", "남우", "여우", "동맹",
    "각본", "모습", "윈도우", "최종", "마을", "냄새", "노동", "특별시", "포도주",
    "장르", "플레이어", "시민", "부족", "약물", "제한", "암컷", "음식", "실시",
    "질병", "상원", "이자", "사업", "질량", "고리", "근처", "근무", "관구",
    "윙어", "코마", "차원", "조절", "감염", "진단", "코드", "분해", "호수",
    "힙합", "케이블", "줄기", "케네디", "어머니", "라인", "몰도바", "인터넷",
    "연설", "당선", "자료", "레이저", "특이", "문학", "관심", "가스", "용해도",
    "헌법", "위장", "남성", "거대", "봉황", "자전거", "환경", "장군", "경력",
    "외야수", "처리", "임명", "유형", "취급", "유엔", "산하", "쌍둥이", "인접",
    "기지", "결혼", "보이", "콩고", "최근", "철학자", "기원", "필름", "초점",
    "안드로이드", "투어", "종료", "예정", "명명", "헨리", "기존", "북서부",
    "정식", "스톰", "항공기", "화재", "체제", "단선", "브랜드", "적용", "질환",
    "불교", "시상식", "전철역", "사상", "주재", "아미노산", "협력", "내용", "머리",
    "동일", "너비", "이유", "주목", "지칭", "반대", "접촉", "우루과이", "제어",
    "분지", "화석", "성우", "전국", "날개", "연재", "장애", "지금", "구성원",
    "화가", "바탕", "가사", "단계", "해체", "여행", "공국", "해안", "출간",
    "거주", "신분", "빅토리아", "리스트", "모스크바", "기획", "상호", "압력",
    "합류", "경로", "수컷", "아테네", "뉴질랜드", "어워드", "기질", "편집",
    "연장", "베른", "피닉스", "연출", "디자이너", "자음", "삼성", "챔피언",
    "발사", "후반", "합병", "리옹", "향토", "반도", "기독교", "출발", "핑크",
    "보병", "법률", "제사장", "자바", "유치원", "페놀", "아이폰", "범위",
    "선언", "정차", "에너지", "방출", "조합", "동생", "패스", "동료", "확장",
    "군청", "단지", "사령부", "운반", "음력", "말기", "개장", "장기", "유사",
    "재임", "내전", "물체", "펜싱", "월드", "권투", "등재", "장편", "기상청",
    "강아지", "간식", "냄새", "알레르기", "걱정", "입맛", "반응", "가격", "성분", "산책",
    "스마트폰", "카메라", "성능", "배터리", "디자인", "무게", "사진", "제품",
    "문제집", "설명", "시험", "대비", "책", "난이도", "수학", "유형", "반복", "학습", "개념", "정리",
    "피자", "치즈", "학생", "친구", "크기", "주문", "음식", "점심", "시간", "자리",
    "사과", "바나나", "딸기", "주스"
]);

// ====================================================================
// 개선된 형태소 분석기 클래스
// ====================================================================
class MeCabWrapper {
    constructor() {
        this.initialized = false;
    }

    async initialize() {
        this.initialized = true;
        return this;
    }

    analyze(text) {
        const words = [];
        // 공백과 구두점으로 분리
        const tokens = text.split(/\s+/);

        tokens.forEach(token => {
            if (!token) return;
            
            // 구두점 제거
            token = token.replace(/[.,!?;:'"()]/g, '');
            if (!token) return;

            const morphs = this.maxMatchingParse(token);
            if (morphs.length > 0) {
                words.push({ morphs });
            }
        });

        return words;
    }

    // 최대 매칭 알고리즘을 사용한 형태소 분석
    maxMatchingParse(word) {
        const morphemes = [];
        let pos = 0;

        while (pos < word.length) {
            let maxLen = 0;
            let foundNoun = null;

            // 현재 위치에서 가장 긴 명사 찾기 (최대 10글자까지)
            for (let len = Math.min(10, word.length - pos); len >= 1; len--) {
                const substr = word.substring(pos, pos + len);
                if (NOUN_DICT.has(substr)) {
                    maxLen = len;
                    foundNoun = substr;
                    break;
                }
            }

            if (foundNoun) {
                // 명사 사전에서 발견
                morphemes.push({ lex: foundNoun, tag: 'NNG' });
                pos += maxLen;
            } else {
                // 명사 사전에 없으면 조사/어미 분리 시도
                const remaining = word.substring(pos);
                const parsed = this.parseParticle(remaining);
                
                if (parsed.length > 0) {
                    morphemes.push(...parsed);
                    break; // 나머지 전체 처리 완료
                } else {
                    // 파싱 실패 시 1글자 명사로 처리
                    morphemes.push({ lex: word.charAt(pos), tag: 'NNG' });
                    pos++;
                }
            }
        }

        return morphemes;
    }

    // 조사/어미 분리
    parseParticle(word) {
        const morphemes = [];

        // 조사 패턴 (빈도순)
        const particles = [
            // 2글자 조사
            { suffix: '에서', tag: 'JKB' },
            { suffix: '에게', tag: 'JKB' },
            { suffix: '한테', tag: 'JKB' },
            { suffix: '까지', tag: 'JX' },
            { suffix: '부터', tag: 'JX' },
            { suffix: '조차', tag: 'JX' },
            { suffix: '마저', tag: 'JX' },
            { suffix: '으로', tag: 'JKB', needFinal: true },
            { suffix: '이랑', tag: 'JC', needFinal: true },
            // 1글자 조사
            { suffix: '은', tag: 'JX', needFinal: true },
            { suffix: '을', tag: 'JKO', needFinal: true },
            { suffix: '과', tag: 'JC', needFinal: true },
            { suffix: '는', tag: 'JX', needFinal: false },
            { suffix: '를', tag: 'JKO', needFinal: false },
            { suffix: '와', tag: 'JC', needFinal: false },
            { suffix: '로', tag: 'JKB', needFinal: false },
            { suffix: '랑', tag: 'JC', needFinal: false },
            { suffix: '이', tag: 'JKS', needFinal: true },
            { suffix: '가', tag: 'JKS', needFinal: false },
            { suffix: '에', tag: 'JKB' },
            { suffix: '도', tag: 'JX' },
            { suffix: '만', tag: 'JX' }
        ];

        // 어미 패턴
        const endings = [
            { suffix: '습니다', tag: 'EF' },
            { suffix: 'ㅂ니다', tag: 'EF' },
            { suffix: '었어요', tag: 'EF' },
            { suffix: '았어요', tag: 'EF' },
            { suffix: '겠어요', tag: 'EF' },
            { suffix: '했어요', tag: 'EF' },
            { suffix: '이에요', tag: 'EF' },
            { suffix: '예요', tag: 'EF' },
            { suffix: '었다', tag: 'EF' },
            { suffix: '았다', tag: 'EF' },
            { suffix: '했다', tag: 'EF' },
            { suffix: '한다', tag: 'EF' },
            { suffix: '된다', tag: 'EF' },
            { suffix: '겠다', tag: 'EF' },
            { suffix: '어요', tag: 'EF' },
            { suffix: '아요', tag: 'EF' },
            { suffix: '요', tag: 'EF' },
            { suffix: '다', tag: 'EF' }
        ];

        // 조사 먼저 시도
        for (const particle of particles) {
            if (word.endsWith(particle.suffix) && word.length > particle.suffix.length + 1) {
                const base = word.slice(0, -particle.suffix.length);
                
                // 받침 조건 검사
                if (particle.needFinal !== undefined) {
                    const lastChar = base[base.length - 1];
                    const hasFinal = this.hasFinalConsonant(lastChar);
                    if (particle.needFinal !== hasFinal) continue;
                }

                morphemes.push({ lex: base, tag: 'NNG' });
                morphemes.push({ lex: particle.suffix, tag: particle.tag });
                return morphemes;
            }
        }

        // 어미 시도
        for (const ending of endings) {
            if (word.endsWith(ending.suffix) && word.length > ending.suffix.length) {
                const base = word.slice(0, -ending.suffix.length);
                morphemes.push({ lex: base, tag: 'VV' });
                morphemes.push({ lex: ending.suffix, tag: ending.tag });
                return morphemes;
            }
        }

        // 파싱 실패 - 전체를 명사로
        if (word.length > 0) {
            morphemes.push({ lex: word, tag: 'NNG' });
        }

        return morphemes;
    }

    // 받침 유무 확인
    hasFinalConsonant(char) {
        if (!char) return false;
        const code = char.charCodeAt(0) - 0xAC00;
        if (code < 0 || code > 11171) return false;
        return (code % 28) !== 0;
    }
}