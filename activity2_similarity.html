<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í…ìŠ¤íŠ¸ ë¶„ì„ ì²´í—˜ - AI Mathematics</title>

    <!-- í•œêµ­ì–´ í˜•íƒœì†Œ ë¶„ì„ ì‚¬ì „ (í´ë°±ìš©) -->
    <script src="korean-dict.js"></script>

    <!-- í™•ì¥ ëª…ì‚¬ ì‚¬ì „ (3000+ ë‹¨ì–´) -->
    <script src="ëª…ì‚¬ì‚¬ì „.js"></script>

    <!-- Hangul.js - í•œê¸€ ìëª¨ ë¶„í•´/ì¡°í•© -->
    <script src="https://cdn.jsdelivr.net/npm/hangul-js@0.2.6/hangul.min.js"></script>

    <!-- wordcloud2.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Noto+Sans+KR:wght@300;400;500;700;900&family=Gamja+Flower&family=Gaegu:wght@300;400;700&family=Dokdo&family=Jua&family=Black+Han+Sans&family=Roboto+Mono:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Noto Sans KR", sans-serif;
        background: #e8eef4;
        min-height: 100vh;
        padding: 20px;
      }

      header h1 {
        font-family: "Do Hyeon", sans-serif;
        font-weight: 500;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-family: "Noto Sans KR", sans-serif;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      header {
        background: #1e3a5f;
        color: white;
        padding: 30px;
        text-align: center;
      }

      header h1 {
        font-family: "Do Hyeon", sans-serif;
        font-size: 2.8em;
        font-weight: 500;
        margin-bottom: 10px;
      }

      header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .tabs {
        display: flex;
        background: #f5f5f5;
        border-bottom: 2px solid #ddd;
      }

      .tab {
        flex: 1;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        background: #f5f5f5;
        border: none;
        font-size: 1.3em;
        font-weight: 600;
        color: #666;
        transition: all 0.3s;
        position: relative;
      }

      .tab.active {
        background: white;
        color: #1e3a5f;
      }

      .tab.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 4px;
        background: #c9a227;
      }

      .tab:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .tab-content {
        display: none;
        padding: 30px;
        animation: fadeIn 0.3s;
        position: relative;
        z-index: 1;
        background: white;
        min-height: 400px;
      }

      .tab-content.active {
        display: block !important;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 2px 8px rgba(30, 58, 95, 0.2);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 4px 16px rgba(93, 173, 226, 0.5);
        }
      }

      .welcome-screen {
        text-align: center;
        padding: 50px 20px;
      }

      .welcome-screen h2 {
        color: #1e3a5f;
        font-size: 2em;
        margin-bottom: 30px;
      }

      .role-selection {
        display: flex;
        gap: 30px;
        justify-content: center;
        margin-top: 40px;
      }

      .role-card {
        background: #1e3a5f;
        color: white;
        padding: 40px;
        border-radius: 15px;
        cursor: pointer;
        transition:
          transform 0.3s,
          box-shadow 0.3s;
        width: 250px;
      }

      .role-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(30, 58, 95, 0.3);
      }

      .role-card h3 {
        font-size: 1.8em;
        margin-bottom: 15px;
      }

      .role-card p {
        font-size: 1em;
        opacity: 0.9;
      }

      .room-code-display {
        text-align: center;
        padding: 40px;
        background: #f8f9fa;
        border-radius: 15px;
        margin: 20px 0;
      }

      .room-code-display h3 {
        color: #1e3a5f;
        font-size: 1.5em;
        margin-bottom: 20px;
      }

      .room-code {
        font-size: 3em;
        font-weight: bold;
        color: #c9a227;
        letter-spacing: 5px;
        margin: 20px 0;
        font-family: "Courier New", monospace;
      }

      #qrcode {
        display: inline-block;
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: 10px;
      }

      .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
      }

      button {
        padding: 15px 30px;
        font-size: 1em;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
      }

      .btn-primary {
        background: #1e3a5f;
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #4a6fa5;
        color: white;
      }

      .btn-secondary:hover {
        background: #3d5a87;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      input[type="text"] {
        width: 100%;
        max-width: 400px;
        padding: 15px;
        font-size: 1.1em;
        border: 2px solid #ddd;
        border-radius: 10px;
        margin: 10px 0;
        transition: border-color 0.3s;
      }

      input[type="text"]:focus {
        outline: none;
        border-color: #1e3a5f;
      }

      .student-input-area {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .student-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid transparent;
        transition: all 0.3s;
      }

      .student-card.completed {
        border-color: #28a745;
        background: #d4edda;
      }

      .student-card h4 {
        color: #1e3a5f;
        margin-bottom: 10px;
      }

      textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        resize: vertical;
        min-height: 80px;
      }

      .participation-status {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }

      .participation-status h3 {
        color: #1e3a5f;
        margin-bottom: 15px;
      }

      .status-bar {
        background: #e9ecef;
        height: 30px;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .status-progress {
        height: 100%;
        background: #1e3a5f;
        transition: width 0.5s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .analysis-section {
        margin: 30px 0;
      }

      .analysis-section h3 {
        color: #1e3a5f;
        margin-bottom: 20px;
        font-size: 1.5em;
      }

      #wordcloud-container {
        background: white;
        border: 2px solid #ddd;
        border-radius: 10px;
        padding: 20px;
        min-height: 550px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      #wordcloud-canvas {
        width: 100%;
        max-width: 900px;
        height: 550px;
        margin: 0 auto;
      }

      .shape-settings {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .shape-option {
        display: inline-block;
        margin: 5px;
        padding: 15px 25px;
        border: 2px solid #ddd;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        background: white;
      }

      .shape-option:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .shape-option.active {
        background: #1e3a5f;
        color: white;
        border-color: #1e3a5f;
      }

      .frequency-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        table-layout: fixed;
      }

      .frequency-table th,
      .frequency-table td {
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid #ddd;
      }

      .frequency-table th:nth-child(1),
      .frequency-table th:nth-child(5),
      .frequency-table td:nth-child(1),
      .frequency-table td:nth-child(5) {
        width: 8%;
      }

      .frequency-table th:nth-child(2),
      .frequency-table th:nth-child(6),
      .frequency-table td:nth-child(2),
      .frequency-table td:nth-child(6) {
        width: 22%;
        text-align: left;
      }

      .frequency-table th:nth-child(3),
      .frequency-table th:nth-child(7),
      .frequency-table td:nth-child(3),
      .frequency-table td:nth-child(7) {
        width: 10%;
      }

      .frequency-table th:nth-child(4),
      .frequency-table th:nth-child(8),
      .frequency-table td:nth-child(4),
      .frequency-table td:nth-child(8) {
        width: 10%;
      }

      .frequency-table th {
        background: #1e3a5f;
        color: white;
      }

      .frequency-table tr:hover {
        background: #f8f9fa;
      }

      .chart-container {
        margin-top: 30px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #ddd;
      }

      .word-selection {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 20px 0;
      }

      .word-checkbox {
        display: flex;
        align-items: center;
        background: #f8f9fa;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .word-checkbox:hover {
        background: #e9ecef;
      }

      .word-checkbox input[type="checkbox"] {
        margin-right: 10px;
        cursor: pointer;
      }

      /* ë¬¸ì¥ ì„ íƒ ìŠ¤íƒ€ì¼ */
      .sentence-selection {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .sentence-item {
        padding: 12px 15px;
        background: white;
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }

      .sentence-item:hover {
        border-color: #1e3a5f;
        background: #f0f4f8;
      }

      .sentence-item.selected {
        border-color: #1e3a5f;
        background: #e8f4fd;
        box-shadow: 0 2px 8px rgba(30, 58, 95, 0.2);
      }

      .sentence-item .sentence-number {
        background: #1e3a5f;
        color: white;
        padding: 4px 10px;
        border-radius: 5px;
        font-weight: 600;
        font-size: 0.85em;
        white-space: nowrap;
      }

      .sentence-item.selected .sentence-number {
        background: #c9a227;
      }

      .sentence-item .sentence-text {
        flex: 1;
        line-height: 1.5;
        word-break: break-word;
      }

      .matrix-table {
        width: 100%;
        overflow-x: auto;
        margin: 20px 0;
      }

      .matrix-table table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
      }

      .matrix-table th,
      .matrix-table td {
        padding: 8px;
        text-align: center;
        border: 1px solid #ddd;
      }

      .matrix-table th {
        background: #1e3a5f;
        color: white;
        position: sticky;
        top: 0;
      }

      .matrix-table td {
        background: white;
      }

      .similarity-results {
        margin-top: 30px;
      }

      .similarity-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 4px solid #1e3a5f;
      }

      .similarity-card .similarity-value {
        font-family: "Roboto Mono", "SF Mono", Consolas, monospace;
        font-size: 1.3em;
        font-weight: 600;
        color: #1e3a5f;
        background: #e8f4fd;
        padding: 4px 10px;
        border-radius: 5px;
      }

      .heatmap-container {
        margin-top: 30px;
        text-align: center;
      }

      .hidden {
        display: none !important;
      }

      .tutorial {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .tutorial h4 {
        color: #856404;
        margin-bottom: 10px;
      }

      .tutorial-step {
        margin: 10px 0;
        padding-left: 20px;
      }

      @media (max-width: 768px) {
        .role-selection {
          flex-direction: column;
          align-items: center;
        }

        .student-input-area {
          grid-template-columns: 1fr;
        }

        .tabs {
          flex-wrap: wrap;
        }

        .tab {
          flex: 1 1 50%;
        }
      }
      /* í˜•íƒœì†Œ ë¶„ì„ ìŠ¤íƒ€ì¼ */
      .morpheme-card {
        background: var(--bg);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
      }

      .morpheme-header {
        font-weight: 700;
        color: #1e3a5f;
        margin-bottom: 10px;
        font-size: 0.95rem;
      }

      .morpheme-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .morpheme-item {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        padding: 6px 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
        position: relative;
        font-family: "Noto Sans KR", sans-serif;
      }

      .morpheme-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .morpheme-item.selected {
        background: #3498db;
        border-color: #2471a3;
        color: white;
      }

      .morpheme-item.deselected {
        background: #95a5a6;
        border-color: #7f8c8d;
        color: white;
        opacity: 0.85;
      }

      .morpheme-item.marked {
        background: #f39c12;
        border: 2px solid #d68910;
        box-shadow: 0 0 12px rgba(243, 156, 18, 0.5);
        color: white;
      }

      .morpheme-item.editing {
        background: #fff9e6;
        border-color: #f39c12;
      }

      .morpheme-edit-input {
        width: 60px;
        padding: 2px 4px;
        border: 1px solid #1e3a5f;
        border-radius: 4px;
        font-size: 0.85rem;
        text-align: center;
        font-family: inherit;
      }

      .morpheme-edit-buttons {
        display: flex;
        gap: 4px;
        margin-top: 4px;
      }

      .morpheme-edit-btn {
        padding: 2px 6px;
        font-size: 0.7rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .morpheme-edit-btn.save {
        background: #27ae60;
        color: white;
      }

      .morpheme-edit-btn.cancel {
        background: #e74c3c;
        color: white;
      }

      .morpheme-split-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 20px;
        height: 20px;
        background: #1e3a5f;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 0.7rem;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .morpheme-item:hover .morpheme-split-btn {
        display: flex;
      }

      .morpheme-split-btn:hover {
        background: #0d1f38;
        transform: scale(1.1);
      }

      .morpheme-word {
        font-weight: 700;
        color: #2c3e50;
        font-family: "Noto Sans KR", sans-serif;
      }

      .morpheme-pos {
        font-size: 0.75rem;
        color: #7f8c8d;
        margin-top: 2px;
        font-family: "Noto Sans KR", sans-serif;
      }

      /* selected/deselected/marked ìƒíƒœì—ì„œ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
      .morpheme-item.selected .morpheme-word,
      .morpheme-item.selected .morpheme-pos,
      .morpheme-item.deselected .morpheme-word,
      .morpheme-item.deselected .morpheme-pos,
      .morpheme-item.marked .morpheme-word,
      .morpheme-item.marked .morpheme-pos {
        color: white;
      }

      /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 0;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        animation: slideDown 0.3s;
      }

      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
        color: white;
        padding: 20px 30px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-family: "Noto Sans KR", sans-serif;
        font-size: 1.5em;
      }

      .modal-close {
        background: transparent;
        border: none;
        color: white;
        font-size: 2em;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
      }

      .modal-close:hover {
        transform: scale(1.2);
      }

      .modal-body {
        padding: 30px;
        font-family: "Noto Sans KR", sans-serif;
      }

      .pos-category {
        margin-bottom: 25px;
      }

      .pos-category h3 {
        color: #8e44ad;
        font-size: 1.2em;
        margin-bottom: 12px;
        border-bottom: 2px solid #8e44ad;
        padding-bottom: 8px;
      }

      .pos-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      .pos-table th {
        background: #f5f0fa;
        color: #8e44ad;
        padding: 10px;
        text-align: left;
        font-weight: 700;
        border: 1px solid #e0d4ed;
      }

      .pos-table td {
        padding: 10px;
        border: 1px solid #e0d4ed;
      }

      .pos-table tr:hover {
        background: #faf8fc;
      }

      .pos-tag {
        display: inline-block;
        background: #9b59b6;
        color: white;
        padding: 3px 8px;
        border-radius: 4px;
        font-family: "Roboto Mono", monospace;
        font-size: 0.9em;
        font-weight: 600;
        min-width: 50px;
        text-align: center;
      }

      .pos-example {
        color: #555;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ“Š í…ìŠ¤íŠ¸ ë¶„ì„ ì²´í—˜</h1>
        <p>ë‹¨ì–´ ë¹ˆë„ ë¶„ì„ë¶€í„° ì½”ì‚¬ì¸ ìœ ì‚¬ë„ê¹Œì§€ ì²´í—˜í•˜ê¸°</p>
      </header>

      <div class="tabs" id="tab-navigation">
        <button class="tab active" id="tab-btn-collection">ğŸ“ ë¬¸ì¥ ìˆ˜ì§‘</button>
        <button class="tab" id="tab-btn-morpheme" disabled>
          ğŸ” í˜•íƒœì†Œ ë¶„ë¦¬
        </button>
        <button class="tab" id="tab-btn-analysis" disabled>
          ğŸ“Š í…ìŠ¤íŠ¸ ë¶„ì„
        </button>
        <button class="tab" id="tab-btn-vector" disabled>ğŸ”¢ ë²¡í„° ê³„ì‚°</button>
      </div>

      <div id="tab-collection" class="tab-content active">
        <div id="role-selection-screen">
          <div class="welcome-screen">
            <h2>í…ìŠ¤íŠ¸ ë¶„ì„ ì²´í—˜ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
            <p>ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            <div class="role-selection">
              <div
                class="role-card"
                data-role="teacher"
                style="background: #1e3a5f"
              >
                <h3>ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜</h3>
                <p>ìƒˆë¡œìš´ ìˆ˜ì—… ë°©ì„ ë§Œë“¤ê³ <br />í•™ìƒë“¤ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
              </div>
              <div
                class="role-card"
                data-role="student"
                style="background: #2d5a87"
              >
                <h3>ğŸ‘¨â€ğŸ“ í•™ìƒ</h3>
                <p>ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ê³ <br />ìˆ˜ì—…ì— ì°¸ì—¬í•©ë‹ˆë‹¤</p>
              </div>
              <div
                class="role-card"
                data-role="demo"
                style="background: #3d7ab0"
              >
                <h3>ğŸ§ª ì²´í—˜í•˜ê¸°</h3>
                <p>ë°© ì½”ë“œ ì—†ì´ í˜¼ìì„œ<br />ë¹ ë¥´ê²Œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤</p>
              </div>
            </div>
          </div>
        </div>

        <div id="teacher-view" class="hidden">
          <div class="tutorial">
            <h4>ğŸ“š ìˆ˜ì—… ì§„í–‰ ê°€ì´ë“œ</h4>
            <div class="tutorial-step">
              1. ì•„ë˜ ë°© ì½”ë“œë¥¼ í•™ìƒë“¤ì—ê²Œ ê³µìœ í•˜ì„¸ìš”
            </div>
            <div class="tutorial-step">
              2. ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì—¬ í•™ìƒë“¤ì—ê²Œ ë³´ì—¬ì¤„ ì£¼ì œë¥¼ ì„¤ì •í•˜ì„¸ìš”
            </div>
            <div class="tutorial-step">
              3. í•™ìƒë“¤ì´ ì…ë ¥ì„ ì™„ë£Œí•˜ë©´ "ì…ë ¥ ë§ˆê°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
            </div>
            <div class="tutorial-step">
              4. "í…ìŠ¤íŠ¸ ë¶„ì„" íƒ­ìœ¼ë¡œ ì´ë™í•˜ì—¬ ì›Œë“œí´ë¼ìš°ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”
            </div>
          </div>

          <div class="room-code-display">
            <h3>ğŸ”‘ ë°© ì½”ë“œ</h3>
            <div class="room-code" id="room-code-text">------</div>
            <div
              id="room-expiry-info"
              style="
                margin: 10px 0;
                color: #e74c3c;
                font-weight: 600;
                font-size: 1em;
              "
            >
              â° ë‚¨ì€ ì‹œê°„: <span id="room-time-remaining">--</span>
            </div>
            <div id="qrcode"></div>
            <div class="button-group">
              <button class="btn-primary" id="copy-room-code-btn">
                ğŸ“‹ ì½”ë“œ ë³µì‚¬
              </button>
              <button class="btn-primary" id="copy-room-url-btn">
                ğŸ”— ë§í¬ ë³µì‚¬
              </button>
            </div>
          </div>

          <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¹ì…˜ -->
          <div
            class="image-upload-section"
            style="
              background: #f8f9fa;
              border-radius: 15px;
              padding: 25px;
              margin: 20px 0;
              border: 2px dashed #1e3a5f;
            "
          >
            <h3 style="color: #1e3a5f; margin-bottom: 15px">
              ğŸ–¼ï¸ ì£¼ì œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
            </h3>
            <p style="color: #666; margin-bottom: 15px">
              í•™ìƒë“¤ì´ ë³´ê³  ë¬¸ì¥ì„ ì‘ì„±í•  ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”
            </p>

            <div style="margin-top: 20px">
              <h4 style="color: #1e3a5f; margin-bottom: 10px">
                ğŸ“· ì£¼ì œ ì´ë¯¸ì§€ (ì„ íƒì‚¬í•­)
              </h4>
              <div
                id="image-upload-box"
                style="
                  border: 3px dashed #1e3a5f;
                  border-radius: 12px;
                  padding: 40px;
                  text-align: center;
                  cursor: pointer;
                  transition: all 0.3s;
                  background: white;
                  min-height: 200px;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                "
              >
                <div id="image-upload-placeholder">
                  <p style="color: #1e3a5f; font-size: 1.1em; margin: 10px 0">
                    ğŸ–¼ï¸ í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ
                  </p>
                  <p style="font-size: 0.9em; color: #666">
                    í•™ìƒë“¤ì´ ì°¸ê³ í•  ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”
                  </p>
                </div>
                <img
                  id="topic-image-preview"
                  style="
                    max-width: 100%;
                    max-height: 400px;
                    border-radius: 8px;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                    display: none;
                  "
                />
              </div>
              <input
                type="file"
                id="topic-image-input"
                accept="image/*"
                style="display: none"
              />
              <div style="margin-top: 15px; text-align: center">
                <button
                  class="btn-danger"
                  id="remove-image-btn"
                  style="display: none"
                >
                  ğŸ—‘ï¸ ì´ë¯¸ì§€ ì‚­ì œ
                </button>
              </div>
            </div>
          </div>

          <!-- í†µê³„ ì¹´ë“œ -->
          <div
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 20px;
              margin: 30px 0;
            "
          >
            <div
              style="
                background: #e74c3c;
                color: white;
                padding: 25px;
                border-radius: 12px;
                text-align: center;
                box-shadow: 0 2px 10px rgba(231, 76, 60, 0.2);
              "
            >
              <div
                style="font-size: 2.5em; font-weight: 700; margin-bottom: 10px"
                id="participant-count"
              >
                0
              </div>
              <div style="font-size: 1.1em; opacity: 0.95">ğŸ‘¥ ì°¸ê°€ì ìˆ˜</div>
            </div>
            <div
              style="
                background: #27ae60;
                color: white;
                padding: 25px;
                border-radius: 12px;
                text-align: center;
                box-shadow: 0 2px 10px rgba(39, 174, 96, 0.2);
              "
            >
              <div
                style="font-size: 2.5em; font-weight: 700; margin-bottom: 10px"
                id="completed-count"
              >
                0
              </div>
              <div style="font-size: 1.1em; opacity: 0.95">âœ… ì œì¶œ ì™„ë£Œ</div>
            </div>
          </div>

          <div class="participation-status">
            <h3>ğŸ“Š ì‹¤ì‹œê°„ ì°¸ì—¬ í˜„í™©</h3>
            <div class="status-bar">
              <div class="status-progress" id="progress-bar" style="width: 0%">
                0ëª… ì°¸ì—¬
              </div>
            </div>
            <p id="participation-text">ëŒ€ê¸° ì¤‘...</p>
          </div>

          <div class="student-input-area" id="students-grid"></div>

          <div class="button-group" style="margin-top: 30px">
            <button class="btn-secondary" onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
            <button class="btn-danger" id="close-input-btn">
              ğŸ”’ ì…ë ¥ ë§ˆê°
            </button>
            <button class="btn-success" id="start-analysis-btn" disabled>
              â–¶ï¸ ë¶„ì„ ì‹œì‘
            </button>
          </div>
        </div>

        <div id="student-view" class="hidden">
          <div id="room-join" class="welcome-screen">
            <h2>ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</h2>
            <input
              type="text"
              id="room-code-input"
              placeholder="ì˜ˆ: ABC123"
              maxlength="6"
            />
            <br />
            <button class="btn-primary" id="join-room-btn">ğŸšª ì…ì¥í•˜ê¸°</button>
            <button
              class="btn-secondary"
              onclick="goHome()"
              style="margin-top: 10px"
            >
              ğŸ  í™ˆìœ¼ë¡œ
            </button>
          </div>

          <div id="student-input" class="hidden">
            <div id="nickname-section">
              <div class="tutorial">
                <h4>ğŸ“ ë¬¸ì¥ ì‘ì„± ê°€ì´ë“œ</h4>
                <div class="tutorial-step">
                  ë‹‰ë„¤ì„ ì…ë ¥ í›„ ì£¼ì œ ì´ë¯¸ì§€ë¥¼ ë³´ê³  ë¬¸ì¥ì„ ì‘ì„±í•´ì£¼ì„¸ìš”
                </div>
              </div>

              <div style="text-align: center; margin: 30px 0">
                <h3>ğŸ‘¤ ë‹‰ë„¤ì„ ì…ë ¥</h3>
                <p style="color: #4a5568; margin: 10px 0 20px 0">
                  í•™ë²ˆ ë˜ëŠ” ì´ë¦„ì„ ì…ë ¥í•˜ê±°ë‚˜, ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ì•„ë˜ ë²„íŠ¼ì„
                  ëˆ„ë¥´ì„¸ìš”
                </p>
                <input
                  type="text"
                  id="nickname-input"
                  placeholder="ì˜ˆ: 10101 í™ê¸¸ë™"
                />
                <br />
                <button class="btn-primary" id="set-nickname-btn">
                  âœ… ì‹œì‘í•˜ê¸°
                </button>
              </div>
            </div>

            <div id="sentence-input" class="hidden">
              <div style="text-align: right; margin-bottom: 15px">
                <button class="btn-secondary" onclick="goBackToNickname()">
                  â¬…ï¸ ë‹‰ë„¤ì„ ì…ë ¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
              </div>

              <!-- ë¬¸ì¥ ì…ë ¥ ë‹¨ê³„ì—ì„œë„ ì´ë¯¸ì§€ í‘œì‹œ -->
              <div
                id="sentence-topic-image"
                style="text-align: center; margin: 20px 0; display: none"
              >
                <h3 style="color: #1e3a5f; margin-bottom: 15px">
                  ğŸ–¼ï¸ ì£¼ì œ ì´ë¯¸ì§€
                </h3>
                <img
                  id="sentence-image-display"
                  style="
                    max-width: 100%;
                    max-height: 350px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
                  "
                />
              </div>

              <h3 style="color: #1e3a5f; margin-bottom: 20px">
                ğŸ“ ë¬¸ì¥ ì‘ì„± (<span id="student-nickname"></span>)
              </h3>

              <div class="tutorial" style="margin-bottom: 20px">
                <h4>ğŸ“ ë¬¸ì¥ ì‘ì„± ê°€ì´ë“œ</h4>
                <div class="tutorial-step">
                  ìœ„ ì´ë¯¸ì§€ë¥¼ ë³´ê³  ë– ì˜¤ë¥´ëŠ” ë¬¸ì¥ì„ ì‘ì„±í•´ì£¼ì„¸ìš”
                </div>
              </div>

              <div style="margin: 20px 0">
                <label><strong>ë¬¸ì¥:</strong></label>
                <textarea
                  id="sentence1"
                  placeholder="ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”..."
                  style="
                    width: 100%;
                    padding: 15px;
                    font-size: 1.1em;
                    border: 2px solid #ddd;
                    border-radius: 10px;
                    font-family: &quot;Noto Sans KR&quot;, sans-serif;
                    min-height: 100px;
                  "
                ></textarea>
              </div>

              <button class="btn-success" id="submit-sentences-btn">
                ğŸ“¤ ì œì¶œí•˜ê¸°
              </button>

              <div
                id="submission-status"
                class="hidden"
                style="
                  margin-top: 20px;
                  padding: 20px;
                  background: #d4edda;
                  border-radius: 10px;
                  text-align: center;
                "
              >
                <h3 style="color: #155724">âœ… ì œì¶œ ì™„ë£Œ!</h3>
                <p>ì„ ìƒë‹˜ì´ ë¶„ì„ì„ ì‹œì‘í•˜ë©´ ê²°ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div
                  style="
                    margin-top: 15px;
                    display: flex;
                    gap: 10px;
                    justify-content: center;
                    flex-wrap: wrap;
                  "
                >
                  <button class="btn-primary" id="view-analysis-student-btn">
                    ğŸ“Š ë¶„ì„ ê²°ê³¼ ë³´ê¸°
                  </button>
                  <button class="btn-secondary" onclick="goHome()">
                    ğŸ  í™ˆìœ¼ë¡œ
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="demo-view" class="hidden">
          <div
            class="tutorial"
            style="
              background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%);
              border-color: #00bcd4;
            "
          >
            <h4 style="color: #006064">ğŸ§ª ì²´í—˜ ëª¨ë“œ ê°€ì´ë“œ</h4>
            <div class="tutorial-step">
              1. ì•„ë˜ì—ì„œ ë¬¸ì¥ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš” (ìµœì†Œ 1ê°œ ì´ìƒ)
            </div>
            <div class="tutorial-step">
              2. ê° ì¤„ë§ˆë‹¤ í•˜ë‚˜ì˜ ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”
            </div>
            <div class="tutorial-step">
              3. "ë¶„ì„ ì‹œì‘" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê²°ê³¼ë¥¼ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
            </div>
          </div>

          <div
            style="
              background: white;
              padding: 30px;
              border-radius: 15px;
              margin-top: 20px;
            "
          >
            <h3 style="color: #00bcd4; margin-bottom: 20px">
              ğŸ“ ë¶„ì„í•  ë¬¸ì¥ ì…ë ¥
            </h3>
            <textarea
              id="demo-sentences"
              rows="15"
              style="
                width: 100%;
                padding: 15px;
                font-size: 1.1em;
                border: 2px solid #00bcd4;
                border-radius: 10px;
                font-family: &quot;Noto Sans KR&quot;, sans-serif;
                line-height: 1.8;
              "
              placeholder="ì˜ˆì‹œ:
ê¸‰ì‹ì´ ì •ë§ ë§›ìˆì—ˆì–´ìš”
ì˜¤ëŠ˜ ì§œì¥ë©´ì´ ìµœê³ ì˜€ì–´ìš”
ì²´ìœ¡ì‹œê°„ì´ ì¬ë¯¸ìˆì—ˆì–´ìš”
ì¹œêµ¬ë“¤ê³¼ ë†€ì•˜ì–´ìš”
ìˆ˜í•™ ì‹œí—˜ì´ ì–´ë ¤ì› ì–´ìš”
ì„ ìƒë‹˜ì´ ì¹œì ˆí•˜ì…¨ì–´ìš”

(í•œ ì¤„ì— í•˜ë‚˜ì˜ ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”)"
            ></textarea>

            <div style="margin-top: 20px; text-align: center">
              <button
                class="btn-success"
                id="start-demo-btn"
                style="font-size: 1.2em; padding: 15px 40px"
              >
                ğŸš€ ë¶„ì„ ì‹œì‘í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- í˜•íƒœì†Œ ë¶„ë¦¬ íƒ­ -->
      <div id="tab-morpheme" class="tab-content">
        <div class="tutorial">
          <h4>ğŸ” í˜•íƒœì†Œ ë¶„ë¦¬ ë‹¨ê³„</h4>
          <div class="tutorial-step">1. ê° ë¬¸ì¥ì´ ë‹¨ì–´ë¡œ ìë™ ë¶„ë¦¬ë©ë‹ˆë‹¤</div>
          <div class="tutorial-step">
            2. ì¡°ì‚¬ì™€ ì–´ë¯¸ê°€ ìë™ìœ¼ë¡œ ë¶„ë¦¬ë©ë‹ˆë‹¤ (ì˜ˆ: "í•™ìƒì€" â†’ "í•™ìƒ" + "ì€")
          </div>
          <div class="tutorial-step">
            3. í˜•íƒœì†Œë¥¼ í´ë¦­í•˜ë©´ ë¶„ì„ì— í¬í•¨/ì œì™¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
          </div>
          <div class="tutorial-step">
            4. Shift+í´ë¦­ìœ¼ë¡œ ì—¬ëŸ¬ í˜•íƒœì†Œë¥¼ ì„ íƒí•˜ì—¬ í•©ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤
          </div>
          <div class="tutorial-step">
            5. ë”ë¸”í´ë¦­í•˜ë©´ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
          </div>
          <div class="tutorial-step">
            6. âœ‚ï¸ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë‹¨ì–´ë¥¼ ë¶„ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
          </div>
        </div>

        <div class="analysis-section" id="morphemeMainCard">
          <h3>ğŸ” í˜•íƒœì†Œ ë¶„ì„ ê²°ê³¼</h3>
          <div
            style="
              background: rgba(93, 173, 226, 0.1);
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 20px;
              font-size: 1em;
              color: #555;
              border-left: 4px solid #5dade2;
            "
          >
            ğŸ’¡ <strong>ì‚¬ìš© ë°©ë²•:</strong> <br /><br />
            <strong>â€¢ í´ë¦­:</strong> í˜•íƒœì†Œë¥¼ ë¶„ì„ì— í¬í•¨í•˜ê±°ë‚˜ ì œì™¸í•©ë‹ˆë‹¤
            <br /><strong>â€¢ Shift+í´ë¦­:</strong> ì—¬ëŸ¬ í˜•íƒœì†Œë¥¼ ì„ íƒí•˜ì—¬ í•©ì¹©ë‹ˆë‹¤
            (ì£¼í™©ìƒ‰ìœ¼ë¡œ í‘œì‹œ) <br /><strong>â€¢ ë”ë¸”í´ë¦­:</strong> í˜•íƒœì†Œì˜ ë‚´ìš©ì„
            ì§ì ‘ ìˆ˜ì •í•©ë‹ˆë‹¤ <br /><strong>â€¢ âœ‚ï¸ ë²„íŠ¼:</strong> ë‹¨ì–´ë¥¼ ë‘ ê°œë¡œ
            ë¶„ë¦¬í•©ë‹ˆë‹¤ <br /><br />
            <span style="color: #3498db; font-weight: 700"
              >âœ… íŒŒë€ìƒ‰ = ë¶„ì„ì— í¬í•¨</span
            >
            /
            <span style="color: #95a5a6; font-weight: 700"
              >â¬œ íšŒìƒ‰ = ì œì™¸ë¨</span
            >
            /
            <span style="color: #f39c12; font-weight: 700"
              >ğŸŸ¨ ì£¼í™©ìƒ‰ = í•©ì¹˜ê¸° ìœ„í•´ ì„ íƒë¨</span
            >
          </div>

          <div id="morphemeMainContainer"></div>

          <div
            id="merge-button-container"
            style="margin-top: 20px; text-align: center; display: none"
          >
            <button
              class="btn-primary"
              onclick="mergeMorphemes()"
              style="background: #ffc107; color: #333; font-weight: 600"
            >
              ğŸ”— ì„ íƒí•œ í˜•íƒœì†Œ í•©ì¹˜ê¸° (<span id="merge-count">0</span>ê°œ)
            </button>
            <button
              class="btn-secondary"
              onclick="clearMarkedMorphemes()"
              style="margin-left: 10px"
            >
              âœ–ï¸ ì„ íƒ ì·¨ì†Œ
            </button>
          </div>

          <div
            id="morpheme-bottom-buttons"
            style="
              margin-top: 30px;
              text-align: center;
              display: flex;
              gap: 15px;
              justify-content: center;
              flex-wrap: wrap;
            "
          >
            <button class="btn-secondary" onclick="goBackToCollection()">
              â¬…ï¸ ë¬¸ì¥ ìˆ˜ì§‘ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
            <button
              class="btn-primary"
              onclick="showMorphemeGuide()"
              style="background: #9b59b6; font-size: 1em; padding: 12px 24px"
            >
              ğŸ“– í˜•íƒœì†Œ ì„¤ëª…
            </button>
            <button
              class="btn-success"
              onclick="proceedToAnalysis()"
              style="font-size: 1.1em; padding: 15px 30px"
            >
              â¡ï¸ í…ìŠ¤íŠ¸ ë¶„ì„ ì‹œì‘
            </button>
          </div>
        </div>
      </div>

      <div id="tab-analysis" class="tab-content">
        <div class="tutorial">
          <h4>ğŸ“Š í…ìŠ¤íŠ¸ ë¶„ì„ ë‹¨ê³„</h4>
          <div class="tutorial-step">
            1. ì›Œë“œí´ë¼ìš°ë“œì—ì„œ ìì£¼ ë“±ì¥í•˜ëŠ” ë‹¨ì–´ë¥¼ í™•ì¸í•˜ì„¸ìš”
          </div>
          <div class="tutorial-step">
            2. ë¹ˆë„ í…Œì´ë¸”ì—ì„œ ì •í™•í•œ ë“±ì¥ íšŸìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”
          </div>
          <div class="tutorial-step">
            3. ìƒìœ„ 8~12ê°œ ë‹¨ì–´ë¥¼ ì„ íƒí•˜ì—¬ ë²¡í„° ê³„ì‚°ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤
          </div>
        </div>

        <div class="analysis-section">
          <h3>â˜ï¸ ì›Œë“œí´ë¼ìš°ë“œ</h3>

          <div class="shape-settings">
            <div style="margin-bottom: 15px">
              <strong>ğŸ¨ ëª¨ì–‘ ì„ íƒ:</strong><br />
              <!-- ë§ˆìŠ¤í¬ ì´ë¯¸ì§€ ë°©ì‹ ì‚¬ìš© -->
              <button class="shape-option active" data-shape="circle">
                âšª ì›í˜•
              </button>
              <button class="shape-option" data-shape="heart">â¤ï¸ í•˜íŠ¸</button>
              <button class="shape-option" data-shape="star">â­ ë³„</button>
              <button class="shape-option" data-shape="cloud">â˜ï¸ êµ¬ë¦„</button>
              <button class="shape-option" data-shape="diamond">
                ğŸ’ ë‹¤ì´ì•„
              </button>
              <button class="shape-option" data-shape="square">
                â¬œ ì‚¬ê°í˜•
              </button>
            </div>

            <div style="margin-bottom: 15px">
              <strong>ğŸ”¤ í°íŠ¸ ì„ íƒ:</strong><br />
              <button
                class="shape-option font-option active"
                data-font="Do Hyeon"
                style="font-family: &quot;Do Hyeon&quot;"
              >
                ë„í˜„
              </button>
              <button
                class="shape-option font-option"
                data-font="Black Han Sans"
                style="font-family: &quot;Black Han Sans&quot;"
              >
                ê²€ì€ê³ ë”•
              </button>
              <button
                class="shape-option font-option"
                data-font="Jua"
                style="font-family: &quot;Jua&quot;"
              >
                ì£¼ì•„
              </button>
              <button
                class="shape-option font-option"
                data-font="Dokdo"
                style="font-family: &quot;Dokdo&quot;"
              >
                ë…ë„
              </button>
              <button
                class="shape-option font-option"
                data-font="Gamja Flower"
                style="font-family: &quot;Gamja Flower&quot;"
              >
                ê°ìê½ƒ
              </button>
            </div>

            <div style="text-align: center">
              <label>
                <input type="checkbox" id="stopwords-toggle" checked />
                ë¶ˆìš©ì–´ ì œê±° (ì¡°ì‚¬, ì–´ë¯¸ ë“±)
              </label>
            </div>
          </div>

          <div id="wordcloud-container">
            <canvas id="wordcloud-canvas"></canvas>
          </div>
        </div>

        <div class="analysis-section">
          <h3>ğŸ“ˆ ë‹¨ì–´ ë¹ˆë„ ë¶„ì„</h3>
          <table class="frequency-table" id="frequency-table">
            <thead>
              <tr>
                <th>ìˆœìœ„</th>
                <th>ë‹¨ì–´</th>
                <th>ë¹ˆë„</th>
                <th>ë¹„ìœ¨</th>
                <th style="border-left: 2px solid #ddd">ìˆœìœ„</th>
                <th>ë‹¨ì–´</th>
                <th>ë¹ˆë„</th>
                <th>ë¹„ìœ¨</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="chart-container">
          <canvas id="frequency-chart"></canvas>
        </div>

        <div
          style="
            text-align: center;
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
          "
        >
          <button class="btn-secondary" onclick="goBackToMorpheme()">
            â¬…ï¸ í˜•íƒœì†Œ ë¶„ë¦¬ë¡œ ëŒì•„ê°€ê¸°
          </button>
          <button class="btn-success" id="proceed-vector-btn">
            â¡ï¸ ë²¡í„° ê³„ì‚°ìœ¼ë¡œ ì´ë™
          </button>
        </div>
      </div>

      <div id="tab-vector" class="tab-content">
        <div style="text-align: right; margin-bottom: 15px">
          <button class="btn-secondary" onclick="goBackToAnalysis()">
            â¬…ï¸ í…ìŠ¤íŠ¸ ë¶„ì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°
          </button>
        </div>
        <div class="tutorial">
          <h4>ğŸ”¢ ë²¡í„° ê³„ì‚° ë‹¨ê³„</h4>
          <div class="tutorial-step">
            1. ë¶„ì„í•  ë¬¸ì¥ì„ ì„ íƒí•˜ì„¸ìš” (í´ë¦­í•˜ì—¬ ì„ íƒ/í•´ì œ)
          </div>
          <div class="tutorial-step">2. ë¶„ì„í•  ë‹¨ì–´ 8~12ê°œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
          <div class="tutorial-step">
            3. ì½”ì‚¬ì¸ ìœ ì‚¬ë„ë¥¼ ê³„ì‚°í•˜ì—¬ ë¹„ìŠ·í•œ ë¬¸ì¥ì„ ì°¾ìŠµë‹ˆë‹¤
          </div>
        </div>

        <!-- ë¬¸ì¥ ì„ íƒ ì„¹ì…˜ -->
        <div class="analysis-section">
          <h3>ğŸ“ ë¶„ì„í•  ë¬¸ì¥ ì„ íƒ</h3>
          <div style="margin-bottom: 15px">
            <button class="btn-secondary" id="select-all-sentences-btn">
              ì „ì²´ ì„ íƒ
            </button>
            <button class="btn-secondary" id="deselect-all-sentences-btn">
              ì „ì²´ í•´ì œ
            </button>
            <span
              id="selected-sentence-count"
              style="margin-left: 15px; color: #1e3a5f; font-weight: 600"
              >0ê°œ ì„ íƒë¨</span
            >
          </div>
          <div class="sentence-selection" id="sentence-selection"></div>
        </div>

        <div class="analysis-section">
          <h3>âœ… ë‹¨ì–´ ì„ íƒ</h3>
          <div style="margin-bottom: 20px">
            <button class="btn-secondary" id="auto-select-btn">
              ìë™ ì„ íƒ (ìƒìœ„ 10ê°œ)
            </button>
            <button class="btn-secondary" id="clear-selection-btn">
              ì„ íƒ ì´ˆê¸°í™”
            </button>
          </div>
          <div class="word-selection" id="word-selection"></div>
        </div>

        <div class="analysis-section">
          <h3>ğŸ“Š ë¬¸ì¥Ã—ë‹¨ì–´ ë¹ˆë„ í–‰ë ¬</h3>
          <div class="matrix-table" id="matrix-display"></div>
        </div>

        <div style="text-align: center; margin: 30px 0">
          <button class="btn-success" id="calc-similarity-btn">
            ğŸ” ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°
          </button>
          <button
            class="btn-primary"
            id="calc-euclidean-btn"
            style="margin-left: 10px"
          >
            ğŸ“ ìœ í´ë¦¬ë“œ ê±°ë¦¬ ê³„ì‚°
          </button>
        </div>

        <div class="analysis-section hidden" id="similarity-section">
          <h3 id="similarity-title">ğŸ¯ ê°€ì¥ ë¹„ìŠ·í•œ ë¬¸ì¥ ì°¾ê¸°</h3>
          <div class="similarity-results" id="similarity-results"></div>
        </div>

        <div class="analysis-section">
          <h3>ğŸ“Š ìœ ì‚¬ë„ ë¶„ì„í‘œ</h3>
          <p style="color: #666; margin-bottom: 15px">
            ê° ë¬¸ì¥ë¼ë¦¬ ì–¼ë§ˆë‚˜ ë¹„ìŠ·í•œì§€ í‘œë¡œ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. íŒŒë€ìƒ‰ì´ ì§„í• ìˆ˜ë¡
            ìœ ì‚¬ë„ê°€ ë†’ìŠµë‹ˆë‹¤.
          </p>
          <div class="heatmap-container">
            <canvas id="heatmap-canvas"></canvas>
          </div>
        </div>

        <div class="analysis-section">
          <h3>ğŸ“ ë¬¸ì¥ ë¹„êµ ê·¸ë˜í”„</h3>
          <p style="color: #666; margin-bottom: 15px">
            ì„ íƒí•œ ë‹¨ì–´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê° ë¬¸ì¥ì´ ì–¼ë§ˆë‚˜ ê·¸ ë‹¨ì–´ë¥¼ í¬í•¨í•˜ëŠ”ì§€
            ë§‰ëŒ€ê·¸ë˜í”„ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.
          </p>
          <div id="vector-chart-container">
            <canvas id="vector-chart" width="800" height="400"></canvas>
          </div>
        </div>

        <div style="text-align: center; margin-top: 30px">
          <button class="btn-primary" id="download-btn">
            ğŸ’¾ ê²°ê³¼ ìŠ¤í¬ë¦°ìƒ· ë‹¤ìš´ë¡œë“œ
          </button>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- í˜•íƒœì†Œ ì„¤ëª… ëª¨ë‹¬ -->
    <div id="morpheme-guide-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸ“– í˜•íƒœì†Œ í’ˆì‚¬ íƒœê·¸ ì„¤ëª…</h2>
          <button class="modal-close" onclick="closeMorphemeGuide()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p style="color: #666; margin-bottom: 20px">
            í˜•íƒœì†Œ ë¶„ì„ ê²°ê³¼ì—ì„œ ë³¼ ìˆ˜ ìˆëŠ” í’ˆì‚¬ íƒœê·¸ì˜ ì˜ë¯¸ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.
          </p>

          <div class="pos-category">
            <h3>ğŸ“Œ ëª…ì‚¬ (Noun)</h3>
            <table class="pos-table">
              <tr>
                <th style="width: 80px">íƒœê·¸</th>
                <th>ì„¤ëª…</th>
                <th style="width: 200px">ì˜ˆì‹œ</th>
              </tr>
              <tr>
                <td><span class="pos-tag">NNG</span></td>
                <td>ì¼ë°˜ ëª…ì‚¬</td>
                <td class="pos-example">í•™êµ, ì‚¬ëŒ, ì»´í“¨í„°</td>
              </tr>
              <tr>
                <td><span class="pos-tag">NNP</span></td>
                <td>ê³ ìœ  ëª…ì‚¬</td>
                <td class="pos-example">ì„œìš¸, í•œêµ­, ì² ìˆ˜</td>
              </tr>
              <tr>
                <td><span class="pos-tag">NNB</span></td>
                <td>ì˜ì¡´ ëª…ì‚¬</td>
                <td class="pos-example">ê²ƒ, ìˆ˜, ë•Œ</td>
              </tr>
              <tr>
                <td><span class="pos-tag">NR</span></td>
                <td>ìˆ˜ì‚¬ (ìˆ˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ëª…ì‚¬)</td>
                <td class="pos-example">í•˜ë‚˜, ë‘˜, ì…‹, ì²«ì§¸, ì¼, ì´, ì‚¼</td>
              </tr>
              <tr>
                <td><span class="pos-tag">NP</span></td>
                <td>ëŒ€ëª…ì‚¬</td>
                <td class="pos-example">ë‚˜, ë„ˆ, ì´ê²ƒ</td>
              </tr>
            </table>
          </div>

          <div class="pos-category">
            <h3>ğŸ”¤ ë™ì‚¬/í˜•ìš©ì‚¬ (Verb/Adjective)</h3>
            <table class="pos-table">
              <tr>
                <th style="width: 80px">íƒœê·¸</th>
                <th>ì„¤ëª…</th>
                <th style="width: 200px">ì˜ˆì‹œ</th>
              </tr>
              <tr>
                <td><span class="pos-tag">VV</span></td>
                <td>ë™ì‚¬</td>
                <td class="pos-example">ë¨¹ë‹¤, ê°€ë‹¤, ë³´ë‹¤</td>
              </tr>
              <tr>
                <td><span class="pos-tag">VA</span></td>
                <td>í˜•ìš©ì‚¬</td>
                <td class="pos-example">ì˜ˆì˜ë‹¤, í¬ë‹¤, ì¢‹ë‹¤</td>
              </tr>
              <tr>
                <td><span class="pos-tag">VX</span></td>
                <td>ë³´ì¡° ìš©ì–¸</td>
                <td class="pos-example">ë³´ë‹¤, ì£¼ë‹¤, ì‹¶ë‹¤</td>
              </tr>
            </table>
          </div>

          <div class="pos-category">
            <h3>ğŸ“ ì¡°ì‚¬ (Particle)</h3>
            <table class="pos-table">
              <tr>
                <th style="width: 80px">íƒœê·¸</th>
                <th>ì„¤ëª…</th>
                <th style="width: 200px">ì˜ˆì‹œ</th>
              </tr>
              <tr>
                <td><span class="pos-tag">JKS</span></td>
                <td>ì£¼ê²© ì¡°ì‚¬</td>
                <td class="pos-example">ì´, ê°€, ê»˜ì„œ</td>
              </tr>
              <tr>
                <td><span class="pos-tag">JKO</span></td>
                <td>ëª©ì ê²© ì¡°ì‚¬</td>
                <td class="pos-example">ì„, ë¥¼</td>
              </tr>
              <tr>
                <td><span class="pos-tag">JKB</span></td>
                <td>ë¶€ì‚¬ê²© ì¡°ì‚¬</td>
                <td class="pos-example">ì—, ì—ì„œ, ìœ¼ë¡œ</td>
              </tr>
              <tr>
                <td><span class="pos-tag">JX</span></td>
                <td>ë³´ì¡°ì‚¬</td>
                <td class="pos-example">ì€, ëŠ”, ë„, ë§Œ</td>
              </tr>
              <tr>
                <td><span class="pos-tag">JC</span></td>
                <td>ì ‘ì† ì¡°ì‚¬</td>
                <td class="pos-example">ì™€, ê³¼, í•˜ê³ </td>
              </tr>
            </table>
          </div>

          <div class="pos-category">
            <h3>ğŸ”— ì–´ë¯¸ (Ending)</h3>
            <table class="pos-table">
              <tr>
                <th style="width: 80px">íƒœê·¸</th>
                <th>ì„¤ëª…</th>
                <th style="width: 200px">ì˜ˆì‹œ</th>
              </tr>
              <tr>
                <td><span class="pos-tag">EF</span></td>
                <td>ì¢…ê²° ì–´ë¯¸</td>
                <td class="pos-example">ë‹¤, ìš”, ë‹ˆ</td>
              </tr>
              <tr>
                <td><span class="pos-tag">EC</span></td>
                <td>ì—°ê²° ì–´ë¯¸</td>
                <td class="pos-example">ê³ , ë©°, ë©´ì„œ</td>
              </tr>
              <tr>
                <td><span class="pos-tag">ETN</span></td>
                <td>ëª…ì‚¬í˜• ì–´ë¯¸</td>
                <td class="pos-example">ê¸°, ìŒ, ã…</td>
              </tr>
              <tr>
                <td><span class="pos-tag">ETM</span></td>
                <td>ê´€í˜•í˜• ì–´ë¯¸</td>
                <td class="pos-example">ëŠ”, ã„´, ã„¹</td>
              </tr>
            </table>
          </div>

          <div class="pos-category">
            <h3>âœ¨ ê¸°íƒ€ (Others)</h3>
            <table class="pos-table">
              <tr>
                <th style="width: 80px">íƒœê·¸</th>
                <th>ì„¤ëª…</th>
                <th style="width: 200px">ì˜ˆì‹œ</th>
              </tr>
              <tr>
                <td><span class="pos-tag">MAG</span></td>
                <td>ì¼ë°˜ ë¶€ì‚¬</td>
                <td class="pos-example">ë§¤ìš°, ì•„ì£¼, ì˜</td>
              </tr>
              <tr>
                <td><span class="pos-tag">MM</span></td>
                <td>ê´€í˜•ì‚¬ (ëª…ì‚¬ë¥¼ ê¾¸ë©°ì£¼ëŠ” ë§)</td>
                <td class="pos-example">í•œ(í•œ ëª…), ìƒˆ, í—Œ, ëª¨ë“ , ì–´ë–¤</td>
              </tr>
              <tr>
                <td><span class="pos-tag">SN</span></td>
                <td>ìˆ«ì</td>
                <td class="pos-example">1, 2, 100</td>
              </tr>
              <tr>
                <td><span class="pos-tag">SL</span></td>
                <td>ì™¸êµ­ì–´</td>
                <td class="pos-example">AI, computer</td>
              </tr>
              <tr>
                <td><span class="pos-tag">SF</span></td>
                <td>íŠ¹ìˆ˜ë¬¸ì/êµ¬ë‘ì </td>
                <td class="pos-example">., !, ?, ~</td>
              </tr>
              <tr>
                <td><span class="pos-tag">XPN</span></td>
                <td>ì ‘ë‘ì‚¬</td>
                <td class="pos-example">ì‹ -, ì¬-, ì´ˆ-</td>
              </tr>
              <tr>
                <td><span class="pos-tag">XSN</span></td>
                <td>ëª…ì‚¬ íŒŒìƒ ì ‘ë¯¸ì‚¬</td>
                <td class="pos-example">-ì , -ì„±, -í™”</td>
              </tr>
            </table>
          </div>

          <div
            style="
              margin-top: 20px;
              padding: 15px;
              background: #f0e6f6;
              border-radius: 8px;
              border-left: 4px solid #9b59b6;
            "
          >
            <strong>ğŸ’¡ TIP:</strong> í˜•íƒœì†Œ ë¶„ì„ì—ì„œëŠ” ì£¼ë¡œ
            <span class="pos-tag">NNG</span>,
            <span class="pos-tag">NNP</span> ë“±ì˜ ëª…ì‚¬ íƒœê·¸ë¥¼ ê°€ì§„ ë‹¨ì–´ë“¤ì´
            í…ìŠ¤íŠ¸ ë¶„ì„ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
          </div>

          <div
            style="
              margin-top: 15px;
              padding: 15px;
              background: #fff3cd;
              border-radius: 8px;
              border-left: 4px solid #f39c12;
            "
          >
            <strong>ğŸ” í—·ê°ˆë¦¬ê¸° ì‰¬ìš´ êµ¬ë¶„:</strong><br /><br />
            <strong>â€¢ ìˆ˜ì‚¬(NR) vs ê´€í˜•ì‚¬(MM)</strong><br />
            - <span class="pos-tag">NR</span> ìˆ˜ì‚¬:
            <strong>ë‹¨ë…ìœ¼ë¡œ</strong> ì“°ì´ëŠ” ìˆ˜ (í•˜ë‚˜, ë‘˜, ì…‹, ì²«ì§¸, ë‘˜ì§¸...)<br />
            &nbsp;&nbsp;&nbsp;ì˜ˆ: "í•˜ë‚˜<strong>ë§Œ</strong> ì£¼ì„¸ìš”", "ì²«ì§¸<strong
              >ëŠ”</strong
            >
            í•™ìƒì´ë‹¤"<br />
            - <span class="pos-tag">MM</span> ê´€í˜•ì‚¬: ë’¤ì˜
            <strong>ëª…ì‚¬ë¥¼ ê¾¸ë©°ì£¼ëŠ”</strong> ìˆ˜ (í•œ, ë‘, ì„¸...)<br />
            &nbsp;&nbsp;&nbsp;ì˜ˆ: "<strong>í•œ</strong> ëª…", "<strong>ë‘</strong>
            ê°œ", "<strong>ì„¸</strong> ë§ˆë¦¬"
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        push,
        update,
        onChildAdded,
        onChildChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAxTrULE0XqTOoAAsx2gNbKqUd0Cp5doaI",
        authDomain: "tf-idf-800b1.firebaseapp.com",
        databaseURL:
          "https://tf-idf-800b1-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tf-idf-800b1",
        storageBucket: "tf-idf-800b1.firebasestorage.app",
        messagingSenderId: "838191913536",
        appId: "1:838191913536:web:93eafce39d2dc8d5ce5da5",
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      window.firebaseDB = database;
      window.firebaseRef = ref;
      window.firebaseSet = set;
      window.firebaseUpdate = update;
      window.firebaseOnValue = onValue;
      window.firebaseOnChildAdded = onChildAdded;
      window.firebaseOnChildChanged = onChildChanged;
      window.firebasePush = push;

      // Firebase ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œìƒ
      window.firebaseReady = true;
      window.dispatchEvent(new Event("firebaseReady"));
      console.log("âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ");
    </script>

    <script>
      // ==========================================
      // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ì¤‘ë³µ ì œê±°)
      // ==========================================
      let currentRole = null;
      let currentRoom = null;
      let currentNickname = null;
      let allSentences = [];
      let currentMorphemes = []; // í˜„ì¬ í˜•íƒœì†Œ ë¶„ì„ ê²°ê³¼
      let markedMorphemes = []; // í•©ì¹˜ê¸° ìœ„í•´ ì„ íƒëœ í˜•íƒœì†Œë“¤ {sentenceIndex, morphemeIndex}

      // í•œêµ­ì–´ ì¡°ì‚¬ ëª©ë¡ (ê°•í™”íŒ)
      const PARTICLES = [
        // ê²©ì¡°ì‚¬ (ì£¼ê²©, ëª©ì ê²©, ì„œìˆ ê²© ë“±)
        "ì€",
        "ëŠ”",
        "ì´",
        "ê°€",
        "ì„",
        "ë¥¼",
        "ì˜",
        "ì—",
        "ì—ì„œ",
        "ìœ¼ë¡œ",
        "ë¡œ",
        "ì—ê²Œ",
        "í•œí…Œ",
        "ê»˜",
        "ì—ê²Œì„œ",
        "í•œí…Œì„œ",
        "ê»˜ì„œ",
        "ì—ì„œë¶€í„°",
        "ë¡œë¶€í„°",
        "ìœ¼ë¡œë¶€í„°",
        "ê»˜ì„œ",
        "ì—ê²Œì„œ",
        "í•œí…Œì„œ",
        "ë¡œë¶€í„°",
        "ë¶€í„°",
        // ë³´ì¡°ì‚¬
        "ë„",
        "ë§Œ",
        "ê¹Œì§€",
        "ë§ˆì €",
        "ì¡°ì°¨",
        "ë°–ì—",
        "ë¿",
        "ì´ë‚˜",
        "ë‚˜",
        "ë¼ë„",
        "ì´ë¼ë„",
        "ì»¤ë…•",
        "ì€ì»¤ë…•",
        "ë“ ì§€",
        "ì´ë“ ì§€",
        "ì•¼",
        "ì´ì•¼",
        "ë¼ì•¼",
        "ì´ë¼ì•¼",
        // ì ‘ì†ì¡°ì‚¬
        "ì™€",
        "ê³¼",
        "í•˜ê³ ",
        "ì´ë‘",
        "ë‘",
        // ë¹„êµ/ì–‘íƒœ ì¡°ì‚¬
        "ë³´ë‹¤",
        "ì²˜ëŸ¼",
        "ê°™ì´",
        "ë§Œí¼",
        "ì¹˜ëŸ¼",
        "ëŒ€ë¡œ",
        "ë”°ë¼",
      ];

      // í•œêµ­ì–´ ì–´ë¯¸ ëª©ë¡
      const ENDINGS = [
        // ì¢…ê²°ì–´ë¯¸
        "ë‹¤",
        "ë‹ˆ",
        "ìš”",
        "ì£ ",
        "ì§€ìš”",
        "ë„¤",
        "êµ¬ë‚˜",
        "êµ¬ë¨¼",
        "ë…¸ë¼",
        "ì„¸",
        "ã…‚ë‹ˆë‹¤",
        "ìŠµë‹ˆë‹¤",
        "ì–´ìš”",
        "ì•„ìš”",
        "ì—¬ìš”",
        // ê³¼ê±°í˜•
        "ì—ˆë‹¤",
        "ì•˜ë‹¤",
        "ì˜€ë‹¤",
        "ì—ˆì–´ìš”",
        "ì•˜ì–´ìš”",
        "ì˜€ì–´ìš”",
        "ì—ˆìŠµë‹ˆë‹¤",
        "ì•˜ìŠµë‹ˆë‹¤",
        // ë¯¸ë˜/ì¶”ì¸¡
        "ê² ë‹¤",
        "ê² ì–´ìš”",
        "ê² ìŠµë‹ˆë‹¤",
        "ë¦¬ë¼",
        "ìœ¼ë¦¬ë¼",
        // í˜„ì¬í˜•
        "ëŠ”ë‹¤",
        "ã„´ë‹¤",
        "ëŠ”ê°€",
        "ë‚˜",
        "ëŠëƒ",
        "ìœ¼ëƒ",
        // ì—°ê²°ì–´ë¯¸
        "ê³ ",
        "ë©°",
        "ë©´ì„œ",
        "ì–´ì„œ",
        "ì•„ì„œ",
        "ì—¬ì„œ",
        "ë©´",
        "ìœ¼ë©´",
        "ì§€ë§Œ",
        "ëŠ”ë°",
        "ì€ë°",
        "ë‹ˆê¹Œ",
        "ìœ¼ë‹ˆê¹Œ",
        "ì–´ë„",
        "ì•„ë„",
        "ì—¬ë„",
        "ê±°ë‚˜",
        "ë“ ì§€",
        // ê´€í˜•í˜•ì–´ë¯¸
        "ëŠ”",
        "ã„´",
        "ì€",
        "ë˜",
        "ì„",
        "ã„¹",
        // ëª…ì‚¬í˜•ì–´ë¯¸
        "ê¸°",
        "ìŒ",
        "ã…",
        // ì¶”ê°€ ì¢…ê²°ì–´ë¯¸
        "ã„´ê°€",
        "ë‚˜ìš”",
        "êµ°ìš”",
        "ëŠ”êµ°ìš”",
        "ë„¤ìš”",
        "ëŠ”ê±¸",
        "ã„´ê±¸",
        "ì€ê±¸",
        "ã„¹ê±¸",
        "ì„ê±¸",
        // ì¶”ê°€ ì—°ê²°ì–´ë¯¸
        "ìœ¼ë©°",
        "ë©´ì„œë„",
        "ì§€",
        "ê²Œ",
        "ë„ë¡",
        "ë¡",
        "ì",
        "ìë§ˆì",
        "ã„¹ìˆ˜ë¡",
        "ì„ìˆ˜ë¡",
        "ëŠë¼",
        "ëŠë¼ê³ ",
        "ë‹¤ê°€",
        "ë‹¤ê°€ëŠ”",
        "ë ¤ê³ ",
        "ìœ¼ë ¤ê³ ",
        "ë ¤ë©´",
        "ìœ¼ë ¤ë©´",
        // ì¶”ê°€ ê³¼ê±°í˜•
        "ì—ˆë„¤",
        "ì•˜ë„¤",
        "ì˜€ë„¤",
        "ì—ˆêµ°",
        "ì•˜êµ°",
        "ì˜€êµ°",
        "ì—ˆì§€",
        "ì•˜ì§€",
        "ì˜€ì§€",
        // ì¶”ê°€ ë¯¸ë˜í˜•
        "ê² ë„¤",
        "ê² êµ°",
        "ê² ì§€",
        "ã„¹ê²ƒì´ë‹¤",
        "ì„ê²ƒì´ë‹¤",
        // ì¶”ê°€ ê´€í˜•í˜•
        "ã„¹",
        "ì„",
        "ë˜",
        "ì˜€ë˜",
        "ì•˜ë˜",
        "ì—ˆë˜",
      ];

      // ë³µí•©ëª…ì‚¬ ì‚¬ì „ (ë¶„ë¦¬í•˜ì§€ ì•Šì„ ë‹¨ì–´ë“¤)
      const COMPOUND_NOUNS = new Set([
        // ê¸°ìˆ /AI/ê³¼í•™
        "ì¸ê³µì§€ëŠ¥",
        "ë”¥ëŸ¬ë‹",
        "ë¨¸ì‹ ëŸ¬ë‹",
        "ìì—°ì–´ì²˜ë¦¬",
        "ì»´í“¨í„°ë¹„ì „",
        "ë°ì´í„°ê³¼í•™",
        "ë¹…ë°ì´í„°",
        "ë¸”ë¡ì²´ì¸",
        "ì‚¬ë¬¼ì¸í„°ë„·",
        "í´ë¼ìš°ë“œ",
        "ê°€ìƒí˜„ì‹¤",
        "ì¦ê°•í˜„ì‹¤",
        "ë¡œë´‡ê³µí•™",
        "ì–‘ìì»´í“¨íŒ…",
        "ë‚˜ë…¸ê¸°ìˆ ",
        "ìƒëª…ê³µí•™",
        "ìš°ì£¼ê³¼í•™",
        "ì‹ ì¬ìƒì—ë„ˆì§€",

        // êµìœ¡/í•™ìŠµ
        "ìˆ˜í•™ë¬¸ì œ",
        "ì˜ì–´ë‹¨ì–´",
        "ê³¼í•™ì‹¤í—˜",
        "ì—­ì‚¬ê³µë¶€",
        "êµ­ì–´ì‹œí—˜",
        "ìˆ˜ëŠ¥ì‹œí—˜",
        "ì¤‘ê°„ê³ ì‚¬",
        "ê¸°ë§ê³ ì‚¬",
        "ëª¨ì˜ê³ ì‚¬",
        "í•™ìŠµì§€",
        "êµê³¼ì„œ",
        "ì°¸ê³ ì„œ",

        // IT/ë””ì§€í„¸
        "ìŠ¤ë§ˆíŠ¸í°",
        "ë…¸íŠ¸ë¶",
        "íƒœë¸”ë¦¿",
        "ë°ìŠ¤í¬í†±",
        "ì›¹ì‚¬ì´íŠ¸",
        "ì• í”Œë¦¬ì¼€ì´ì…˜",
        "ì†Œì…œë¯¸ë””ì–´",
        "ìœ íŠœë¸Œ",
        "ì¸ìŠ¤íƒ€ê·¸ë¨",
        "í˜ì´ìŠ¤ë¶",
        "ì¹´ì¹´ì˜¤í†¡",
        "ë„¤ì´ë²„",

        // ê²½ì œ/ì‚¬íšŒ
        "ê²½ì œì„±ì¥",
        "êµ­ë‚´ì´ìƒì‚°",
        "ì†Œë¹„ìë¬¼ê°€",
        "ì‹¤ì—…ë¥ ",
        "ê¸ˆë¦¬ì¸ìƒ",
        "í™˜ìœ¨ë³€ë™",
        "ì£¼ì‹ì‹œì¥",
        "ë¶€ë™ì‚°ì‹œì¥",
        "ê¸°í›„ë³€í™”",
        "ì§€êµ¬ì˜¨ë‚œí™”",
        "íƒ„ì†Œì¤‘ë¦½",
        "ì‹ ì¬ìƒ",

        // ì •ì¹˜/ì™¸êµ
        "êµ­íšŒì˜ì›",
        "ëŒ€í†µë ¹",
        "êµ­ë¬´ì´ë¦¬",
        "ì™¸êµë¶€",
        "í†µì¼ë¶€",
        "êµ­ë°©ë¶€",
        "ë‚¨ë¶ê´€ê³„",
        "í•œë¯¸ë™ë§¹",
        "êµ­ì œì‚¬íšŒ",
        "ìœ ì—”ì•ˆë³´ë¦¬",
        "ë¶í•µë¬¸ì œ",

        // ì¼ìƒ/ìƒí™œ
        "ì‚¼ê²¹ì‚´",
        "ê¹€ì¹˜ì°Œê°œ",
        "ëœì¥ì°Œê°œ",
        "ë–¡ë³¶ì´",
        "ì¹˜í‚¨",
        "í”¼ì",
        "í¸ì˜ì ",
        "ëŒ€í˜•ë§ˆíŠ¸",
        "ë°±í™”ì ",
        "ì˜í™”ê´€",
        "ë†€ì´ê³µì›",
        "ë™ë¬¼ì›",

        // ì˜ë£Œ/ê±´ê°•
        "ê±´ê°•ë³´í—˜",
        "ì˜ë£Œë³´í—˜",
        "êµ­ë¯¼ê±´ê°•",
        "ì „ì—¼ë³‘",
        "ì½”ë¡œë‚˜ë°”ì´ëŸ¬ìŠ¤",
        "ë°±ì‹ ì ‘ì¢…",
        "ë³‘ì›ì§„ë£Œ",
        "ì‘ê¸‰ì‹¤",
        "ê±´ê°•ê²€ì§„",
        "ì •ì‹ ê±´ê°•",
        "ê³ í˜ˆì••",
        "ë‹¹ë‡¨ë³‘",

        // í…ìŠ¤íŠ¸ë§ˆì´ë‹/ë¶„ì„ ê´€ë ¨
        "í…ìŠ¤íŠ¸ë§ˆì´ë‹",
        "ë°ì´í„°ë¶„ì„",
        "í˜•íƒœì†Œë¶„ì„",
        "ê°ì„±ë¶„ì„",
        "ì›Œë“œí´ë¼ìš°ë“œ",
        "ë¹ˆë„ë¶„ì„",
        "í†µê³„ë¶„ì„",
        "ìì—°ì–´",
        "í’ˆì‚¬íƒœê¹…",
        "ê°œì²´ëª…ì¸ì‹",
        "í‚¤ì›Œë“œì¶”ì¶œ",
        "ë¬¸ì„œë¶„ë¥˜",
        "í† í”½ëª¨ë¸ë§",
        "ì½”ì‚¬ì¸ìœ ì‚¬ë„",
        "ë²¡í„°í™”",

        // ì¶”ê°€ IT ìš©ì–´
        "í”„ë¡œê·¸ë˜ë°",
        "ì•Œê³ ë¦¬ì¦˜",
        "ë°ì´í„°ë² ì´ìŠ¤",
        "ì„œë²„ê´€ë¦¬",
        "í´ë¼ìš°ë“œì»´í“¨íŒ…",
        "ì‚¬ì´ë²„ë³´ì•ˆ",
        "ì •ë³´ë³´ì•ˆ",
        "ë„¤íŠ¸ì›Œí¬",
        "ìš´ì˜ì²´ì œ",
        "ì†Œí”„íŠ¸ì›¨ì–´",
        "í•˜ë“œì›¨ì–´",
        "í”„ë¡ íŠ¸ì—”ë“œ",
        "ë°±ì—”ë“œ",
        "í’€ìŠ¤íƒ",
        "ë°ë¸Œì˜µìŠ¤",
        "ì• ìì¼",

        // ì¶”ê°€ ì¼ìƒ ìš©ì–´
        "ëŒ€í•™ìƒ",
        "ê³ ë“±í•™ìƒ",
        "ì¤‘í•™ìƒ",
        "ì´ˆë“±í•™ìƒ",
        "ì§ì¥ì¸",
        "ìì˜ì—…ì",
        "í”„ë¦¬ëœì„œ",
        "ì•„ë¥´ë°”ì´íŠ¸",
        "ì •ê·œì§",
        "ë¹„ì •ê·œì§",
        "ì¬íƒê·¼ë¬´",
        "í™”ìƒíšŒì˜",
        "ì˜¨ë¼ì¸ìˆ˜ì—…",
        "ì›ê²©ìˆ˜ì—…",

        // ë³µí•© ë™ì‚¬/í˜•ìš©ì‚¬ ëª…ì‚¬í™”
        "í• ìˆ˜ìˆë‹¤",
        "í• ìˆ˜ì—†ë‹¤",
        "í•˜ê³ ì‹¶ë‹¤",
        "ì¢‹ì•„í•˜ë‹¤",
        "ì‹«ì–´í•˜ë‹¤",
        "ê´€ì‹¬ìˆë‹¤",
        "ì¤‘ìš”í•˜ë‹¤",
        "í•„ìš”í•˜ë‹¤",
        "ê°€ëŠ¥í•˜ë‹¤",
        "ë¶ˆê°€ëŠ¥í•˜ë‹¤",
      ]);

      // ë¶„ë¦¬í•˜ë©´ ì•ˆ ë˜ëŠ” íŒ¨í„´ (í˜•ìš©ì‚¬, ë™ì‚¬ ë“±)
      const DONT_SPLIT = new Set([
        // í˜•ìš©ì‚¬ (ë†’ì€, ë‚®ì€...)
        "ë†’ì€",
        "ë‚®ì€",
        "ê°™ì€",
        "ë‹¤ë¥¸",
        "ì‘ì€",
        "í°",
        "ì¢‹ì€",
        "ë‚˜ìœ",
        "ë§ì€",
        "ì ì€",
        "ë¹ ë¥¸",
        "ëŠë¦°",
        "ìƒˆë¡œìš´",
        "ì˜¤ë˜ëœ",
        "ì–´ë¦°",
        "ì Šì€",
        "ì•„ë¦„ë‹¤ìš´",
        "ëª»ìƒê¸´",
        "ì˜ˆìœ",
        "ê·€ì—¬ìš´",
        "ë¬´ì„œìš´",
        "ìŠ¬í”ˆ",
        "ê¸°ìœ",

        // ë™ì‚¬ (í•˜ëŠ”, ë˜ëŠ”...)
        "í•˜ëŠ”",
        "ë˜ëŠ”",
        "ê°€ëŠ”",
        "ì˜¤ëŠ”",
        "ë³´ëŠ”",
        "ë“£ëŠ”",
        "ë¨¹ëŠ”",
        "ë§ˆì‹œëŠ”",
        "ì½ëŠ”",
        "ì“°ëŠ”",
        "ë§í•˜ëŠ”",
        "ê±·ëŠ”",
        "ë›°ëŠ”",
        "ìëŠ”",
        "ì¼ì–´ë‚˜ëŠ”",

        // ë¶€ì‚¬
        "ë§¤ìš°",
        "ì•„ì£¼",
        "ì •ë§",
        "ì§„ì§œ",
        "ë„ˆë¬´",
        "ì¡°ê¸ˆ",
        "ë§ì´",
        "ë¹¨ë¦¬",
        "ì²œì²œíˆ",
        "ê°‘ìê¸°",
        "í•­ìƒ",
        "ê°€ë”",
        "ìì£¼",
        "ì ˆëŒ€",
        "ê²°ì½”",
        "ì „í˜€",
        "ê±°ì˜",
        "ì´ë¯¸",
        "ë²Œì¨",
        "ì•„ì§",
        "ê³§",
        "ë‹¤ì‹œ",
        "ë˜",
        "í•¨ê»˜",
        "ê°™ì´",
        "í˜¼ì",
        "ëª¨ë‘",
        "ë‹¤",

        // ì¶”ê°€ í˜•ìš©ì‚¬
        "ê°•í•œ",
        "ì•½í•œ",
        "ê¸´",
        "ì§§ì€",
        "ë„“ì€",
        "ì¢ì€",
        "ê¹Šì€",
        "ì–•ì€",
        "ë¬´ê±°ìš´",
        "ê°€ë²¼ìš´",
        "ë°ì€",
        "ì–´ë‘ìš´",
        "ëœ¨ê±°ìš´",
        "ì°¨ê°€ìš´",
        "ë”°ëœ»í•œ",
        "ì‹œì›í•œ",
        "ë§›ìˆëŠ”",
        "ë§›ì—†ëŠ”",
        "ë‹¬ì½¤í•œ",
        "ì“´",
        "ë§¤ìš´",
        "ì‹ ",
        "ê±´ê°•í•œ",
        "ì•„í”ˆ",

        // ì¶”ê°€ ë™ì‚¬ (ê´€í˜•í˜•)
        "ë§Œë“œëŠ”",
        "ì‚¬ìš©í•˜ëŠ”",
        "ë°°ìš°ëŠ”",
        "ê°€ë¥´ì¹˜ëŠ”",
        "ì—°êµ¬í•˜ëŠ”",
        "ê°œë°œí•˜ëŠ”",
        "ë¶„ì„í•˜ëŠ”",
        "ìƒê°í•˜ëŠ”",
        "ëŠë¼ëŠ”",
        "ì•Œê³ ìˆëŠ”",
        "ëª¨ë¥´ëŠ”",
        "ì›í•˜ëŠ”",
        "ë°”ë¼ëŠ”",
        "ê¸°ëŒ€í•˜ëŠ”",
        "ë¯¿ëŠ”",
        "ì˜ì‹¬í•˜ëŠ”",

        // ì§€ì‹œì–´/ëŒ€ëª…ì‚¬
        "ì´ê²ƒ",
        "ê·¸ê²ƒ",
        "ì €ê²ƒ",
        "ì—¬ê¸°",
        "ê±°ê¸°",
        "ì €ê¸°",
        "ì´ê³³",
        "ê·¸ê³³",
        "ì €ê³³",
        "ì–´ë””",
        "ì–¸ì œ",
        "ëˆ„êµ¬",
        "ë¬´ì—‡",
        "ì–´ë–»ê²Œ",
        "ì™œ",
        "ì–´ëŠ",
        "ì–´ë–¤",
        "ì´ëŸ°",
        "ê·¸ëŸ°",
        "ì €ëŸ°",
      ]);

      // 10,000ê°œ ëª…ì‚¬ ì‚¬ì „ (ë™ì  ë¡œë“œ)
      let NOUN_DICTIONARY = new Set();
      let dictionaryLoaded = false;

      let selectedSentences = []; // ë¶„ì„ì— ì‚¬ìš©í•  ì„ íƒëœ ë¬¸ì¥ë“¤
      // wordFrequencyëŠ” window.wordFrequency ì‚¬ìš©
      let selectedWords = [];
      let currentWordCloudInstance = null;
      let wordCloudSettings = {
        shape: "circle",
        font: "Do Hyeon",
        gridSize: 8, // ë” í° gridSizeë¡œ ë°°ì¹˜ ì•ˆì •í™”
        rotateRatio: 0,
      };

      // ==========================================
      // ëª…ì‚¬ ì‚¬ì „ ë¡œë“œ (í™•ì¥íŒ)
      // ==========================================
      async function loadNounDictionary() {
        if (dictionaryLoaded) return;

        console.log("ğŸ“š ëª…ì‚¬ ì‚¬ì „ ë¡œë“œ ì¤‘...");

        // 1. ë¨¼ì € í™•ì¥ ëª…ì‚¬ ì‚¬ì „(ëª…ì‚¬ì‚¬ì „.js)ì„ NOUN_DICTIONARYì— ì¶”ê°€
        if (typeof EXTENDED_NOUN_DICTIONARY !== "undefined") {
          NOUN_DICTIONARY = new Set(EXTENDED_NOUN_DICTIONARY);
          console.log(
            `âœ… í™•ì¥ ëª…ì‚¬ì‚¬ì „ ë¡œë“œ: ${NOUN_DICTIONARY.size.toLocaleString()}ê°œ ë‹¨ì–´`,
          );
        }

        // 2. nouns-10k.json íŒŒì¼ì´ ìˆìœ¼ë©´ ì¶”ê°€ë¡œ ë³‘í•©
        try {
          const response = await fetch("nouns-10k.json");

          if (response.ok) {
            const data = await response.json();
            const originalSize = NOUN_DICTIONARY.size;

            // ê¸°ì¡´ ì‚¬ì „ê³¼ ë³‘í•©
            data.words.forEach((word) => NOUN_DICTIONARY.add(word));

            const addedCount = NOUN_DICTIONARY.size - originalSize;
            console.log(
              `âœ… nouns-10k.json ë³‘í•© ì™„ë£Œ: ${addedCount.toLocaleString()}ê°œ ë‹¨ì–´ ì¶”ê°€`,
            );
          }
        } catch (error) {
          console.log("â„¹ï¸ nouns-10k.json íŒŒì¼ ì—†ìŒ (í™•ì¥ ì‚¬ì „ë§Œ ì‚¬ìš©)");
        }

        dictionaryLoaded = true;
        console.log(
          `ğŸ¯ ìµœì¢… ëª…ì‚¬ ì‚¬ì „ í¬ê¸°: ${NOUN_DICTIONARY.size.toLocaleString()}ê°œ ë‹¨ì–´`,
        );
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª…ì‚¬ ì‚¬ì „ ë¡œë“œ
      loadNounDictionary();

      // ==========================================
      // í™ˆìœ¼ë¡œ ì´ë™ í•¨ìˆ˜
      // ==========================================
      function goHome() {
        if (
          confirm(
            "í™ˆìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì§„í–‰ ìƒí™©ì´ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
          )
        ) {
          // URL íŒŒë¼ë¯¸í„° ì œê±°í•˜ê³  ìƒˆë¡œê³ ì¹¨
          window.location.href = window.location.pathname;
        }
      }

      // ==========================================
      // í•œê¸€ ë¶ˆìš©ì–´ ë¦¬ìŠ¤íŠ¸ (ê°•í™”ë¨)
      // ==========================================
      const koreanStopwords = new Set([
        "ì€",
        "ëŠ”",
        "ì´",
        "ê°€",
        "ì„",
        "ë¥¼",
        "ì˜",
        "ë„",
        "ë§Œ",
        "ê¹Œì§€",
        "ë¶€í„°",
        "ë§ˆì €",
        "ì¡°ì°¨",
        "ì—",
        "ì—ì„œ",
        "ì—ê²Œ",
        "ê»˜",
        "í•œí…Œ",
        "ë³´ê³ ",
        "ì™€",
        "ê³¼",
        "í•˜ê³ ",
        "ë‘",
        "ì´ë‘",
        "ìœ¼ë¡œ",
        "ë¡œ",
        "ì²˜ëŸ¼",
        "ê°™ì´",
        "ë§ˆëƒ¥",
        "ë³´ë‹¤",
        "ë§Œí¼",
        "ë°–ì—",
        "ë¿",
        "ë¿ë§Œ",
        "ë‹¤",
        "ìš”",
        "ì–´ìš”",
        "ì•„ìš”",
        "í•´ìš”",
        "ë„¤ìš”",
        "êµ°ìš”",
        "êµ¬ë‚˜",
        "êµ¬ë¨¼",
        "ìŠµë‹ˆë‹¤",
        "ã…‚ë‹ˆë‹¤",
        "ì—ˆìŠµë‹ˆë‹¤",
        "ì•˜ìŠµë‹ˆë‹¤",
        "ì˜€ìŠµë‹ˆë‹¤",
        "ì–´ì„œ",
        "ì•„ì„œ",
        "ì—¬ì„œ",
        "í•´ì„œ",
        "ê³ ",
        "ì§€ë§Œ",
        "ëŠ”ë°",
        "ã„´ë°",
        "ê·¸",
        "ì €",
        "ì´ê²ƒ",
        "ê·¸ê²ƒ",
        "ì €ê²ƒ",
        "ì—¬ê¸°",
        "ê±°ê¸°",
        "ì €ê¸°",
        "ì´ê±°",
        "ê·¸ê±°",
        "ì €ê±°",
        "ë¬´ì—‡",
        "ëˆ„êµ¬",
        "ì–¸ì œ",
        "ì–´ë””",
        "ì–´ë–»ê²Œ",
        "ì™œ",
        "ê°œ",
        "ëª…",
        "ë¶„",
        "ì´ˆ",
        "ì‹œê°„",
        "ì¼",
        "ì£¼",
        "ë‹¬",
        "ë…„",
        "ë²ˆ",
        "íšŒ",
        "ì°¨",
        "ì¸µ",
        "ì¹¸",
        "ê¶Œ",
        "ì¥",
        "ìª½",
        "ê·¸ë¦¬ê³ ",
        "ê·¸ëŸ¬ë‚˜",
        "í•˜ì§€ë§Œ",
        "ê·¸ë˜ì„œ",
        "ë”°ë¼ì„œ",
        "ì¦‰",
        "ë˜í•œ",
        "ê²ƒ",
        "ê±°",
        "ìˆ˜",
        "ë“±",
        "ë•Œ",
        "ì¤‘",
        "ì ",
        "ì",
        "ë‹˜",
        "ì”¨",
        "í•˜ë‹¤",
        "ìˆë‹¤",
        "ì—†ë‹¤",
        "ë˜ë‹¤",
        "ì´ë‹¤",
        "ì•„ë‹ˆë‹¤",
        "ê³„ì‹œë‹¤",
        "ì£¼ë‹¤",
        "ë“œë¦¬ë‹¤",
      ]);

      // ==========================================
      // ê³ ê¸‰ ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ (ë” ì§„í•˜ê³  ëšœë ·í•œ ìƒ‰ìƒ)
      // ==========================================
      const advancedColors = [
        "#1e3a5f",
        "#2d5a87",
        "#3d7ab0",
        "#c9a227",
        "#d4b84a",
        "#5a8f7b",
        "#4a7c6b",
        "#3a695b",
        "#8b5a5a",
        "#a06a6a",
        "#4a6fa5",
        "#5c82b8",
        "#6e95cb",
        "#b8860b",
        "#daa520",
        "#2f4f4f",
        "#4682b4",
        "#5f9ea0",
        "#708090",
        "#778899",
      ];

      // ==========================================
      // í•œêµ­ì–´ í˜•íƒœì†Œ ë¶„ì„ í•¨ìˆ˜ (khaiii ê¸°ë°˜)
      // ==========================================

      // í•œêµ­ì–´ ì¡°ì‚¬ ë¦¬ìŠ¤íŠ¸
      const koreanParticles = [
        // ì£¼ê²© ì¡°ì‚¬
        "ì´",
        "ê°€",
        "ê»˜ì„œ",
        // ëª©ì ê²© ì¡°ì‚¬
        "ì„",
        "ë¥¼",
        // ê´€í˜•ê²© ì¡°ì‚¬
        "ì˜",
        // ë¶€ì‚¬ê²© ì¡°ì‚¬
        "ì—",
        "ì—ì„œ",
        "ì—ê²Œ",
        "í•œí…Œ",
        "ê»˜",
        "ìœ¼ë¡œ",
        "ë¡œ",
        "ì™€",
        "ê³¼",
        "í•˜ê³ ",
        "ë‘",
        "ì´ë‘",
        "ë³´ë‹¤",
        "ì²˜ëŸ¼",
        "ê°™ì´",
        "ë§Œí¼",
        "ê¹Œì§€",
        "ë¶€í„°",
        "ë§ˆì €",
        "ì¡°ì°¨",
        "ë°–ì—",
        // ë³´ì¡°ì‚¬
        "ì€",
        "ëŠ”",
        "ë„",
        "ë§Œ",
        "ë¿",
        "ë¼ë„",
        "ë§ˆëŠ”",
        // ì ‘ì† ì¡°ì‚¬
        "ì´ë©°",
        "ë©°",
        "ì´ê³ ",
        // í˜¸ê²© ì¡°ì‚¬
        "ì´ì—¬",
      ];

      // ì¡°ì‚¬ë¡œ ì˜¤ì¸ë˜ê¸° ì‰¬ìš´ ê¸€ìë¡œ ëë‚˜ëŠ” ê³ ìœ ëª…ì‚¬/ë‹¨ì–´ ë³´í˜¸ ë¦¬ìŠ¤íŠ¸
      const protectedWords = new Set([
        // êµ­ê°€ëª…
        "ëŸ¬ì‹œì•„",
        "ìš°í¬ë¼ì´ë‚˜",
        "ì¤‘êµ­",
        "ì¼ë³¸",
        "ë¯¸êµ­",
        "ì˜êµ­",
        "í”„ë‘ìŠ¤",
        "ë…ì¼",
        "ì´íƒˆë¦¬ì•„",
        "ìŠ¤í˜ì¸",
        "ìºë‚˜ë‹¤",
        "í˜¸ì£¼",
        "ì¸ë„",
        "ë¸Œë¼ì§ˆ",
        "ë©•ì‹œì½”",
        "ì•„ë¥´í—¨í‹°ë‚˜",
        "í„°í‚¤",
        "ì´ë€",
        "ì´ë¼í¬",
        "ì‹œë¦¬ì•„",
        "ì´ìŠ¤ë¼ì—˜",
        "ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„",
        "ë² íŠ¸ë‚¨",
        "íƒœêµ­",
        "ì¸ë„ë„¤ì‹œì•„",
        "ë§ë ˆì´ì‹œì•„",
        "í•„ë¦¬í•€",
        "ì‹±ê°€í¬ë¥´",
        "ëŒ€ë§Œ",
        "í™ì½©",
        "ëª½ê³¨",
        "ì¹´ìíìŠ¤íƒ„",
        "ìš°ì¦ˆë² í‚¤ìŠ¤íƒ„",
        "íŒŒí‚¤ìŠ¤íƒ„",
        "ì•„í”„ê°€ë‹ˆìŠ¤íƒ„",
        "ì´ì§‘íŠ¸",
        "ë‚¨ì•„í”„ë¦¬ì¹´",
        "ë‚˜ì´ì§€ë¦¬ì•„",
        "ì¼€ëƒ",
        "ì—í‹°ì˜¤í”¼ì•„",
        "í´ë€ë“œ",
        "ìš°í¬ë¼ì´",
        "í—ê°€ë¦¬",
        "ì²´ì½”",
        "ìŠ¬ë¡œë°”í‚¤ì•„",
        "ë£¨ë§ˆë‹ˆì•„",
        "ë¶ˆê°€ë¦¬ì•„",
        "ê·¸ë¦¬ìŠ¤",
        "ë…¸ë¥´ì›¨ì´",
        "ìŠ¤ì›¨ë´",
        "í•€ë€ë“œ",
        "ë´ë§ˆí¬",
        "ë„¤ëœë€ë“œ",
        "ë²¨ê¸°ì—",
        "ìŠ¤ìœ„ìŠ¤",
        "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„",
        "í¬ë¥´íˆ¬ê°ˆ",
        "ì•„ì¼ëœë“œ",
        "ë‰´ì§ˆëœë“œ",
        "ì½œë¡¬ë¹„ì•„",
        "ì¹ ë ˆ",
        "í˜ë£¨",
        "ë² ë„¤ìˆ˜ì—˜ë¼",
        "ì¿ ë°”",
        // ë„ì‹œëª…
        "ëª¨ìŠ¤í¬ë°”",
        "í‚¤ì´ìš°",
        "ë² ì´ì§•",
        "ìƒí•˜ì´",
        "ë„ì¿„",
        "ì˜¤ì‚¬ì¹´",
        "ì„œìš¸",
        "ë¶€ì‚°",
        "ì›Œì‹±í„´",
        "ë‰´ìš•",
        "ëŸ°ë˜",
        "íŒŒë¦¬",
        "ë² ë¥¼ë¦°",
        "ë¡œë§ˆ",
        "ë§ˆë“œë¦¬ë“œ",
        "ì‹œë“œë‹ˆ",
        "ë©œë²„ë¥¸",
        // ì¸ëª… (ì¼ë°˜ì ì¸ ì™¸ë˜ì–´ ì´ë¦„)
        "ì ¤ë ŒìŠ¤í‚¤",
        "í‘¸í‹´",
        "íŠ¸ëŸ¼í”„",
        "ë°”ì´ë“ ",
        "ì‹œì§„í•‘",
        "ê¸°ì‹œë‹¤",
        "ë§ˆí¬ë¡±",
        "ìˆ„ì¸ ",
        "ì˜¤ë°”ë§ˆ",
        "í´ë¦°í„´",
        "ë¶€ì‹œ",
        "ë ˆì´ê±´",
        "ì¼€ë„¤ë””",
        "ë§ì»¨",
        "ì›Œì‹±í„´",
        "ë‚˜í´ë ˆì˜¹",
        // ê¸°íƒ€ ê³ ìœ ëª…ì‚¬
        "ì•„ì‹œì•„",
        "ìœ ëŸ½",
        "ì•„í”„ë¦¬ì¹´",
        "ì•„ë©”ë¦¬ì¹´",
        "ì˜¤ì„¸ì•„ë‹ˆì•„",
        "ë‚¨ê·¹",
        "ë¶ê·¹",
        "ë‚˜í† ",
        "ìœ ì—”",
        "ì•„ì„¸ì•ˆ",
        "ì˜¤í˜ë¼",
        "í”¼ì•„ë…¸",
        "ê¸°íƒ€",
        "ë“œë¼ë§ˆ",
        "ì‹œë„¤ë§ˆ",
        // ì¡°ì‚¬ë¡œ ì˜¤ì¸ë˜ê¸° ì‰¬ìš´ ì¼ë°˜ ë‹¨ì–´
        "íšŒì‚¬",
        "í•™êµ",
        "ë³‘ì›",
        "ì •ë¶€",
        "êµ­íšŒ",
        "ë²•ì›",
        "ê²½ì°°",
        "êµ°ëŒ€",
        "ì–¸ë¡ ",
        "ë¯¸ë””ì–´",
        "ì—­ì‚¬",
        "ë¬¸í™”",
        "ê²½ì œ",
        "ì •ì¹˜",
        "ì‚¬íšŒ",
        "ê³¼í•™",
        "ê¸°ìˆ ",
        "ì˜ˆìˆ ",
        "ìŒì•…",
        "ì˜í™”",
        "ì†Œì„¤",
        "ì‹œ",
        "ìˆ˜í•™",
        "ë¬¼ë¦¬",
        "í™”í•™",
        "ìƒë¬¼",
        "ì§€ë¦¬",
        "ì² í•™",
        "ì‹¬ë¦¬",
        "êµìœ¡",
      ]);

      // ì¡°ì‚¬ë¥¼ ê¸¸ì´ ìˆœìœ¼ë¡œ ì •ë ¬ (ê¸´ ê²ƒë¶€í„° ë¨¼ì € ë§¤ì¹­)
      const sortedParticles = [...koreanParticles].sort(
        (a, b) => b.length - a.length,
      );

      // í˜•íƒœì†Œ ë¶„ì„ í•¨ìˆ˜
      function analyzeMorpheme(word) {
        if (word.length < 2) return { word: word, skip: true };
        if (koreanStopwords.has(word)) return { word: word, skip: true };

        // ì™¸ë˜ì–´/ì˜ì–´ëŠ” ê·¸ëŒ€ë¡œ ë°˜í™˜
        if (/^[a-zA-Z]+$/.test(word)) {
          return { word: word.toLowerCase(), skip: false };
        }

        // ìˆ«ìë§Œ ìˆìœ¼ë©´ ìŠ¤í‚µ
        if (/^\d+$/.test(word)) {
          return { word: word, skip: true };
        }

        // ë³´í˜¸ ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ì— ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
        if (protectedWords.has(word)) {
          return { word: word, skip: false };
        }

        // ì‚¬ì „ì— ìˆëŠ” ëª…ì‚¬ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
        if (
          typeof KoreanMorphDict !== "undefined" &&
          KoreanMorphDict.nouns.has(word)
        ) {
          return { word: word, skip: false };
        }

        let stem = word;
        let foundStem = false;

        // 1ì°¨: KoreanMorphDictì˜ particlesë¡œ ì‹œë„
        if (typeof KoreanMorphDict !== "undefined") {
          for (const particle of KoreanMorphDict.particles) {
            if (stem.endsWith(particle) && stem.length > particle.length + 1) {
              const candidate = stem.slice(0, -particle.length);
              if (candidate.length >= 2) {
                // í›„ë³´ ì–´ê·¼ì´ ë³´í˜¸ ë‹¨ì–´ë©´ ë°˜í™˜
                if (protectedWords.has(candidate)) {
                  return { word: candidate, skip: false };
                }
                if (KoreanMorphDict.nouns.has(candidate)) {
                  return { word: candidate, skip: false };
                }
                // 2ê¸€ì ì´ìƒ ì¡°ì‚¬ë©´ ì–´ê·¼ ì±„íƒ
                if (particle.length >= 2) {
                  stem = candidate;
                  foundStem = true;
                  break;
                }
              }
            }
          }
        }

        // 2ì°¨: í™•ì¥ëœ ì¡°ì‚¬ ë¦¬ìŠ¤íŠ¸ë¡œ ì–´ê·¼ ì¶”ì¶œ ì‹œë„
        if (!foundStem) {
          for (const particle of sortedParticles) {
            if (stem.endsWith(particle) && stem.length > particle.length + 1) {
              const candidate = stem.slice(0, -particle.length);
              if (candidate.length >= 2) {
                // í›„ë³´ ì–´ê·¼ì´ ë³´í˜¸ ë‹¨ì–´ë©´ ë°˜í™˜
                if (protectedWords.has(candidate)) {
                  return { word: candidate, skip: false };
                }
                // ì‚¬ì „ì— ìˆìœ¼ë©´ í™•ì‹¤íˆ ë°˜í™˜
                if (
                  typeof KoreanMorphDict !== "undefined" &&
                  KoreanMorphDict.nouns.has(candidate)
                ) {
                  return { word: candidate, skip: false };
                }
                // 2ê¸€ì ì´ìƒ ì¡°ì‚¬ë©´ ì–´ê·¼ ì±„íƒ (1ê¸€ì ì¡°ì‚¬ëŠ” ìœ„í—˜)
                if (particle.length >= 2) {
                  stem = candidate;
                  foundStem = true;
                  break;
                }
              }
            }
          }
        }

        // ì–´ê·¼ì´ ë¶ˆìš©ì–´ë©´ ìŠ¤í‚µ
        if (koreanStopwords.has(stem)) return { word: stem, skip: true };

        // ì–´ê·¼ì„ ì°¾ì•˜ìœ¼ë©´ ì–´ê·¼ ë°˜í™˜, ì•„ë‹ˆë©´ ì›ë³¸ ë°˜í™˜
        if (foundStem && stem.length >= 2) {
          return { word: stem, skip: false };
        }

        // ì›ë³¸ ë‹¨ì–´ ë°˜í™˜ (2ê¸€ì ì´ìƒ)
        if (word.length >= 2) return { word: word, skip: false };
        return { word: word, skip: true };
      }

      // ë©”ì¸ í† í°í™” í•¨ìˆ˜
      function tokenizeKorean(text) {
        text = text.replace(/[^\wã„±-ã…ã…-ã…£ê°€-í£\s]/g, " ");
        const words = text.split(/\s+/).filter((w) => w.length > 0);
        const result = [];

        for (const word of words) {
          const analyzed = analyzeMorpheme(word);
          if (!analyzed.skip) result.push(analyzed.word);
        }

        return result;
      }

      // ==========================================
      // Firebase ì—°ë™: ì—­í•  ì„ íƒ ë° ë°© ê´€ë¦¬
      // ==========================================
      function selectRole(role) {
        currentRole = role;
        document
          .getElementById("role-selection-screen")
          .classList.add("hidden");

        if (role === "teacher") {
          // Firebaseê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          if (window.firebaseReady) {
            createRoom();
          } else {
            window.addEventListener("firebaseReady", () => createRoom(), {
              once: true,
            });
          }
          document.getElementById("teacher-view").classList.remove("hidden");
        } else if (role === "student") {
          document.getElementById("student-view").classList.remove("hidden");
        } else if (role === "demo") {
          document.getElementById("demo-view").classList.remove("hidden");
        }
      }

      async function createRoom() {
        console.log("=== createRoom ì‹œì‘ ===");

        if (!window.firebaseReady) {
          console.error("âŒ Firebaseê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          alert("Firebase ì—°ê²° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          return;
        }

        console.log("âœ… Firebase ì¤€ë¹„ë¨");

        const roomCode = generateRoomCode();
        currentRoom = roomCode;
        console.log("ğŸ”‘ ë°© ì½”ë“œ ìƒì„±:", roomCode);

        document.getElementById("room-code-text").textContent = roomCode;

        const qrContainer = document.getElementById("qrcode");
        qrContainer.innerHTML = "";
        new QRCode(qrContainer, {
          text: window.location.href.split("?")[0] + "?room=" + roomCode,
          width: 200,
          height: 200,
        });

        const now = Date.now();
        const expiresAt = now + 2 * 60 * 60 * 1000; // 2ì‹œê°„ í›„

        const roomRef = window.firebaseRef(
          window.firebaseDB,
          `rooms/${roomCode}`,
        );

        const roomData = {
          createdAt: now,
          expiresAt: expiresAt,
          status: "open",
          topicImage: "",
          students: {},
        };

        console.log("ğŸ“ ë°© ë°ì´í„°:", roomData);
        console.log("ğŸŒ Firebase ê²½ë¡œ:", `rooms/${roomCode}`);

        try {
          await window.firebaseSet(roomRef, roomData);
          console.log("âœ… Firebase ë°© ìƒì„± ì„±ê³µ!");

          monitorStudents(roomCode);
          setupImageUpload(roomCode);
          scheduleRoomDeletion(roomCode, expiresAt);
          startRoomTimer(expiresAt);
        } catch (error) {
          console.error("âŒ Firebase ë°© ìƒì„± ì‹¤íŒ¨:", error);
          console.error("ì—ëŸ¬ ì½”ë“œ:", error.code);
          console.error("ì—ëŸ¬ ë©”ì‹œì§€:", error.message);
          alert(`ë°© ìƒì„± ì‹¤íŒ¨: ${error.message}\nì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.`);
        }
      }

      // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¤ì •
      function setupImageUpload(roomCode) {
        const imageInput = document.getElementById("topic-image-input");
        const removeBtn = document.getElementById("remove-image-btn");
        const uploadBox = document.getElementById("image-upload-box");
        const placeholder = document.getElementById("image-upload-placeholder");
        const preview = document.getElementById("topic-image-preview");

        // ë°•ìŠ¤ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ
        uploadBox.addEventListener("click", () => {
          imageInput.click();
        });

        imageInput.addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB ì œí•œ)
          if (file.size > 5 * 1024 * 1024) {
            alert("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
            return;
          }

          // ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ë³€í™˜
          const reader = new FileReader();
          reader.onload = async (event) => {
            const base64Image = event.target.result;

            // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• (ìµœëŒ€ 800px)
            const resizedImage = await resizeImage(base64Image, 800);

            // Firebaseì— ì €ì¥
            const roomRef = window.firebaseRef(
              window.firebaseDB,
              `rooms/${roomCode}/topicImage`,
            );
            await window.firebaseSet(roomRef, resizedImage);

            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (ë°•ìŠ¤ ì•ˆì—)
            placeholder.style.display = "none";
            preview.src = resizedImage;
            preview.style.display = "block";
            removeBtn.style.display = "inline-block";
          };
          reader.readAsDataURL(file);
        });

        removeBtn.addEventListener("click", async (e) => {
          e.stopPropagation(); // ë°•ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
          const roomRef = window.firebaseRef(
            window.firebaseDB,
            `rooms/${roomCode}/topicImage`,
          );
          await window.firebaseSet(roomRef, "");
          placeholder.style.display = "block";
          preview.style.display = "none";
          preview.src = "";
          removeBtn.style.display = "none";
          imageInput.value = "";
        });
      }

      // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§•
      function resizeImage(base64, maxSize) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            let width = img.width;
            let height = img.height;

            if (width > maxSize || height > maxSize) {
              if (width > height) {
                height = (height / width) * maxSize;
                width = maxSize;
              } else {
                width = (width / height) * maxSize;
                height = maxSize;
              }
            }

            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL("image/jpeg", 0.8));
          };
          img.src = base64;
        });
      }

      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ

      function generateRoomCode() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let code = "";
        for (let i = 0; i < 6; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
      }

      // ==========================================
      // ë°© ìë™ ì‚­ì œ ì˜ˆì•½ (2ì‹œê°„ í›„)
      // ==========================================
      function scheduleRoomDeletion(roomCode, expiresAt) {
        const now = Date.now();
        const timeUntilExpiry = expiresAt - now;

        if (timeUntilExpiry <= 0) {
          // ì´ë¯¸ ë§Œë£Œë¨
          deleteRoom(roomCode);
          return;
        }

        console.log(
          `â° ë°© ${roomCode}ëŠ” ${Math.floor(timeUntilExpiry / 1000 / 60)}ë¶„ í›„ ìë™ ì‚­ì œë©ë‹ˆë‹¤.`,
        );

        // 2ì‹œê°„ í›„ ìë™ ì‚­ì œ
        setTimeout(() => {
          deleteRoom(roomCode);
        }, timeUntilExpiry);
      }

      function deleteRoom(roomCode) {
        if (!window.firebaseReady) return;

        const roomRef = window.firebaseRef(
          window.firebaseDB,
          `rooms/${roomCode}`,
        );
        window.firebaseSet(roomRef, null); // ë°© ì‚­ì œ
        console.log(`ğŸ—‘ï¸ ë°© ${roomCode}ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. (2ì‹œê°„ ê²½ê³¼)`);
      }

      // ë§Œë£Œëœ ë°©ì¸ì§€ í™•ì¸
      function isRoomExpired(roomData) {
        if (!roomData.expiresAt) return false;
        return Date.now() > roomData.expiresAt;
      }

      // ë‚¨ì€ ì‹œê°„ í‘œì‹œ (ë¶„ ë‹¨ìœ„)
      function getRemainingTime(expiresAt) {
        const remaining = expiresAt - Date.now();
        if (remaining <= 0) return "ë§Œë£Œë¨";

        const hours = Math.floor(remaining / 1000 / 60 / 60);
        const minutes = Math.floor((remaining / 1000 / 60) % 60);

        if (hours > 0) {
          return `${hours}ì‹œê°„ ${minutes}ë¶„`;
        } else {
          return `${minutes}ë¶„`;
        }
      }

      // ë°© íƒ€ì´ë¨¸ ì‹œì‘ (UI ì—…ë°ì´íŠ¸)
      let roomTimerInterval = null;
      function startRoomTimer(expiresAt) {
        // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
        if (roomTimerInterval) {
          clearInterval(roomTimerInterval);
        }

        const updateTimer = () => {
          const remaining = getRemainingTime(expiresAt);
          const timeDisplay = document.getElementById("room-time-remaining");
          if (timeDisplay) {
            timeDisplay.textContent = remaining;

            // 30ë¶„ ì´í•˜ë©´ ë¹¨ê°„ìƒ‰ ê°•ì¡°
            const remainingMs = expiresAt - Date.now();
            if (remainingMs <= 30 * 60 * 1000 && remainingMs > 0) {
              timeDisplay.style.color = "#e74c3c";
              timeDisplay.style.fontWeight = "700";
            }

            // ë§Œë£Œë˜ë©´ íƒ€ì´ë¨¸ ì¤‘ì§€
            if (remaining === "ë§Œë£Œë¨") {
              clearInterval(roomTimerInterval);
              timeDisplay.textContent = "ë§Œë£Œë¨";
            }
          }
        };

        // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
        updateTimer();

        // 1ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸
        roomTimerInterval = setInterval(updateTimer, 60000);
      }

      function copyRoomCode() {
        navigator.clipboard.writeText(currentRoom);
        alert("ë°© ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: " + currentRoom);
      }

      function copyRoomURL() {
        const url = window.location.href.split("?")[0] + "?room=" + currentRoom;
        navigator.clipboard.writeText(url);
        alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
      }

      function monitorStudents(roomCode) {
        const studentsRef = window.firebaseRef(
          window.firebaseDB,
          `rooms/${roomCode}/students`,
        );

        window.firebaseOnChildAdded(studentsRef, (snapshot) => {
          const studentData = snapshot.val();
          addStudentCard(snapshot.key, studentData);
          updateParticipationStatus();
        });

        window.firebaseOnChildChanged(studentsRef, (snapshot) => {
          const studentData = snapshot.val();
          updateStudentCard(snapshot.key, studentData);
          updateParticipationStatus();
        });
      }

      function addStudentCard(studentId, data) {
        const grid = document.getElementById("students-grid");
        const card = document.createElement("div");
        card.className = "student-card";
        card.id = `student-${studentId}`;

        const sentence1 =
          data.sentences && data.sentences[0] ? data.sentences[0] : "";
        const isCompleted = sentence1 !== "";

        if (isCompleted) card.classList.add("completed");

        card.innerHTML = `
                <h4>${data.nickname || "ìµëª…"} ${isCompleted ? "âœ…" : "â³"}</h4>
                <div><strong>ë¬¸ì¥:</strong> ${sentence1 || "(ì‘ì„± ì¤‘...)"}</div>
            `;

        grid.appendChild(card);
      }

      function updateStudentCard(studentId, data) {
        const card = document.getElementById(`student-${studentId}`);
        if (!card) return;

        const sentence1 =
          data.sentences && data.sentences[0] ? data.sentences[0] : "";
        const isCompleted = sentence1 !== "";

        if (isCompleted) card.classList.add("completed");

        card.innerHTML = `
                <h4>${data.nickname || "ìµëª…"} ${isCompleted ? "âœ…" : "â³"}</h4>
                <div><strong>ë¬¸ì¥:</strong> ${sentence1 || "(ì‘ì„± ì¤‘...)"}</div>
            `;
      }

      function updateParticipationStatus() {
        const cards = document.querySelectorAll(".student-card");
        const total = cards.length;
        const completed = document.querySelectorAll(
          ".student-card.completed",
        ).length;

        // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
        const participantCountEl = document.getElementById("participant-count");
        const completedCountEl = document.getElementById("completed-count");
        if (participantCountEl) participantCountEl.textContent = total;
        if (completedCountEl) completedCountEl.textContent = completed;

        const progressBar = document.getElementById("progress-bar");
        const percentage = total > 0 ? (completed / total) * 100 : 0;
        progressBar.style.width = percentage + "%";
        progressBar.textContent = `${completed}/${total}ëª… ì™„ë£Œ`;

        const statusText = document.getElementById("participation-text");
        statusText.textContent = `ì´ ${total}ëª… ì°¸ì—¬ ì¤‘ (ì™„ë£Œ: ${completed}ëª…)`;

        document.getElementById("start-analysis-btn").disabled = completed < 1;
      }

      function closeInput() {
        if (!confirm("ì…ë ¥ì„ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        if (!window.firebaseReady) {
          alert("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (ì—°ê²° ì¤‘...)");
          return;
        }

        const roomRef = window.firebaseRef(
          window.firebaseDB,
          `rooms/${currentRoom}`,
        );
        window.firebaseUpdate(roomRef, { status: "closed" });
        alert("ì…ë ¥ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      async function startAnalysis() {
        collectAllSentences(async () => {
          if (allSentences.length === 0) {
            alert("ë¶„ì„í•  ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          console.log("=== í˜•íƒœì†Œ ë¶„ì„ ì‹œì‘ ===");

          // ê° ë¬¸ì¥ë³„ë¡œ í˜•íƒœì†Œ ë¶„ì„
          currentMorphemes = [];
          for (let i = 0; i < allSentences.length; i++) {
            const morphemes = await analyzeMorphemes(allSentences[i]);
            currentMorphemes.push(morphemes);
          }

          console.log("âœ… í˜•íƒœì†Œ ë¶„ì„ ì™„ë£Œ");

          // í˜•íƒœì†Œ ë¶„ë¦¬ íƒ­ìœ¼ë¡œ ì´ë™
          document.getElementById("tab-btn-morpheme").disabled = false;
          switchTab("morpheme");

          // í˜•íƒœì†Œ ê²°ê³¼ ë Œë”ë§
          renderAllMorphemes();
        });
      }

      function goBackToCollection() {
        switchTab("collection");
      }

      function goBackToMorpheme() {
        switchTab("morpheme");
      }

      function goBackToAnalysis() {
        switchTab("analysis");
      }

      // ==========================================
      // í˜•íƒœì†Œ ì„¤ëª… ëª¨ë‹¬ ì œì–´
      // ==========================================
      function showMorphemeGuide() {
        const modal = document.getElementById("morpheme-guide-modal");
        modal.style.display = "block";

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        modal.onclick = function (event) {
          if (event.target === modal) {
            closeMorphemeGuide();
          }
        };
      }

      function closeMorphemeGuide() {
        const modal = document.getElementById("morpheme-guide-modal");
        modal.style.display = "none";
      }

      // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeMorphemeGuide();
        }
      });

      function proceedToAnalysis() {
        // ì„ íƒëœ í˜•íƒœì†Œë¡œ ì›Œë“œí´ë¼ìš°ë“œ ìƒì„±
        document.getElementById("tab-btn-analysis").disabled = false;
        switchTab("analysis");

        setTimeout(() => {
          const selectedWords = [];
          currentMorphemes.forEach((morphemes) => {
            morphemes.forEach((m) => {
              if (m.selected) {
                selectedWords.push(m.lex);
              }
            });
          });

          window.wordFrequency = {};
          selectedWords.forEach((word) => {
            window.wordFrequency[word] = (window.wordFrequency[word] || 0) + 1;
          });

          const sortedWords = Object.entries(window.wordFrequency)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 150);

          // ë¹ˆë„ í…Œì´ë¸” ìƒì„±
          createFrequencyTable(sortedWords.slice(0, 20)); // ìƒìœ„ 20ê°œë§Œ í‘œì‹œ

          // ì›Œë“œí´ë¼ìš°ë“œ ìƒì„±
          createWordCloud(sortedWords);

          console.log("âœ… í…ìŠ¤íŠ¸ ë¶„ì„ ì™„ë£Œ");
        }, 300);
      }

      function collectAllSentences(callback) {
        allSentences = [];
        if (!currentRoom) {
          if (callback) callback();
          return;
        }

        if (!window.firebaseReady) {
          console.error("Firebaseê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          if (callback) callback();
          return;
        }

        const studentsRef = window.firebaseRef(
          window.firebaseDB,
          `rooms/${currentRoom}/students`,
        );
        window.firebaseOnValue(
          studentsRef,
          (snapshot) => {
            allSentences = [];

            if (snapshot.exists()) {
              snapshot.forEach((child) => {
                const studentData = child.val();
                if (
                  studentData.sentences &&
                  Array.isArray(studentData.sentences)
                ) {
                  studentData.sentences.forEach((sentence) => {
                    if (sentence && sentence.trim()) {
                      allSentences.push(sentence.trim());
                    }
                  });
                }
              });
            }

            if (callback) callback();
          },
          { onlyOnce: true },
        );
      }

      function joinRoom() {
        console.log("=== joinRoom ì‹œì‘ ===");
        if (!window.firebaseReady) {
          alert("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (ì—°ê²° ì¤‘...)");
          return;
        }

        let code = document
          .getElementById("room-code-input")
          .value.toUpperCase()
          .trim();
        const urlParams = new URLSearchParams(window.location.search);
        const urlRoom = urlParams.get("room");
        if (urlRoom) code = urlRoom.toUpperCase();

        if (!code) {
          alert("ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        console.log("ë°© ì½”ë“œ:", code);
        currentRoom = code;

        const roomRef = window.firebaseRef(window.firebaseDB, `rooms/${code}`);
        window.firebaseOnValue(
          roomRef,
          (snapshot) => {
            console.log("Firebase snapshot ë°›ìŒ, exists:", snapshot.exists());
            if (snapshot.exists()) {
              const roomData = snapshot.val();
              console.log("roomData:", roomData);
              console.log("topicImage ìˆìŒ?", !!roomData.topicImage);

              // ë§Œë£Œëœ ë°© ì²´í¬
              if (isRoomExpired(roomData)) {
                alert("ì´ ë°©ì€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (2ì‹œê°„ ê²½ê³¼)");
                deleteRoom(code); // ë§Œë£Œëœ ë°© ì‚­ì œ
                return;
              }

              if (roomData.status === "closed") {
                alert("ì´ ë°©ì€ ì…ë ¥ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.");
                return;
              }

              document.getElementById("room-join").classList.add("hidden");
              document
                .getElementById("student-input")
                .classList.remove("hidden");
              console.log("âœ… student-input í™”ë©´ í‘œì‹œë¨");

              // ì£¼ì œ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í‘œì‹œ
              if (roomData.topicImage) {
                console.log("ì´ë¯¸ì§€ ë°ì´í„° ìˆìŒ, showStudentTopicImage í˜¸ì¶œ");
                showStudentTopicImage(roomData.topicImage);
              } else {
                console.warn("âš ï¸ topicImageê°€ ì—†ìŠµë‹ˆë‹¤");
              }

              // ì´ë¯¸ì§€ ë³€ê²½ ì‹¤ì‹œê°„ ê°ì§€
              const imageRef = window.firebaseRef(
                window.firebaseDB,
                `rooms/${code}/topicImage`,
              );
              window.firebaseOnValue(imageRef, (imgSnapshot) => {
                const imageData = imgSnapshot.val();
                console.log("ì´ë¯¸ì§€ ë¦¬ìŠ¤ë„ˆ: imageData ìˆìŒ?", !!imageData);
                if (imageData) {
                  showStudentTopicImage(imageData);
                } else {
                  hideStudentTopicImage();
                }
              });
            } else {
              alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°© ì½”ë“œì…ë‹ˆë‹¤.");
            }
          },
          { onlyOnce: true },
        );
      }

      // í•™ìƒ í™”ë©´ì— ì£¼ì œ ì´ë¯¸ì§€ í‘œì‹œ
      function showStudentTopicImage(imageData) {
        console.log(
          "showStudentTopicImage í˜¸ì¶œë¨, imageData ê¸¸ì´:",
          imageData ? imageData.length : 0,
        );

        // ë¬¸ì¥ ì…ë ¥ ì„¹ì…˜ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ (ë‹‰ë„¤ì„ ì„¹ì…˜ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ)
        const sentenceContainer = document.getElementById(
          "sentence-topic-image",
        );
        const sentenceImg = document.getElementById("sentence-image-display");

        if (sentenceContainer && sentenceImg) {
          sentenceImg.src = imageData;
          sentenceContainer.style.display = "block";
          console.log("âœ… ë¬¸ì¥ ì…ë ¥ ì„¹ì…˜ ì´ë¯¸ì§€ í‘œì‹œ ì™„ë£Œ");
        }
      }

      // í•™ìƒ í™”ë©´ì—ì„œ ì£¼ì œ ì´ë¯¸ì§€ ìˆ¨ê¹€
      function hideStudentTopicImage() {
        const sentenceContainer = document.getElementById(
          "sentence-topic-image",
        );

        if (sentenceContainer) {
          sentenceContainer.style.display = "none";
        }
      }

      function goBackToNickname() {
        // ë¬¸ì¥ ì…ë ¥ ìˆ¨ê¸°ê³  ë‹‰ë„¤ì„ ì„¹ì…˜ ë‹¤ì‹œ ë³´ì´ê¸°
        document.getElementById("sentence-input").classList.add("hidden");
        document.getElementById("nickname-section").classList.remove("hidden");

        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById("sentence1").value = "";
        document.getElementById("sentence1").disabled = false;
      }

      function setNickname() {
        const nickname = document.getElementById("nickname-input").value.trim();
        if (!nickname) {
          alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        if (!window.firebaseReady) {
          alert("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (ì—°ê²° ì¤‘...)");
          return;
        }

        currentNickname = nickname;
        document.getElementById("student-nickname").textContent = nickname;

        const studentRef = window.firebasePush(
          window.firebaseRef(
            window.firebaseDB,
            `rooms/${currentRoom}/students`,
          ),
        );
        window.firebaseSet(studentRef, {
          nickname: nickname,
          sentences: [""], // 1ê°œë§Œ
          timestamp: Date.now(),
        });

        // ë‹‰ë„¤ì„ ì„¹ì…˜ ìˆ¨ê¸°ê³  ë¬¸ì¥ ì…ë ¥ ì„¹ì…˜ ë³´ì´ê¸°
        document.getElementById("nickname-section").classList.add("hidden");
        document.getElementById("sentence-input").classList.remove("hidden");
        console.log("âœ… ë¬¸ì¥ ì…ë ¥ í™”ë©´ìœ¼ë¡œ ì „í™˜");
      }

      function submitSentences() {
        const s1 = document.getElementById("sentence1").value.trim();

        if (!s1) {
          alert("ë¬¸ì¥ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.");
          return;
        }

        if (!window.firebaseReady) {
          alert("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (ì—°ê²° ì¤‘...)");
          return;
        }

        const studentsRef = window.firebaseRef(
          window.firebaseDB,
          `rooms/${currentRoom}/students`,
        );
        window.firebaseOnValue(
          studentsRef,
          (snapshot) => {
            snapshot.forEach((child) => {
              if (child.val().nickname === currentNickname) {
                const studentRef = window.firebaseRef(
                  window.firebaseDB,
                  `rooms/${currentRoom}/students/${child.key}`,
                );
                window.firebaseUpdate(studentRef, { sentences: [s1] });
              }
            });
          },
          { onlyOnce: true },
        );

        document.getElementById("sentence1").disabled = true;
        document.querySelector("#sentence-input button").style.display = "none";
        document.getElementById("submission-status").classList.remove("hidden");
      }

      function viewAnalysisAsStudent() {
        collectAllSentences(() => {
          if (allSentences.length < 1) {
            alert("ì•„ì§ ë¬¸ì¥ì´ ìˆ˜ì§‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
          }

          document.getElementById("tab-btn-analysis").disabled = false;
          document.getElementById("tab-btn-vector").disabled = false;
          switchTab("analysis");

          setTimeout(() => analyzeText(), 300);
        });
      }

      async function startDemoAnalysis() {
        const textarea = document.getElementById("demo-sentences");
        const text = textarea.value.trim();

        if (!text) {
          alert("ë¶„ì„í•  ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const sentences = text
          .split("\n")
          .map((s) => s.trim())
          .filter((s) => s.length > 0);

        if (sentences.length < 1) {
          alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        allSentences = sentences;

        console.log("=== ì²´í—˜ ëª¨ë“œ: í˜•íƒœì†Œ ë¶„ì„ ì‹œì‘ ===");

        // ê° ë¬¸ì¥ë³„ë¡œ í˜•íƒœì†Œ ë¶„ì„
        currentMorphemes = [];
        for (let i = 0; i < allSentences.length; i++) {
          const morphemes = await analyzeMorphemes(allSentences[i]);
          currentMorphemes.push(morphemes);
        }

        console.log("âœ… í˜•íƒœì†Œ ë¶„ì„ ì™„ë£Œ");

        // í˜•íƒœì†Œ ë¶„ë¦¬ íƒ­ìœ¼ë¡œ ì´ë™
        document.getElementById("tab-btn-morpheme").disabled = false;
        document.getElementById("tab-btn-analysis").disabled = false;
        document.getElementById("tab-btn-vector").disabled = false;
        switchTab("morpheme");

        // í˜•íƒœì†Œ ê²°ê³¼ ë Œë”ë§
        renderAllMorphemes();
      }

      // ==========================================
      // í˜•íƒœì†Œ ë¶„ì„ (ê°•í™”ëœ ë¡œì»¬ ë¶„ì„)
      // ==========================================
      async function analyzeMorphemes(text) {
        console.log("ğŸ”¬ í˜•íƒœì†Œ ë¶„ì„ ì‹œì‘ (ë¡œì»¬ ê°•í™” ë¶„ì„)");

        // ëª…ì‚¬ ì‚¬ì „ì´ ì•„ì§ ë¡œë“œ ì¤‘ì´ë©´ ëŒ€ê¸°
        if (!dictionaryLoaded) {
          await loadNounDictionary();
        }

        const rawTokens = text.split(/\s+/).filter((t) => t.length > 0);
        const morphemes = [];

        rawTokens.forEach((token) => {
          // 0-0. ìˆ«ì íŒ¨í„´ (ìˆœìˆ˜ ìˆ«ì, ìˆ«ì+ë‹¨ìœ„)
          if (/^\d+$/.test(token)) {
            morphemes.push({ lex: token, tag: "SN", selected: false }); // ìˆ«ì
            return;
          }
          if (/^\d+[ê°€-í£]+$/.test(token)) {
            const match = token.match(/^(\d+)([ê°€-í£]+)$/);
            if (match) {
              morphemes.push({ lex: match[1], tag: "SN", selected: false });
              morphemes.push({ lex: match[2], tag: "NNB", selected: true });
              return;
            }
          }

          // 0-1. ì˜ì–´ ë‹¨ì–´
          if (/^[a-zA-Z]+$/.test(token)) {
            morphemes.push({ lex: token, tag: "SL", selected: true }); // ì™¸êµ­ì–´
            return;
          }

          // 0-2. íŠ¹ìˆ˜ë¬¸ì í¬í•¨
          if (/[!@#$%^&*()_+=\[\]{};:'",.<>?/\\|`~-]/.test(token)) {
            morphemes.push({ lex: token, tag: "SF", selected: false }); // íŠ¹ìˆ˜ë¬¸ì
            return;
          }

          // 0. 10,000ê°œ ëª…ì‚¬ ì‚¬ì „ì— ìˆìœ¼ë©´ ë¶„ë¦¬í•˜ì§€ ì•ŠìŒ (ìµœìš°ì„ !)
          if (NOUN_DICTIONARY.has(token)) {
            morphemes.push({ lex: token, tag: "NNG", selected: true });
            return;
          }

          // 0-1. ë³µí•©ëª…ì‚¬ ì‚¬ì „ì— ìˆìœ¼ë©´ ë¶„ë¦¬í•˜ì§€ ì•ŠìŒ
          if (COMPOUND_NOUNS.has(token)) {
            morphemes.push({ lex: token, tag: "NNG", selected: true });
            return;
          }

          // 0-2. ë¶„ë¦¬ ê¸ˆì§€ íŒ¨í„´ (í˜•ìš©ì‚¬, ë™ì‚¬ ë“±)
          if (DONT_SPLIT.has(token)) {
            morphemes.push({ lex: token, tag: "NNG", selected: true });
            return;
          }

          let processed = false;

          // 1. ì¡°ì‚¬ ë¶„ë¦¬ ì‹œë„ (ê¸´ ê²ƒë¶€í„° ìš°ì„  ì²˜ë¦¬)
          const sortedParticles = [...PARTICLES].sort(
            (a, b) => b.length - a.length,
          );
          for (const particle of sortedParticles) {
            if (token.endsWith(particle) && token.length > particle.length) {
              const stem = token.slice(0, -particle.length);

              // âœ¨ ëª…ì‚¬ ì‚¬ì „ ê²€ì¦: ì–´ê°„ì´ ì‚¬ì „ì— ìˆìœ¼ë©´ ë¶„ë¦¬!
              const stemInDict =
                NOUN_DICTIONARY.has(stem) || COMPOUND_NOUNS.has(stem);

              if (!stemInDict) {
                // ì‚¬ì „ì— ì—†ìœ¼ë©´ ì–´ê°„ ê¸¸ì´ ê²€ì¦ (2ê¸€ì ì´í•˜ë©´ ë¶„ë¦¬ ì•ˆ í•¨)
                if (stem.length <= 2) continue;
              }

              // Hangul.jsë¡œ ë°›ì¹¨ ê²€ì¦
              if (typeof Hangul !== "undefined") {
                const lastChar = stem[stem.length - 1];
                const hasCoda = Hangul.disassemble(lastChar).length === 3;

                // ì´/ê°€ ê²€ì¦
                if (
                  (particle === "ì´" && !hasCoda) ||
                  (particle === "ê°€" && hasCoda)
                ) {
                  continue; // ì˜ëª»ëœ ì¡°í•©
                }

                // ì„/ë¥¼ ê²€ì¦
                if (
                  (particle === "ì„" && !hasCoda) ||
                  (particle === "ë¥¼" && hasCoda)
                ) {
                  continue; // ì˜ëª»ëœ ì¡°í•©
                }

                // ì€/ëŠ” ê²€ì¦
                if (
                  (particle === "ì€" && !hasCoda) ||
                  (particle === "ëŠ”" && hasCoda)
                ) {
                  continue; // ì˜ëª»ëœ ì¡°í•©
                }
              }

              morphemes.push({ lex: stem, tag: "NNG", selected: true });
              morphemes.push({ lex: particle, tag: "JX", selected: false });
              processed = true;
              break;
            }
          }

          if (processed) return;

          // 2. ì–´ë¯¸ ë¶„ë¦¬ ì‹œë„ (ê¸´ ê²ƒë¶€í„° ìš°ì„  ì²˜ë¦¬)
          const sortedEndings = [...ENDINGS].sort(
            (a, b) => b.length - a.length,
          );
          for (const ending of sortedEndings) {
            if (token.endsWith(ending) && token.length > ending.length) {
              const stem = token.slice(0, -ending.length);

              // ì–´ê°„ì´ ë„ˆë¬´ ì§§ìœ¼ë©´ ë¶„ë¦¬í•˜ì§€ ì•ŠìŒ
              if (stem.length <= 2) continue;

              morphemes.push({ lex: stem, tag: "VV", selected: true });
              morphemes.push({ lex: ending, tag: "EF", selected: false });
              processed = true;
              break;
            }
          }

          if (!processed) {
            // 3. ë¶„ë¦¬ë˜ì§€ ì•Šì€ ë‹¨ì–´ëŠ” ê·¸ëŒ€ë¡œ (ëª…ì‚¬ë¡œ ì²˜ë¦¬)
            morphemes.push({ lex: token, tag: "NNG", selected: true });
          }
        });

        return morphemes;
      }

      function renderMorphemes(morphemes, sentenceIndex) {
        const container = document.getElementById("morphemeMainContainer");
        if (!container) return;

        const morphemeCard = document.createElement("div");
        morphemeCard.className = "morpheme-card";
        morphemeCard.innerHTML = `
                <div class="morpheme-header">ë¬¸ì¥ ${sentenceIndex + 1}: "${allSentences[sentenceIndex]}"</div>
                <div class="morpheme-list"></div>
            `;

        const list = morphemeCard.querySelector(".morpheme-list");

        morphemes.forEach((m, idx) => {
          const item = document.createElement("div");
          item.className = `morpheme-item ${m.selected ? "selected" : "deselected"}`;
          item.dataset.sentenceIndex = sentenceIndex;
          item.dataset.morphemeIndex = idx;
          item.innerHTML = `
                    <button class="morpheme-split-btn" onclick="splitMorpheme(${sentenceIndex}, ${idx})">âœ‚ï¸</button>
                    <div class="morpheme-word">${m.lex}</div>
                    <div class="morpheme-pos">${m.tag}</div>
                `;

          // í´ë¦­ ì´ë²¤íŠ¸: Shiftí‚¤ë¡œ í•©ì¹˜ê¸° ì„ íƒ, ì¼ë°˜ í´ë¦­ì€ í¬í•¨/ì œì™¸
          item.addEventListener("click", (e) => {
            if (e.shiftKey) {
              toggleMarkMorpheme(sentenceIndex, idx, item);
            } else {
              toggleMorphemeSelection(sentenceIndex, idx);
            }
          });

          item.addEventListener("dblclick", () =>
            editMorpheme(sentenceIndex, idx, item),
          );

          list.appendChild(item);
        });

        container.appendChild(morphemeCard);
      }

      function toggleMarkMorpheme(sentenceIndex, morphemeIndex, item) {
        const key = `${sentenceIndex}-${morphemeIndex}`;
        const existingIndex = markedMorphemes.findIndex(
          (m) => `${m.sentenceIndex}-${m.morphemeIndex}` === key,
        );

        if (existingIndex >= 0) {
          // ì´ë¯¸ ì„ íƒë¨ -> ì„ íƒ í•´ì œ
          markedMorphemes.splice(existingIndex, 1);
          item.classList.remove("marked");
        } else {
          // ìƒˆë¡œ ì„ íƒ
          markedMorphemes.push({ sentenceIndex, morphemeIndex, item });
          item.classList.add("marked");
        }

        updateMergeButton();

        // âœ¨ ì •í™•íˆ 2ê°œê°€ ì„ íƒë˜ë©´ ìë™ìœ¼ë¡œ í•©ì¹˜ê¸° ì‹¤í–‰
        if (markedMorphemes.length === 2) {
          setTimeout(() => {
            mergeMorphemes();
          }, 100); // ì•½ê°„ì˜ ì§€ì—°ìœ¼ë¡œ UI ì—…ë°ì´íŠ¸ í›„ ì‹¤í–‰
        }
      }

      function updateMergeButton() {
        const container = document.getElementById("merge-button-container");
        const countEl = document.getElementById("merge-count");

        if (markedMorphemes.length >= 2) {
          container.style.display = "block";
          countEl.textContent = markedMorphemes.length;
        } else {
          container.style.display = "none";
        }
      }

      function clearMarkedMorphemes() {
        markedMorphemes.forEach(({ item }) => {
          item.classList.remove("marked");
        });
        markedMorphemes = [];
        updateMergeButton();
      }

      function mergeMorphemes() {
        if (markedMorphemes.length < 2) {
          alert("í•©ì¹  í˜•íƒœì†Œë¥¼ 2ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        // ê°™ì€ ë¬¸ì¥ ë‚´ì˜ í˜•íƒœì†Œë§Œ í•©ì¹  ìˆ˜ ìˆìŒ
        const sentenceIndex = markedMorphemes[0].sentenceIndex;
        const allSameSentence = markedMorphemes.every(
          (m) => m.sentenceIndex === sentenceIndex,
        );

        if (!allSameSentence) {
          alert("ê°™ì€ ë¬¸ì¥ ë‚´ì˜ í˜•íƒœì†Œë§Œ í•©ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }

        // ì¸ë±ìŠ¤ ìˆœì„œëŒ€ë¡œ ì •ë ¬
        markedMorphemes.sort((a, b) => a.morphemeIndex - b.morphemeIndex);

        // ì—°ì†ëœ í˜•íƒœì†Œì¸ì§€ í™•ì¸
        let isContinuous = true;
        for (let i = 1; i < markedMorphemes.length; i++) {
          if (
            markedMorphemes[i].morphemeIndex !==
            markedMorphemes[i - 1].morphemeIndex + 1
          ) {
            isContinuous = false;
            break;
          }
        }

        if (!isContinuous) {
          alert(
            'ì—°ì†ëœ í˜•íƒœì†Œë§Œ í•©ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: "ì¸ê³µ" + "ì§€ëŠ¥" â­•, "ì¸ê³µ" + "ë°°ìš°" âŒ)',
          );
          return;
        }

        // í˜•íƒœì†Œ í•©ì¹˜ê¸°
        const morphemes = currentMorphemes[sentenceIndex];
        const startIdx = markedMorphemes[0].morphemeIndex;
        const endIdx =
          markedMorphemes[markedMorphemes.length - 1].morphemeIndex;

        // í•©ì³ì§„ í…ìŠ¤íŠ¸
        const mergedText = markedMorphemes
          .map((m) => morphemes[m.morphemeIndex].lex)
          .join("");

        // ì²« ë²ˆì§¸ í˜•íƒœì†Œì˜ ì†ì„± ìœ ì§€
        const mergedMorpheme = {
          lex: mergedText,
          tag: morphemes[startIdx].tag,
          selected: morphemes[startIdx].selected,
        };

        // ë°°ì—´ì—ì„œ ì œê±°í•˜ê³  í•©ì³ì§„ ê²ƒ ì‚½ì…
        morphemes.splice(startIdx, endIdx - startIdx + 1, mergedMorpheme);

        // ì„ íƒ ì´ˆê¸°í™” ë° ì¬ë Œë”ë§
        clearMarkedMorphemes();
        renderAllMorphemes();

        console.log(`âœ… í˜•íƒœì†Œ í•©ì¹˜ê¸° ì™„ë£Œ: "${mergedText}"`);
      }

      function toggleMorphemeSelection(sentenceIndex, morphemeIndex) {
        const morpheme = currentMorphemes[sentenceIndex][morphemeIndex];
        morpheme.selected = !morpheme.selected;

        const item = document.querySelector(
          `[data-sentence-index="${sentenceIndex}"][data-morpheme-index="${morphemeIndex}"]`,
        );
        if (item) {
          item.classList.toggle("selected");
          item.classList.toggle("deselected");
        }
      }

      function editMorpheme(sentenceIndex, morphemeIndex, element) {
        const morpheme = currentMorphemes[sentenceIndex][morphemeIndex];
        element.classList.add("editing");

        const wordDiv = element.querySelector(".morpheme-word");
        const originalText = wordDiv.textContent;

        wordDiv.innerHTML = `
                <input type="text" class="morpheme-edit-input" value="${originalText}" />
                <div class="morpheme-edit-buttons">
                    <button class="morpheme-edit-btn save">âœ“</button>
                    <button class="morpheme-edit-btn cancel">âœ—</button>
                </div>
            `;

        const input = wordDiv.querySelector("input");
        input.focus();
        input.select();

        const saveBtn = wordDiv.querySelector(".save");
        const cancelBtn = wordDiv.querySelector(".cancel");

        const save = () => {
          const newValue = input.value.trim();
          if (newValue) {
            morpheme.lex = newValue;
            wordDiv.innerHTML = newValue;
            element.classList.remove("editing");
          }
        };

        const cancel = () => {
          wordDiv.innerHTML = originalText;
          element.classList.remove("editing");
        };

        saveBtn.onclick = save;
        cancelBtn.onclick = cancel;
        input.onkeydown = (e) => {
          if (e.key === "Enter") save();
          if (e.key === "Escape") cancel();
        };
      }

      function splitMorpheme(sentenceIndex, morphemeIndex) {
        const morpheme = currentMorphemes[sentenceIndex][morphemeIndex];
        const word = morpheme.lex;

        if (word.length < 2) {
          alert("ë‹¨ì–´ê°€ ë„ˆë¬´ ì§§ì•„ ë¶„ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const midPoint = Math.floor(word.length / 2);
        const part1 = word.substring(0, midPoint);
        const part2 = word.substring(midPoint);

        const newMorphemes = [
          { lex: part1, tag: morpheme.tag, selected: morpheme.selected },
          { lex: part2, tag: morpheme.tag, selected: morpheme.selected },
        ];

        currentMorphemes[sentenceIndex].splice(
          morphemeIndex,
          1,
          ...newMorphemes,
        );
        renderAllMorphemes();
      }

      function renderAllMorphemes() {
        const container = document.getElementById("morphemeMainContainer");
        if (!container) return;
        container.innerHTML = "";

        currentMorphemes.forEach((morphemes, idx) => {
          renderMorphemes(morphemes, idx);
        });
      }

      function recalculateWithModifiedMorphemes() {
        const selectedWords = [];
        currentMorphemes.forEach((morphemes) => {
          morphemes.forEach((m) => {
            if (m.selected) {
              selectedWords.push(m.lex);
            }
          });
        });

        window.wordFrequency = {};
        selectedWords.forEach((word) => {
          window.wordFrequency[word] = (window.wordFrequency[word] || 0) + 1;
        });

        const sortedWords = Object.entries(window.wordFrequency)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 150);

        console.log("âœ… í˜•íƒœì†Œ ìˆ˜ì • í›„ ì¬ê³„ì‚° ì™„ë£Œ");
        createWordCloud(sortedWords);
      }

      // ==========================================
      // í…ìŠ¤íŠ¸ ë¶„ì„ ì—”ì§„
      // ==========================================
      async function analyzeText() {
        if (allSentences.length === 0) {
          alert("ë¶„ì„í•  ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        console.log("=== í˜•íƒœì†Œ ë¶„ì„ ì‹œì‘ ===");

        // ê° ë¬¸ì¥ë³„ë¡œ í˜•íƒœì†Œ ë¶„ì„
        currentMorphemes = [];
        for (let i = 0; i < allSentences.length; i++) {
          const morphemes = await analyzeMorphemes(allSentences[i]);
          currentMorphemes.push(morphemes);
        }

        // í˜•íƒœì†Œ ê²°ê³¼ í‘œì‹œ
        const morphemeCard = document.getElementById("morphemeResultCard");
        if (morphemeCard) {
          morphemeCard.style.display = "block";
          renderAllMorphemes();
        }

        console.log("âœ… í˜•íƒœì†Œ ë¶„ì„ ì™„ë£Œ");

        // ì„ íƒëœ í˜•íƒœì†Œë¡œ ì›Œë“œí´ë¼ìš°ë“œ ìƒì„±
        const selectedWords = [];
        currentMorphemes.forEach((morphemes) => {
          morphemes.forEach((m) => {
            if (m.selected) {
              selectedWords.push(m.lex);
            }
          });
        });

        wordFrequency = {};
        selectedWords.forEach((word) => {
          wordFrequency[word] = (wordFrequency[word] || 0) + 1;
        });

        const sortedWords = Object.entries(wordFrequency)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 150);

        createWordCloud(sortedWords);

        console.log("âœ… í…ìŠ¤íŠ¸ ë¶„ì„ ì™„ë£Œ");
      }

      // ==========================================
      // ë§ˆìŠ¤í¬ ì´ë¯¸ì§€ ì„¤ì •
      // ëª¨ë“  SVG: ê²€ì€ ë°°ê²½ + í°ìƒ‰ ë„í˜• (wordcloud2.jsê°€ í°ìƒ‰ ì˜ì—­ì— ë‹¨ì–´ ë°°ì¹˜)
      // ==========================================

      // ë‚´ì¥ SVG (ê²€ì€ ë°°ê²½ì— í°ìƒ‰ ë„í˜•)
      const maskSVGs = {
        circle: `<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
                <rect width="500" height="500" fill="#000000"/>
                <circle cx="250" cy="250" r="230" fill="#FFFFFF"/>
            </svg>`,

        diamond: `<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
                <rect width="500" height="500" fill="#000000"/>
                <polygon points="250,30 470,250 250,470 30,250" fill="#FFFFFF"/>
            </svg>`,

        square: `<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
                <rect width="500" height="500" fill="#000000"/>
                <rect x="40" y="40" width="420" height="420" fill="#FFFFFF"/>
            </svg>`,

        heart: `<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
                <rect width="500" height="500" fill="#000000"/>
                <path d="M250 435 C250 435 455 280 455 175 C455 85 385 45 320 45 C270 45 250 85 250 85 C250 85 230 45 180 45 C115 45 45 85 45 175 C45 280 250 435 250 435 Z" fill="#FFFFFF"/>
            </svg>`,

        star: `<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
                <rect width="500" height="500" fill="#000000"/>
                <polygon points="250,25 295,175 455,175 330,275 375,450 250,350 125,450 170,275 45,175 205,175" fill="#FFFFFF"/>
            </svg>`,

        cloud: `<svg xmlns="http://www.w3.org/2000/svg" width="500" height="400" viewBox="0 0 500 400">
                <rect width="500" height="400" fill="#000000"/>
                <ellipse cx="160" cy="240" rx="100" ry="85" fill="#FFFFFF"/>
                <ellipse cx="340" cy="240" rx="110" ry="90" fill="#FFFFFF"/>
                <ellipse cx="250" cy="200" rx="90" ry="80" fill="#FFFFFF"/>
                <ellipse cx="100" cy="270" rx="70" ry="60" fill="#FFFFFF"/>
                <ellipse cx="400" cy="270" rx="75" ry="65" fill="#FFFFFF"/>
                <ellipse cx="250" cy="280" rx="180" ry="70" fill="#FFFFFF"/>
                <ellipse cx="200" cy="160" rx="60" ry="55" fill="#FFFFFF"/>
                <ellipse cx="300" cy="170" rx="55" ry="50" fill="#FFFFFF"/>
            </svg>`,
      };

      // ë§ˆìŠ¤í¬ ìº”ë²„ìŠ¤ ìºì‹œ (shape ë³€ê²½ì‹œ ìë™ ê°±ì‹ )
      let maskCanvasCache = {};

      // ë§ˆìŠ¤í¬ ìº”ë²„ìŠ¤ ìƒì„± í•¨ìˆ˜ (wordcloud2.jsìš©)
      // wordcloud2.jsëŠ” ìº”ë²„ìŠ¤ì˜ í”½ì…€ì„ ì½ì–´ ë°°ê²½ìƒ‰ê³¼ ê°™ì€ ìƒ‰ì˜ ì˜ì—­ì—ë§Œ ë‹¨ì–´ ë°°ì¹˜
      // ë„í˜• ë‚´ë¶€: í°ìƒ‰(ë°°ê²½ìƒ‰) = ë‹¨ì–´ ë°°ì¹˜ ê°€ëŠ¥
      // ë„í˜• ì™¸ë¶€: ê²€ì€ìƒ‰ or ë‹¤ë¥¸ìƒ‰ = ë‹¨ì–´ ë°°ì¹˜ ë¶ˆê°€
      function createMaskCanvas(shapeName, width, height) {
        return new Promise((resolve, reject) => {
          const cacheKey = `${shapeName}_${width}_${height}`;

          // ìºì‹œ í™•ì¸
          if (maskCanvasCache[cacheKey]) {
            resolve(maskCanvasCache[cacheKey]);
            return;
          }

          const svg = maskSVGs[shapeName];
          if (!svg) {
            resolve(null);
            return;
          }

          const img = new Image();
          const blob = new Blob([svg], { type: "image/svg+xml" });
          const url = URL.createObjectURL(blob);

          img.onload = function () {
            URL.revokeObjectURL(url);

            // ë§ˆìŠ¤í¬ìš© ìº”ë²„ìŠ¤ ìƒì„±
            const maskCanvas = document.createElement("canvas");
            maskCanvas.width = width;
            maskCanvas.height = height;
            const maskCtx = maskCanvas.getContext("2d");

            // SVGë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
            maskCtx.drawImage(img, 0, 0, width, height);

            // í”½ì…€ ë°ì´í„° ì²˜ë¦¬
            // wordcloud2.jsëŠ” backgroundColor(í°ìƒ‰)ê³¼ ê°™ì€ ì˜ì—­ì—ë§Œ ë°°ì¹˜
            // ë„í˜• ë‚´ë¶€(ë°ì€ìƒ‰): í°ìƒ‰(255,255,255)ìœ¼ë¡œ = ë°°ì¹˜ ê°€ëŠ¥
            // ë„í˜• ì™¸ë¶€(ì–´ë‘ìš´ìƒ‰): ê²€ì€ìƒ‰(0,0,0)ìœ¼ë¡œ = ë°°ì¹˜ ë¶ˆê°€
            const imageData = maskCtx.getImageData(0, 0, width, height);
            const data = imageData.data;

            const threshold = 128;

            for (let i = 0; i < data.length; i += 4) {
              const r = data[i];
              const g = data[i + 1];
              const b = data[i + 2];

              const brightness = (r + g + b) / 3;

              if (brightness > threshold) {
                // ë„í˜• ë‚´ë¶€ (í°ìƒ‰ ì˜ì—­) - ë‹¨ì–´ ë°°ì¹˜ ê°€ëŠ¥
                data[i] = 255; // R
                data[i + 1] = 255; // G
                data[i + 2] = 255; // B
                data[i + 3] = 255; // A
              } else {
                // ë„í˜• ì™¸ë¶€ (ê²€ì€ìƒ‰ ì˜ì—­) - ë‹¨ì–´ ë°°ì¹˜ ë¶ˆê°€
                // ê²€ì€ìƒ‰ìœ¼ë¡œ ì„¤ì • (ë°°ê²½ìƒ‰ê³¼ ë‹¤ë¥´ë©´ ë°°ì¹˜ ì•ˆí•¨)
                data[i] = 0; // R
                data[i + 1] = 0; // G
                data[i + 2] = 0; // B
                data[i + 3] = 255; // A (ë¶ˆíˆ¬ëª…)
              }
            }

            maskCtx.putImageData(imageData, 0, 0);

            maskCanvasCache[cacheKey] = maskCanvas;
            resolve(maskCanvas);
          };

          img.onerror = function () {
            URL.revokeObjectURL(url);
            console.warn(`ë§ˆìŠ¤í¬ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${shapeName}`);
            resolve(null);
          };

          img.src = url;
        });
      }

      // ==========================================
      // WordCloud ìƒì„± (ë¡œë”© í‘œì‹œ + ìˆœì°¨ì  í°íŠ¸ ë¶€ìŠ¤íŠ¸)
      // ==========================================
      async function createWordCloud(wordList) {
        window.currentWordList = wordList;

        const container = document.getElementById("wordcloud-container");
        const canvas = document.getElementById("wordcloud-canvas");
        if (!canvas || !container) return;

        if (wordList.length === 0) {
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.font = "20px Noto Sans KR";
          ctx.fillStyle = "#999";
          ctx.textAlign = "center";
          ctx.fillText(
            "ë¶„ì„í•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.",
            canvas.width / 2,
            canvas.height / 2,
          );
          return;
        }

        // ê¸°ì¡´ WordCloud ì¤‘ë‹¨
        try {
          WordCloud.stop();
        } catch (e) {}

        // Canvas í¬ê¸° ì„¤ì •
        const canvasWidth = Math.max(container.clientWidth || 800, 800);
        const canvasHeight = 600;

        // ğŸ• ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ (ì§„í•˜ê²Œ!)
        let loadingOverlay = document.getElementById("wordcloud-loading");
        if (!loadingOverlay) {
          loadingOverlay = document.createElement("div");
          loadingOverlay.id = "wordcloud-loading";
          loadingOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: #e0f2fe;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 100;
                    border-radius: 12px;
                    border: 2px solid #7dd3fc;
                `;
          container.style.position = "relative";
          container.appendChild(loadingOverlay);
        }

        function updateLoading(emoji, title, subtitle) {
          loadingOverlay.innerHTML = `
                    <div style="font-size: 64px; margin-bottom: 20px; filter: none;">${emoji}</div>
                    <div style="font-size: 20px; color: #1a202c; font-weight: 700;">${title}</div>
                    <div style="font-size: 15px; color: #4a5568; margin-top: 10px; font-weight: 500;">${subtitle}</div>
                `;
        }

        updateLoading("â³", "ì›Œë“œí´ë¼ìš°ë“œ ìƒì„± ì¤‘...", "ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”");
        loadingOverlay.style.display = "flex";

        canvas.width = canvasWidth;
        canvas.height = canvasHeight;

        const ctx = canvas.getContext("2d");
        const maxFreq = wordList[0][1];
        const currentShape = wordCloudSettings.shape;

        // ë§ˆìŠ¤í¬ ìº”ë²„ìŠ¤ ìƒì„±
        let maskCanvas = null;
        try {
          maskCanvas = await createMaskCanvas(
            currentShape,
            canvasWidth,
            canvasHeight,
          );
        } catch (e) {
          console.warn("ë§ˆìŠ¤í¬ ìƒì„± ì‹¤íŒ¨:", e);
        }

        const colorFunction = function () {
          return advancedColors[
            Math.floor(Math.random() * advancedColors.length)
          ];
        };

        const selectedFont = wordCloudSettings.font;
        const fontFamily = selectedFont + ", Do Hyeon, Jua, sans-serif";

        // ìˆœì°¨ì  ë¶€ìŠ¤íŠ¸ ìƒíƒœ
        let boostRank = 0; // í˜„ì¬ ë¶€ìŠ¤íŠ¸ ì ìš© ìˆœìœ„ (0 = ë¶€ìŠ¤íŠ¸ ì—†ìŒ)
        let retryCount = 0;
        const maxRetry = 5; // 3 â†’ 5ë¡œ ì¦ê°€ (ë” ë§ì€ ì¬ì‹œë„)
        const boostStep = 15; // 20 â†’ 15ë¡œ ê°ì†Œ (ì ì§„ì  ì¦ê°€)
        const boostMultiplier = 1.6; // 1.5 â†’ 1.6ìœ¼ë¡œ ì¦ê°€ (ë” í¬ê²Œ)
        let totalCheckCount = 0;
        const maxTotalChecks = 300; // 200 â†’ 300ìœ¼ë¡œ ì¦ê°€
        const startTime = Date.now(); // ì‹œì‘ ì‹œê°„ ê¸°ë¡
        const minLoadingTime = 3000; // 5ì´ˆ â†’ 3ì´ˆë¡œ ë‹¨ì¶•
        const minFillPercent = 40; // âœ¨ ìµœì†Œ ì±„ì›€ë¥  40%

        // ë‹¨ì–´ í¬ê¸° ê³„ì‚° í•¨ìˆ˜ (ë¶€ìŠ¤íŠ¸ ì ìš©)
        function createWeightFactor(boostUpTo) {
          return function (size) {
            const baseSize = Math.min(canvasWidth, canvasHeight) / 8;
            const normalized = Math.log(size + 1) / Math.log(maxFreq + 1);
            let calculatedSize = Math.pow(normalized, 0.6) * baseSize + 8;

            // í˜„ì¬ ë‹¨ì–´ì˜ ìˆœìœ„ ì°¾ê¸°
            const rank = wordList.findIndex((w) => w[1] === size) + 1;

            // boostUpTo ìˆœìœ„ ì´ë‚´ë©´ í¬ê¸° ë¶€ìŠ¤íŠ¸
            if (boostUpTo > 0 && rank > 0 && rank <= boostUpTo) {
              calculatedSize *= boostMultiplier;
            }

            return calculatedSize;
          };
        }

        // ê²€ì •ìƒ‰ì„ í°ìƒ‰ìœ¼ë¡œ ë³€í™˜
        function removeBlackPixels() {
          const imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
          const data = imageData.data;

          for (let i = 0; i < data.length; i += 4) {
            if (data[i] < 15 && data[i + 1] < 15 && data[i + 2] < 15) {
              data[i] = data[i + 1] = data[i + 2] = 255;
            }
          }
          ctx.putImageData(imageData, 0, 0);
        }

        // ì±„ì›€ë¥  ê³„ì‚°
        function calculateFillPercent() {
          const imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
          const data = imageData.data;

          let shapePixels = 0;
          let filledPixels = 0;

          for (let i = 0; i < data.length; i += 4) {
            const r = data[i],
              g = data[i + 1],
              b = data[i + 2];

            // ê²€ì •ìƒ‰ì´ ì•„ë‹Œ í”½ì…€ = ë„í˜• ë‚´ë¶€
            if (!(r < 15 && g < 15 && b < 15)) {
              shapePixels++;
              // í°ìƒ‰ì´ ì•„ë‹Œ í”½ì…€ = ì±„ì›Œì§„ ì˜ì—­
              if (!(r > 240 && g > 240 && b > 240)) {
                filledPixels++;
              }
            }
          }

          return shapePixels > 0
            ? Math.round((filledPixels / shapePixels) * 100)
            : 0;
        }

        // ì›Œë“œí´ë¼ìš°ë“œ ìƒì„± í•¨ìˆ˜
        function generateCloud() {
          // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
          if (maskCanvas) {
            ctx.drawImage(maskCanvas, 0, 0);
          } else {
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);
          }

          const options = {
            list: wordList.slice(0, 120), // 100 â†’ 120ê°œë¡œ ì¦ê°€
            fontFamily: fontFamily,
            fontWeight: "700",
            color: colorFunction,
            backgroundColor: "#ffffff",
            gridSize: 3, // 4 â†’ 3ìœ¼ë¡œ ê°ì†Œ (ë” ì´˜ì´˜í•˜ê²Œ)
            minSize: 8, // 6 â†’ 8ë¡œ ì¦ê°€ (ê°€ë…ì„±)
            rotateRatio: 0.15, // 0.1 â†’ 0.15ë¡œ ì¦ê°€ (ë” ë§ì€ íšŒì „)
            minRotation: -Math.PI / 12,
            maxRotation: Math.PI / 12,
            weightFactor: createWeightFactor(boostRank),
            drawOutOfBound: false,
            shrinkToFit: true,
            shuffle: true,
            wait: 10, // 0 â†’ 10ms (UI ì‘ë‹µì„± í™•ë³´)
            abortThreshold: 3000, // 3ì´ˆ ì´ìƒ ë¸”ë¡œí‚¹ ì‹œ ì¤‘ë‹¨
            clearCanvas: !maskCanvas,
            click: function (item) {
              if (item && item[0]) {
                alert(item[0] + ": " + item[1] + "íšŒ");
              }
            },
          };

          if (!maskCanvas) {
            options.shape = "circle";
            options.ellipticity = 0.65;
          }

          WordCloud(canvas, options);
        }

        // ì™„ì„±ë„ ì²´í¬ ë° ë¶€ìŠ¤íŠ¸ ë¡œì§
        function startMonitoring() {
          let lastFillPercent = 0;
          let stableCount = 0;
          let checkCount = 0;
          const maxChecks = 50; // 150 â†’ 50ìœ¼ë¡œ ì¶•ì†Œ

          const checkInterval = setInterval(() => {
            checkCount++;
            totalCheckCount++;

            // ì „ì²´ íƒ€ì„ì•„ì›ƒ ì²´í¬ (ë¬´í•œë£¨í”„ ë°©ì§€)
            if (totalCheckCount >= maxTotalChecks) {
              clearInterval(checkInterval);
              const elapsed = Date.now() - startTime;
              const remainingTime = Math.max(0, minLoadingTime - elapsed);

              setTimeout(() => {
                if (maskCanvas) removeBlackPixels();
                loadingOverlay.style.display = "none";
                console.log("âš ï¸ ì „ì²´ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì¢…ë£Œ");
              }, remainingTime);
              return;
            }

            const fillPercent = calculateFillPercent();

            updateLoading(
              "â³",
              "ì›Œë“œí´ë¼ìš°ë“œ ìƒì„± ì¤‘...",
              `ì±„ì›€ë¥ : ${fillPercent}% | ì‹œë„: ${retryCount + 1}/${maxRetry + 1}`,
            );

            // ì±„ì›€ë¥  ë³€í™” ì²´í¬
            if (Math.abs(fillPercent - lastFillPercent) < 2) {
              stableCount++;
            } else {
              stableCount = 0;
            }
            lastFillPercent = fillPercent;

            // ì•ˆì •í™”ë¨ (3íšŒ ì—°ì† ë³€í™” ì—†ìŒ) ë˜ëŠ” íƒ€ì„ì•„ì›ƒ
            const isStable =
              stableCount >= 3 ||
              !WordCloud.isActive ||
              checkCount >= maxChecks;

            if (isStable) {
              clearInterval(checkInterval);

              // 40% ë¯¸ë§Œì´ê³  ì¬ì‹œë„ ê°€ëŠ¥í•˜ë©´ â†’ í°íŠ¸ ë¶€ìŠ¤íŠ¸ í›„ ì¬ìƒì„±
              if (fillPercent < minFillPercent && retryCount < maxRetry) {
                retryCount++;
                boostRank += boostStep;

                updateLoading(
                  "ğŸ”„",
                  "ë” ì±„ìš°ëŠ” ì¤‘...",
                  `ìƒìœ„ ${boostRank}ê°œ ë‹¨ì–´ í™•ëŒ€ ì¤‘ (í˜„ì¬: ${fillPercent}%)`,
                );

                setTimeout(() => {
                  try {
                    WordCloud.stop();
                  } catch (e) {}
                  generateCloud();
                  startMonitoring();
                }, 100);
              } else {
                // ì™„ë£Œ! (ìµœì†Œ 3ì´ˆ ëŒ€ê¸°)
                const elapsed = Date.now() - startTime;
                const remainingTime = Math.max(0, minLoadingTime - elapsed);

                setTimeout(() => {
                  if (maskCanvas) removeBlackPixels();
                  loadingOverlay.style.display = "none";

                  // 40% ë¯¸ë‹¬ ì‹œ ê²½ê³ 
                  if (fillPercent < minFillPercent) {
                    console.warn(
                      `âš ï¸ ì›Œë“œí´ë¼ìš°ë“œ ì±„ì›€ë¥  ${fillPercent}% (ëª©í‘œ: ${minFillPercent}%)`,
                    );
                  } else {
                    console.log(
                      `âœ… ì›Œë“œí´ë¼ìš°ë“œ ì™„ì„± (ì±„ì›€ë¥ : ${fillPercent}%, ì‹œë„: ${retryCount + 1}íšŒ, ì†Œìš”: ${((elapsed + remainingTime) / 1000).toFixed(1)}ì´ˆ)`,
                    );
                  }
                }, remainingTime + 200);
              }
            }
          }, 200); // 100ms â†’ 200msë¡œ ì¦ê°€
        }

        // ì‹œì‘
        setTimeout(() => {
          try {
            generateCloud();
            startMonitoring();
          } catch (e) {
            console.error("WordCloud ìƒì„± ì˜¤ë¥˜:", e);
            updateLoading("âŒ", "ì˜¤ë¥˜ ë°œìƒ", e.message);
            setTimeout(() => {
              loadingOverlay.style.display = "none";
            }, 2000);
          }
        }, 50);
      }

      function selectShape(shape) {
        wordCloudSettings.shape = shape;

        // shape ë²„íŠ¼ë§Œ ì„ íƒ (font ë²„íŠ¼ì€ ì œì™¸)
        document
          .querySelectorAll(".shape-option:not(.font-option)")
          .forEach((btn) => btn.classList.remove("active"));
        const selectedBtn = document.querySelector(
          `.shape-option[data-shape="${shape}"]`,
        );
        if (selectedBtn) selectedBtn.classList.add("active");

        const currentWords = window.currentWordList;
        if (currentWords && currentWords.length > 0) {
          createWordCloud(currentWords);
        }
      }

      function selectFont(font) {
        wordCloudSettings.font = font;

        // font ë²„íŠ¼ë§Œ ì„ íƒ
        document
          .querySelectorAll(".font-option")
          .forEach((btn) => btn.classList.remove("active"));
        const selectedBtn = document.querySelector(
          `.font-option[data-font="${font}"]`,
        );
        if (selectedBtn) selectedBtn.classList.add("active");

        const currentWords = window.currentWordList;
        if (currentWords && currentWords.length > 0) {
          createWordCloud(currentWords);
        }
      }

      function createFrequencyTable(wordList) {
        const tbody = document.querySelector("#frequency-table tbody");
        tbody.innerHTML = "";

        const total = wordList.reduce((sum, [_, freq]) => sum + freq, 0);

        for (let i = 0; i < wordList.length; i += 2) {
          const tr = document.createElement("tr");

          // ì™¼ìª½ ì—´ (í™€ìˆ˜ ìˆœìœ„: 1, 3, 5...)
          const leftItem = wordList[i];
          const leftPercentage = ((leftItem[1] / total) * 100).toFixed(1);

          let rowHtml = `
                    <td>${i + 1}</td>
                    <td><strong>${leftItem[0]}</strong></td>
                    <td>${leftItem[1]}</td>
                    <td>${leftPercentage}%</td>
                `;

          // ì˜¤ë¥¸ìª½ ì—´ (ì§ìˆ˜ ìˆœìœ„: 2, 4, 6...)
          if (i + 1 < wordList.length) {
            const rightItem = wordList[i + 1];
            const rightPercentage = ((rightItem[1] / total) * 100).toFixed(1);
            rowHtml += `
                        <td style="border-left: 2px solid #ddd;">${i + 2}</td>
                        <td><strong>${rightItem[0]}</strong></td>
                        <td>${rightItem[1]}</td>
                        <td>${rightPercentage}%</td>
                    `;
          } else {
            rowHtml += `<td style="border-left: 2px solid #ddd;"></td><td></td><td></td><td></td>`;
          }

          tr.innerHTML = rowHtml;
          tbody.appendChild(tr);
        }
      }

      function createFrequencyChart(wordList) {
        const canvas = document.getElementById("frequency-chart");
        if (!canvas) return;

        const ctx = canvas.getContext("2d");

        if (window.frequencyChart) {
          window.frequencyChart.destroy();
        }

        if (wordList.length === 0) return;

        window.frequencyChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: wordList.map(([word]) => word),
            datasets: [
              {
                label: "ë¹ˆë„",
                data: wordList.map(([_, freq]) => freq),
                backgroundColor: "rgba(102, 126, 234, 0.6)",
                borderColor: "rgba(102, 126, 234, 1)",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: `ìƒìœ„ ${wordList.length}ê°œ ë‹¨ì–´ ë¹ˆë„`,
                font: { size: 18 },
              },
              legend: { display: false },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1 },
              },
            },
          },
        });
      }

      // ==========================================
      // ë²¡í„° ê³„ì‚° í•¨ìˆ˜ë“¤
      // ==========================================
      function proceedToVector() {
        // window.wordFrequencyê°€ ë¹„ì–´ìˆìœ¼ë©´ ê²½ê³ 
        if (
          !window.wordFrequency ||
          Object.keys(window.wordFrequency).length === 0
        ) {
          alert("ë¨¼ì € í…ìŠ¤íŠ¸ ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
          return;
        }
        createSentenceSelection(); // ë¬¸ì¥ ì„ íƒ UI ìƒì„±
        createWordSelection();
        document.getElementById("tab-btn-vector").disabled = false;
        switchTab("vector");
      }

      // ==========================================
      // ë¬¸ì¥ ì„ íƒ ê¸°ëŠ¥
      // ==========================================
      function createSentenceSelection() {
        const container = document.getElementById("sentence-selection");
        container.innerHTML = "";

        if (allSentences.length === 0) {
          container.innerHTML =
            '<p style="color: #999; text-align: center;">ë¶„ì„í•  ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        // ê¸°ë³¸ê°’: ì „ì²´ ì„ íƒ
        selectedSentences = [...allSentences];

        allSentences.forEach((sentence, index) => {
          const item = document.createElement("div");
          item.className = "sentence-item selected";
          item.dataset.index = index;
          item.innerHTML = `
                    <span class="sentence-number">ë¬¸ì¥ ${index + 1}</span>
                    <span class="sentence-text">${sentence}</span>
                `;
          item.addEventListener("click", () => toggleSentence(item, index));
          container.appendChild(item);
        });

        updateSelectedSentenceCount();
      }

      function toggleSentence(item, index) {
        item.classList.toggle("selected");

        if (item.classList.contains("selected")) {
          if (!selectedSentences.includes(allSentences[index])) {
            selectedSentences.push(allSentences[index]);
          }
        } else {
          selectedSentences = selectedSentences.filter(
            (s) => s !== allSentences[index],
          );
        }

        updateSelectedSentenceCount();
      }

      function selectAllSentences() {
        const items = document.querySelectorAll(".sentence-item");
        items.forEach((item) => item.classList.add("selected"));
        selectedSentences = [...allSentences];
        updateSelectedSentenceCount();
      }

      function deselectAllSentences() {
        const items = document.querySelectorAll(".sentence-item");
        items.forEach((item) => item.classList.remove("selected"));
        selectedSentences = [];
        updateSelectedSentenceCount();
      }

      function updateSelectedSentenceCount() {
        const countEl = document.getElementById("selected-sentence-count");
        if (countEl) {
          countEl.textContent = `${selectedSentences.length}ê°œ ì„ íƒë¨`;
        }
      }

      function getSelectedSentencesForAnalysis() {
        // ì„ íƒëœ ë¬¸ì¥ì´ ì—†ìœ¼ë©´ ì „ì²´ ì‚¬ìš©
        return selectedSentences.length > 0 ? selectedSentences : allSentences;
      }

      function createWordSelection() {
        const container = document.getElementById("word-selection");
        container.innerHTML = "";

        // wordFrequency ì²´í¬
        if (!wordFrequency || Object.keys(wordFrequency).length === 0) {
          container.innerHTML =
            '<p style="color: #999; text-align: center;">ë¶„ì„ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í…ìŠ¤íŠ¸ ë¶„ì„ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.</p>';
          return;
        }

        const sortedWords = Object.entries(wordFrequency)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 30);

        if (sortedWords.length === 0) {
          container.innerHTML =
            '<p style="color: #999; text-align: center;">ë¶„ì„ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        sortedWords.forEach(([word, freq]) => {
          const label = document.createElement("label");
          label.className = "word-checkbox";
          label.innerHTML = `
                    <input type="checkbox" value="${word}">
                    <span>${word} (${freq}íšŒ)</span>
                `;
          container.appendChild(label);
        });

        console.log("ë‹¨ì–´ ì„ íƒ UI ìƒì„± ì™„ë£Œ:", sortedWords.length, "ê°œ ë‹¨ì–´");
      }

      function autoSelectWords() {
        const checkboxes = document.querySelectorAll(
          '#word-selection input[type="checkbox"]',
        );
        if (checkboxes.length === 0) {
          alert("ë‹¨ì–´ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í…ìŠ¤íŠ¸ ë¶„ì„ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.");
          return;
        }
        checkboxes.forEach((cb, index) => {
          cb.checked = index < 10;
        });
        console.log("ìƒìœ„ 10ê°œ ë‹¨ì–´ ìë™ ì„ íƒ ì™„ë£Œ");
      }

      function clearWordSelection() {
        const checkboxes = document.querySelectorAll(
          '#word-selection input[type="checkbox"]',
        );
        checkboxes.forEach((cb) => (cb.checked = false));
      }

      function calculateSimilarity() {
        // ì„ íƒëœ ë¬¸ì¥ ì²´í¬
        const sentencesToAnalyze = getSelectedSentencesForAnalysis();
        if (sentencesToAnalyze.length < 2) {
          alert("ìµœì†Œ 2ê°œ ì´ìƒì˜ ë¬¸ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const checkboxes = document.querySelectorAll(
          '#word-selection input[type="checkbox"]:checked',
        );
        selectedWords = Array.from(checkboxes).map((cb) => cb.value);

        if (selectedWords.length < 2) {
          alert("ìµœì†Œ 2ê°œ ì´ìƒì˜ ë‹¨ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const matrix = createTermMatrix();
        displayMatrix(matrix);

        const similarities = computeCosineSimilarity(matrix);

        // ì œëª© ë³€ê²½
        document.getElementById("similarity-title").textContent =
          "ğŸ¯ ê°€ì¥ ë¹„ìŠ·í•œ ë¬¸ì¥ ì°¾ê¸° (ì½”ì‚¬ì¸ ìœ ì‚¬ë„)";

        displaySimilarityResults(similarities, "cosine");
        createHeatmap(similarities, "cosine");
        visualizeVectors(matrix);

        document
          .getElementById("similarity-section")
          .classList.remove("hidden");
      }

      function createTermMatrix() {
        const matrix = [];
        const sentencesToAnalyze = getSelectedSentencesForAnalysis();

        for (const sentence of sentencesToAnalyze) {
          const row = [];
          const words = tokenizeKorean(sentence);

          selectedWords.forEach((word) => {
            const count = words.filter((w) => w === word).length;
            row.push(count);
          });

          matrix.push(row);
        }

        return matrix;
      }

      function displayMatrix(matrix) {
        const container = document.getElementById("matrix-display");

        let html = "<table><thead><tr><th>ë¬¸ì¥</th>";
        selectedWords.forEach((word) => {
          html += `<th>${word}</th>`;
        });
        html += "</tr></thead><tbody>";

        matrix.forEach((row, i) => {
          html += `<tr><th>ë¬¸ì¥ ${i + 1}</th>`;
          row.forEach((val) => {
            html += `<td>${val}</td>`;
          });
          html += "</tr>";
        });

        html += "</tbody></table>";
        container.innerHTML = html;
      }

      function computeCosineSimilarity(matrix) {
        const n = matrix.length;
        const similarities = Array(n)
          .fill(0)
          .map(() => Array(n).fill(0));

        for (let i = 0; i < n; i++) {
          for (let j = 0; j < n; j++) {
            similarities[i][j] =
              i === j ? 1.0 : cosineSimilarity(matrix[i], matrix[j]);
          }
        }

        return similarities;
      }

      function cosineSimilarity(vec1, vec2) {
        let dotProduct = 0,
          mag1 = 0,
          mag2 = 0;

        for (let i = 0; i < vec1.length; i++) {
          dotProduct += vec1[i] * vec2[i];
          mag1 += vec1[i] * vec1[i];
          mag2 += vec2[i] * vec2[i];
        }

        mag1 = Math.sqrt(mag1);
        mag2 = Math.sqrt(mag2);

        if (mag1 === 0 || mag2 === 0) return 0;
        return dotProduct / (mag1 * mag2);
      }

      // ìœ í´ë¦¬ë“œ ê±°ë¦¬ ê³„ì‚°
      function euclideanDistance(vec1, vec2) {
        let sum = 0;
        for (let i = 0; i < vec1.length; i++) {
          sum += Math.pow(vec1[i] - vec2[i], 2);
        }
        return Math.sqrt(sum);
      }

      // ìœ í´ë¦¬ë“œ ê±°ë¦¬ í–‰ë ¬ ê³„ì‚° (ê±°ë¦¬ ê·¸ëŒ€ë¡œ ë°˜í™˜, 0ì´ ê°€ì¥ ìœ ì‚¬)
      function computeEuclideanDistance(matrix) {
        const n = matrix.length;
        const distances = Array(n)
          .fill(0)
          .map(() => Array(n).fill(0));

        for (let i = 0; i < n; i++) {
          for (let j = 0; j < n; j++) {
            if (i === j) {
              distances[i][j] = 0; // ìê¸° ìì‹ ê³¼ì˜ ê±°ë¦¬ëŠ” 0
            } else {
              distances[i][j] = euclideanDistance(matrix[i], matrix[j]);
            }
          }
        }

        return distances;
      }

      // ìœ í´ë¦¬ë“œ ê±°ë¦¬ ê³„ì‚° ì‹¤í–‰
      function calculateEuclideanSimilarity() {
        // ì„ íƒëœ ë¬¸ì¥ ì²´í¬
        const sentencesToAnalyze = getSelectedSentencesForAnalysis();
        if (sentencesToAnalyze.length < 2) {
          alert("ìµœì†Œ 2ê°œ ì´ìƒì˜ ë¬¸ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const checkboxes = document.querySelectorAll(
          '#word-selection input[type="checkbox"]:checked',
        );
        selectedWords = Array.from(checkboxes).map((cb) => cb.value);

        if (selectedWords.length < 2) {
          alert("ìµœì†Œ 2ê°œ ì´ìƒì˜ ë‹¨ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const matrix = createTermMatrix();
        displayMatrix(matrix);

        const distances = computeEuclideanDistance(matrix);

        // ì œëª© ë³€ê²½
        document.getElementById("similarity-title").textContent =
          "ğŸ¯ ê°€ì¥ ë¹„ìŠ·í•œ ë¬¸ì¥ ì°¾ê¸° (ìœ í´ë¦¬ë“œ ê±°ë¦¬)";

        displaySimilarityResults(distances, "euclidean");
        createHeatmap(distances, "euclidean");
        visualizeVectors(matrix);

        document
          .getElementById("similarity-section")
          .classList.remove("hidden");
      }

      function displaySimilarityResults(values, similarityType) {
        const container = document.getElementById("similarity-results");
        container.innerHTML = "";

        const sentencesToAnalyze = getSelectedSentencesForAnalysis();
        const isEuclidean = similarityType === "euclidean";
        const typeLabel = isEuclidean ? "ìœ í´ë¦¬ë“œ ê±°ë¦¬" : "ì½”ì‚¬ì¸ ìœ ì‚¬ë„";

        sentencesToAnalyze.forEach((sentence, i) => {
          const scores = values[i]
            .map((score, j) => ({ index: j, score: score }))
            .filter((item) => item.index !== i);

          // ìœ í´ë¦¬ë“œ: ì˜¤ë¦„ì°¨ìˆœ (ì‘ì„ìˆ˜ë¡ ìœ ì‚¬), ì½”ì‚¬ì¸: ë‚´ë¦¼ì°¨ìˆœ (í´ìˆ˜ë¡ ìœ ì‚¬)
          if (isEuclidean) {
            scores.sort((a, b) => a.score - b.score);
          } else {
            scores.sort((a, b) => b.score - a.score);
          }

          const mostSimilar = scores[0];

          // ê°’ í‘œì‹œ í˜•ì‹
          const displayValue = isEuclidean
            ? mostSimilar.score.toFixed(2) // ê±°ë¦¬ëŠ” ì†Œìˆ˜ì  2ìë¦¬
            : mostSimilar.score.toFixed(4); // ìœ ì‚¬ë„ëŠ” ì†Œìˆ˜ì  4ìë¦¬

          const card = document.createElement("div");
          card.className = "similarity-card";
          card.innerHTML = `
                    <h4>ë¬¸ì¥ ${i + 1}:</h4>
                    <p>"${sentence}"</p>
                    <br>
                    <p><strong>ê°€ì¥ ë¹„ìŠ·í•œ ë¬¸ì¥:</strong> ë¬¸ì¥ ${mostSimilar.index + 1}</p>
                    <p>"${sentencesToAnalyze[mostSimilar.index]}"</p>
                    <br>
                    <p><strong>${typeLabel}:</strong> <span class="similarity-value">${displayValue}</span></p>
                `;
          container.appendChild(card);
        });
      }

      function createHeatmap(values, similarityType) {
        const canvas = document.getElementById("heatmap-canvas");
        const ctx = canvas.getContext("2d");

        const n = values.length;
        const cellSize = Math.min(600 / n, 50);
        const labelSize = 60;
        const isEuclidean = similarityType === "euclidean";

        canvas.width = cellSize * n + labelSize;
        canvas.height = cellSize * n + labelSize;

        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ìœ í´ë¦¬ë“œ ê±°ë¦¬ì˜ ê²½ìš° ìµœëŒ€ê°’ ì°¾ê¸° (ì •ê·œí™”ìš©)
        let maxVal = 1;
        if (isEuclidean) {
          for (let i = 0; i < n; i++) {
            for (let j = 0; j < n; j++) {
              if (values[i][j] > maxVal) maxVal = values[i][j];
            }
          }
        }

        for (let i = 0; i < n; i++) {
          for (let j = 0; j < n; j++) {
            const value = values[i][j];
            let intensity;

            if (isEuclidean) {
              // ìœ í´ë¦¬ë“œ: ê±°ë¦¬ê°€ ì‘ì„ìˆ˜ë¡ ì§„í•œ íŒŒë€ìƒ‰ (0=ì§„í•¨, max=ì—°í•¨)
              const normalized = maxVal > 0 ? value / maxVal : 0;
              intensity = Math.floor((1 - normalized) * 255);
            } else {
              // ì½”ì‚¬ì¸: ìœ ì‚¬ë„ê°€ í´ìˆ˜ë¡ ì§„í•œ íŒŒë€ìƒ‰ (1=ì§„í•¨, 0=ì—°í•¨)
              intensity = Math.floor(value * 255);
            }

            ctx.fillStyle = `rgb(${255 - intensity}, ${255 - intensity}, 255)`;
            ctx.fillRect(
              j * cellSize + labelSize,
              i * cellSize + labelSize,
              cellSize,
              cellSize,
            );

            ctx.strokeStyle = "#ddd";
            ctx.strokeRect(
              j * cellSize + labelSize,
              i * cellSize + labelSize,
              cellSize,
              cellSize,
            );

            // cellSizeì— ë§ì¶° í°íŠ¸ í¬ê¸° ìë™ ì¡°ì •
            if (cellSize > 15) {
              // 30 â†’ 15ë¡œ ë‚®ì¶¤ (ë” ì‘ì€ ì…€ì—ë„ ìˆ«ì í‘œì‹œ)
              // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê²°ì •
              ctx.fillStyle = intensity > 127 ? "white" : "black";

              // cellSizeì— ë¹„ë¡€í•œ í°íŠ¸ í¬ê¸° (ìµœì†Œ 8px, ìµœëŒ€ 14px)
              const fontSize = Math.max(
                8,
                Math.min(14, Math.floor(cellSize * 0.35)),
              );
              ctx.font = `${fontSize}px "Roboto Mono", "SF Mono", Consolas, monospace`;
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";

              // ì…€ì´ ì‘ìœ¼ë©´ ì†Œìˆ˜ì  1ìë¦¬, í¬ë©´ 2ìë¦¬
              const decimals = cellSize > 35 ? 2 : 1;
              ctx.fillText(
                value.toFixed(decimals),
                j * cellSize + labelSize + cellSize / 2,
                i * cellSize + labelSize + cellSize / 2,
              );
            }
          }
        }

        // ì™¼ìª½ ì¸ë±ìŠ¤ ë°°ê²½ (ì—°í•œ íšŒìƒ‰)
        ctx.fillStyle = "#f5f5f5";
        ctx.fillRect(0, labelSize, labelSize, cellSize * n);

        // ìƒë‹¨ ì¸ë±ìŠ¤ ë°°ê²½ (ì—°í•œ íšŒìƒ‰)
        ctx.fillRect(labelSize, 0, cellSize * n, labelSize);

        // ì™¼ìª½ ì¸ë±ìŠ¤ ë ˆì´ë¸”
        ctx.fillStyle = "#1e3a5f";
        ctx.font = 'bold 14px "Roboto Mono", "SF Mono", Consolas, sans-serif';
        ctx.textAlign = "right";
        for (let i = 0; i < n; i++) {
          ctx.fillText(
            `ë¬¸ì¥ ${i + 1}`,
            labelSize - 10,
            i * cellSize + labelSize + cellSize / 2,
          );
        }

        // ìƒë‹¨ ì¸ë±ìŠ¤ ë ˆì´ë¸”
        ctx.save();
        ctx.textAlign = "left";
        for (let j = 0; j < n; j++) {
          ctx.save();
          ctx.translate(
            j * cellSize + labelSize + cellSize / 2,
            labelSize - 10,
          );
          ctx.rotate(-Math.PI / 4);
          ctx.fillText(`ë¬¸ì¥ ${j + 1}`, 0, 0);
          ctx.restore();
        }
        ctx.restore();
      }

      function visualizeVectors(matrix) {
        const canvas = document.getElementById("vector-chart");
        if (!canvas) return;

        const ctx = canvas.getContext("2d");

        if (window.vectorChart) window.vectorChart.destroy();

        const words = selectedWords.slice(0, 5);
        if (words.length === 0) return;

        const datasets = words.map((word, idx) => {
          const colors = [
            "#1e3a5f",
            "#c9a227",
            "#2d5a87",
            "#5a8f7b",
            "#8b5a5a",
          ];
          const wordIdx = selectedWords.indexOf(word);
          const frequencies = matrix.map((row) => row[wordIdx] || 0);

          return {
            label: word,
            data: frequencies,
            backgroundColor: colors[idx % colors.length] + "80",
            borderColor: colors[idx % colors.length],
            borderWidth: 2,
          };
        });

        const labels = allSentences.map((_, idx) => `ë¬¸ì¥ ${idx + 1}`);

        window.vectorChart = new Chart(ctx, {
          type: "bar",
          data: { labels: labels, datasets: datasets },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              title: {
                display: true,
                text: "ì„ íƒí•œ ë‹¨ì–´ê°€ ê° ë¬¸ì¥ì—ì„œ ë‚˜íƒ€ë‚œ íšŸìˆ˜",
                font: { size: 18, family: "Noto Sans KR" },
              },
              legend: { display: true, position: "top" },
            },
            scales: {
              y: { beginAtZero: true, ticks: { stepSize: 1 } },
            },
          },
        });
      }

      function downloadResults() {
        html2canvas(document.querySelector(".container")).then((canvas) => {
          const link = document.createElement("a");
          link.download = "text-mining-results.png";
          link.href = canvas.toDataURL();
          link.click();
        });
      }

      // ==========================================
      // íƒ­ ì „í™˜ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
      // ==========================================
      function switchTab(tabName) {
        // ì´ì „ í™œì„± íƒ­ í™•ì¸ (ìŠ¤í¬ë¡¤ ë™ì‘ ê²°ì •ìš©)
        const previousActiveTab = document
          .querySelector(".tab.active")
          ?.id.replace("tab-btn-", "");

        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach((c) => {
          c.classList.remove("active");
          c.style.display = "none";
        });

        const selectedTabBtn = document.getElementById(`tab-btn-${tabName}`);
        if (selectedTabBtn) selectedTabBtn.classList.add("active");

        const selectedContent = document.getElementById(`tab-${tabName}`);
        if (selectedContent) {
          selectedContent.classList.add("active");
          selectedContent.style.display = "block";
        }

        // íƒ­ ë„¤ë¹„ê²Œì´ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        const tabNavigation = document.getElementById("tab-navigation");
        if (tabNavigation) {
          // í…ìŠ¤íŠ¸ ë¶„ì„ íƒ­ì—ì„œ í˜•íƒœì†Œ ë¶„ë¦¬ íƒ­ìœ¼ë¡œ ì´ë™í•  ë•Œë§Œ í•˜ë‹¨ ë²„íŠ¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
          if (tabName === "morpheme" && previousActiveTab === "analysis") {
            // ë¨¼ì € íƒ­ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
            const tabTop =
              tabNavigation.getBoundingClientRect().top +
              window.pageYOffset -
              100;
            window.scrollTo({ top: tabTop, behavior: "smooth" });

            // ì¶©ë¶„í•œ ì§€ì—° í›„ í•˜ë‹¨ ë²„íŠ¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            setTimeout(() => {
              const bottomButtons = document.getElementById(
                "morpheme-bottom-buttons",
              );
              if (bottomButtons) {
                // í•˜ë‹¨ ë²„íŠ¼ì´ í™”ë©´ì— ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤
                bottomButtons.scrollIntoView({
                  behavior: "smooth",
                  block: "center", // í™”ë©´ ì¤‘ì•™ì— ìœ„ì¹˜
                });

                // í•˜ë‹¨ ë²„íŠ¼ë“¤ ê°•ì¡° (í„ìŠ¤ íš¨ê³¼)
                setTimeout(() => {
                  const buttons = bottomButtons.querySelectorAll("button");
                  buttons.forEach((btn) => {
                    btn.style.animation = "none";
                    setTimeout(() => {
                      btn.style.animation = "pulse 0.6s ease-in-out 3";
                    }, 10);
                  });
                }, 200);
              }
            }, 600); // 300ms â†’ 600msë¡œ ì¦ê°€
          } else {
            // ë‹¤ë¥¸ ê²½ìš°ëŠ” íƒ­ ë²„íŠ¼ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
            const tabTop =
              tabNavigation.getBoundingClientRect().top +
              window.pageYOffset -
              100;
            window.scrollTo({ top: tabTop, behavior: "smooth" });
          }

          // ì„ íƒëœ íƒ­ ë²„íŠ¼ ê°•ì¡° (í„ìŠ¤ íš¨ê³¼)
          // ë‹¨, í…ìŠ¤íŠ¸ ë¶„ì„ íƒ­ì—ì„œ í˜•íƒœì†Œ ë¶„ë¦¬ íƒ­ìœ¼ë¡œ ì´ë™í•˜ëŠ” ê²½ìš°ëŠ” ì œì™¸ (í•˜ë‹¨ ë²„íŠ¼ë§Œ ê°•ì¡°)
          if (
            selectedTabBtn &&
            !(tabName === "morpheme" && previousActiveTab === "analysis")
          ) {
            selectedTabBtn.style.animation = "none";
            setTimeout(() => {
              selectedTabBtn.style.animation = "pulse 0.5s ease-in-out 2";
            }, 10);
          }
        }
      }

      // ==========================================
      // ë¸Œë¼ìš°ì € ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ì²˜ë¦¬
      // ==========================================
      let resizeTimeout;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          const currentWords = window.currentWordList;
          if (
            currentWords &&
            currentWords.length > 0 &&
            document.getElementById("tab-analysis").classList.contains("active")
          ) {
            createWordCloud(currentWords);
          }
        }, 500);
      });

      // ==========================================
      // ì›¹ í°íŠ¸ ë¡œë”© ëŒ€ê¸°
      // ==========================================
      if (document.fonts) {
        document.fonts.ready.then(() => {
          console.log("âœ… ì›¹ í°íŠ¸ ë¡œë”© ì™„ë£Œ");
        });
      }

      // ==========================================
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ì¤‘ë³µ ì œê±°, onclick ëŒ€ì‹  addEventListener ì‚¬ìš©)
      // ==========================================
      function initializeApp() {
        // ì—­í•  ì„ íƒ
        document.querySelectorAll(".role-card").forEach((card) => {
          card.addEventListener("click", () => selectRole(card.dataset.role));
        });

        // íƒ­ ì „í™˜
        document
          .getElementById("tab-btn-collection")
          ?.addEventListener("click", () => switchTab("collection"));
        document
          .getElementById("tab-btn-analysis")
          ?.addEventListener("click", () => switchTab("analysis"));
        document
          .getElementById("tab-btn-vector")
          ?.addEventListener("click", () => switchTab("vector"));

        // ì„ ìƒë‹˜ ê¸°ëŠ¥
        document
          .getElementById("copy-room-code-btn")
          ?.addEventListener("click", copyRoomCode);
        document
          .getElementById("copy-room-url-btn")
          ?.addEventListener("click", copyRoomURL);
        document
          .getElementById("close-input-btn")
          ?.addEventListener("click", closeInput);
        document
          .getElementById("start-analysis-btn")
          ?.addEventListener("click", startAnalysis);

        // í•™ìƒ ê¸°ëŠ¥
        document
          .getElementById("join-room-btn")
          ?.addEventListener("click", joinRoom);
        document
          .getElementById("set-nickname-btn")
          ?.addEventListener("click", setNickname);
        document
          .getElementById("submit-sentences-btn")
          ?.addEventListener("click", submitSentences);
        document
          .getElementById("view-analysis-student-btn")
          ?.addEventListener("click", viewAnalysisAsStudent);

        // ì²´í—˜ ëª¨ë“œ
        document
          .getElementById("start-demo-btn")
          ?.addEventListener("click", startDemoAnalysis);

        // ë¶„ì„ íƒ­ - shape ì„ íƒ
        document
          .querySelectorAll(".shape-option:not(.font-option)")
          .forEach((btn) => {
            btn.addEventListener("click", () => selectShape(btn.dataset.shape));
          });

        // ë¶„ì„ íƒ­ - font ì„ íƒ
        document.querySelectorAll(".font-option").forEach((btn) => {
          btn.addEventListener("click", () => selectFont(btn.dataset.font));
        });

        document
          .getElementById("stopwords-toggle")
          ?.addEventListener("change", analyzeText);
        document
          .getElementById("proceed-vector-btn")
          ?.addEventListener("click", proceedToVector);

        // ë²¡í„° íƒ­
        document
          .getElementById("select-all-sentences-btn")
          ?.addEventListener("click", selectAllSentences);
        document
          .getElementById("deselect-all-sentences-btn")
          ?.addEventListener("click", deselectAllSentences);
        document
          .getElementById("auto-select-btn")
          ?.addEventListener("click", autoSelectWords);
        document
          .getElementById("clear-selection-btn")
          ?.addEventListener("click", clearWordSelection);
        document
          .getElementById("calc-similarity-btn")
          ?.addEventListener("click", calculateSimilarity);
        document
          .getElementById("calc-euclidean-btn")
          ?.addEventListener("click", calculateEuclideanSimilarity);
        document
          .getElementById("download-btn")
          ?.addEventListener("click", downloadResults);
      }

      // URL íŒŒë¼ë¯¸í„° ìë™ ë°© ì…ì¥ (Firebase ì¤€ë¹„ í›„ ì‹¤í–‰)
      function handleUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get("room");
        if (roomCode) {
          selectRole("student");
          document.getElementById("room-code-input").value =
            roomCode.toUpperCase();
          setTimeout(() => joinRoom(), 100);
        }
      }

      // DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      document.addEventListener("DOMContentLoaded", () => {
        initializeApp();

        // Firebaseê°€ ì´ë¯¸ ì¤€ë¹„ë˜ì—ˆìœ¼ë©´ ë°”ë¡œ ì‹¤í–‰, ì•„ë‹ˆë©´ ëŒ€ê¸°
        if (window.firebaseReady) {
          handleUrlParams();
        } else {
          window.addEventListener("firebaseReady", handleUrlParams);
        }
      });
    </script>
  </body>
</html>
