<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¨ì–´ì‡ê¸° - AI ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans KR', sans-serif;
        }
        h1, h2, h3, .title-font {
            font-family: 'Do Hyeon', sans-serif;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        @keyframes celebrate {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1.2) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 30px rgba(59, 130, 246, 0.6); }
        }
        
        @keyframes comboEffect {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(1); opacity: 0; }
        }
        
        .animate-slideDown {
            animation: slideDown 0.3s ease;
        }
        
        .animate-pulse-custom {
            animation: pulse 1s ease-in-out infinite;
        }
        
        .animate-bounce {
            animation: bounce 0.5s ease;
        }
        
        .animate-shake {
            animation: shake 0.5s ease;
        }
        
        .animate-celebrate {
            animation: celebrate 0.6s ease;
        }
        
        .animate-glow {
            animation: glow 1.5s ease-in-out infinite;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .combo-burst {
            position: absolute;
            font-size: 3rem;
            font-weight: bold;
            color: #f59e0b;
            pointer-events: none;
            animation: comboEffect 1s ease-out forwards;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 1.5rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-400 via-cyan-400 to-teal-400 min-h-screen">
    
    <!-- ì‹œì‘ í™”ë©´ -->
    <div id="startScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full">
            <h1 class="title-font text-6xl text-center text-gray-800 mb-8">ğŸ”— ë‹¨ì–´ì‡ê¸°</h1>
            <p class="text-center text-gray-600 text-lg mb-6">AI ì½”ì‚¬ì¸ ìœ ì‚¬ë„ë¡œ ë‹¨ì–´ë¥¼ ì—°ê²°í•˜ì„¸ìš”!</p>
            
            <!-- ì„¤ëª… ë³´ê¸° ë²„íŠ¼ -->
            <div class="text-center mb-8">
                <button onclick="showInfoModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl transition-all transform hover:scale-105 text-lg">
                    ğŸ“– ì½”ì‚¬ì¸ ìœ ì‚¬ë„ë€? / ê²Œì„ ë°©ë²•
                </button>
                <button onclick="showStatsModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl transition-all transform hover:scale-105 text-lg ml-2">
                    ğŸ“Š í†µê³„ ë³´ê¸°
                </button>
            </div>
            
            <!-- ë‚œì´ë„ ì„ íƒ -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">ë‚œì´ë„ ì„ íƒ</h2>
                <div class="grid grid-cols-3 gap-4">
                    <label class="cursor-pointer">
                        <input type="radio" name="difficulty" value="easy" checked class="peer hidden">
                        <div class="p-4 border-2 border-gray-300 rounded-xl text-center transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:shadow-lg hover:shadow-md">
                            <div class="text-3xl mb-2">ğŸ˜Š</div>
                            <div class="font-bold text-gray-700">ì‰¬ì›€</div>
                            <div class="text-sm text-gray-500 mt-1">60ì  ì´ìƒ</div>
                        </div>
                    </label>
                    
                    <label class="cursor-pointer">
                        <input type="radio" name="difficulty" value="medium" class="peer hidden">
                        <div class="p-4 border-2 border-gray-300 rounded-xl text-center transition-all peer-checked:border-yellow-500 peer-checked:bg-yellow-50 peer-checked:shadow-lg hover:shadow-md">
                            <div class="text-3xl mb-2">ğŸ¤”</div>
                            <div class="font-bold text-gray-700">ì¤‘ê°„</div>
                            <div class="text-sm text-gray-500 mt-1">70ì  ì´ìƒ</div>
                        </div>
                    </label>
                    
                    <label class="cursor-pointer">
                        <input type="radio" name="difficulty" value="hard" class="peer hidden">
                        <div class="p-4 border-2 border-gray-300 rounded-xl text-center transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:shadow-lg hover:shadow-md">
                            <div class="text-3xl mb-2">ğŸ”¥</div>
                            <div class="font-bold text-gray-700">ì–´ë ¤ì›€</div>
                            <div class="text-sm text-gray-500 mt-1">80ì  ì´ìƒ</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- ì´ë¦„ ì…ë ¥ -->
            <div class="mb-8">
                <label class="block text-gray-700 font-bold mb-2 text-center">í”Œë ˆì´ì–´ ì´ë¦„</label>
                <input type="text" id="playerName" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none text-center text-lg" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20">
            </div>
            
            <!-- ì‹œì‘ ë²„íŠ¼ -->
            <button onclick="startGame()" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all transform hover:scale-105 shadow-lg">
                ğŸ® ê²Œì„ ì‹œì‘
            </button>
        </div>
    </div>
    
    <!-- ê²Œì„ í™”ë©´ -->
    <div id="gameScreen" style="display: none;" class="min-h-screen p-4">
        <div class="max-w-4xl mx-auto">
            <!-- ìƒë‹¨ ì •ë³´ -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
                <div class="grid grid-cols-3 gap-4">
                    <!-- ì ìˆ˜ -->
                    <div class="text-center">
                        <div class="text-gray-600 mb-1">ì ìˆ˜</div>
                        <div id="score" class="text-3xl font-bold text-blue-600">0</div>
                    </div>
                    
                    <!-- ì‹œê°„ -->
                    <div class="text-center">
                        <div class="text-gray-600 mb-1">ì‹œê°„</div>
                        <div id="timer" class="text-3xl font-bold text-red-600">60</div>
                    </div>
                    
                    <!-- ì½¤ë³´ -->
                    <div id="comboBox" class="text-center">
                        <div class="text-gray-600 mb-1">ì½¤ë³´</div>
                        <div id="currentCombo" class="text-3xl font-bold text-yellow-600">0</div>
                    </div>
                </div>
            </div>
            
            <!-- í˜„ì¬ ë‹¨ì–´ -->
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-4">
                <div class="text-center">
                    <div class="text-gray-600 mb-2">í˜„ì¬ ë‹¨ì–´</div>
                    <div id="currentWord" class="text-5xl font-bold text-gray-800 mb-4">ì‹œì‘</div>
                </div>
                
                <!-- ê²°ê³¼ ë©”ì‹œì§€ -->
                <div id="result" class="mb-6" style="display: none;"></div>
                
                <!-- ì…ë ¥ í•„ë“œ -->
                <div class="flex gap-2">
                    <input type="text" id="wordInput" class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none text-lg" placeholder="ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
                    <button id="submitBtn" onclick="submitWord()" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-xl font-bold text-lg transition-all transform hover:scale-105">
                        ì œì¶œ
                    </button>
                </div>
            </div>
            
            <!-- ë‹¨ì–´ ì²´ì¸ -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div class="text-gray-700 font-bold mb-4 text-center">ì—°ê²°ëœ ë‹¨ì–´ë“¤</div>
                <div id="wordChain" class="flex flex-wrap gap-2 max-h-48 overflow-y-auto"></div>
            </div>
        </div>
    </div>
    
    <!-- ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬ -->
    <div id="endGameModal" class="modal">
        <div class="modal-content">
            <h2 class="title-font text-4xl text-center mb-6 text-gray-800">ğŸ‰ ê²Œì„ ì¢…ë£Œ!</h2>
            
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 mb-6">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <div class="text-gray-600 mb-1">ìµœì¢… ì ìˆ˜</div>
                        <div id="finalScore" class="text-3xl font-bold text-blue-600">0</div>
                    </div>
                    <div>
                        <div class="text-gray-600 mb-1">ì—°ê²° ë‹¨ì–´</div>
                        <div id="finalWordCount" class="text-3xl font-bold text-green-600">0</div>
                    </div>
                    <div>
                        <div class="text-gray-600 mb-1">ìµœëŒ€ ì½¤ë³´</div>
                        <div id="finalMaxCombo" class="text-3xl font-bold text-yellow-600">0</div>
                    </div>
                    <div>
                        <div class="text-gray-600 mb-1">í‰ê·  ìœ ì‚¬ë„</div>
                        <div id="finalAvgSimilarity" class="text-3xl font-bold text-purple-600">0</div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="restartGame()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-bold transition-all">
                    ë‹¤ì‹œ í•˜ê¸°
                </button>
                <button onclick="goToHome()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-bold transition-all">
                    í™ˆìœ¼ë¡œ
                </button>
            </div>
        </div>
    </div>
    
    <!-- ì„¤ëª… ëª¨ë‹¬ -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <h2 class="title-font text-3xl text-center mb-6 text-gray-800">ğŸ“– ê²Œì„ ì„¤ëª…</h2>
            
            <div class="space-y-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-xl">
                    <h3 class="font-bold text-lg mb-2 text-blue-800">ğŸ’¡ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ë€?</h3>
                    <p class="text-gray-700">ë‘ ë‹¨ì–´ì˜ ì˜ë¯¸ì  ìœ ì‚¬ì„±ì„ 0~1 ì‚¬ì´ì˜ ê°’ìœ¼ë¡œ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ê°’ì´ 1ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ë‘ ë‹¨ì–´ì˜ ì˜ë¯¸ê°€ ë¹„ìŠ·í•©ë‹ˆë‹¤.</p>
                </div>
                
                <div class="bg-green-50 p-4 rounded-xl">
                    <h3 class="font-bold text-lg mb-2 text-green-800">ğŸ® ê²Œì„ ë°©ë²•</h3>
                    <ul class="text-gray-700 space-y-1">
                        <li>â€¢ í˜„ì¬ ë‹¨ì–´ì™€ <strong>ì˜ë¯¸ìƒ ìœ ì‚¬í•œ ëª…ì‚¬</strong>ë¥¼ ì…ë ¥í•˜ì„¸ìš”</li>
                        <li>â€¢ ìœ ì‚¬ë„ ì ìˆ˜ê°€ ë‚œì´ë„ ê¸°ì¤€ ì´ìƒì´ë©´ ì„±ê³µ!</li>
                        <li>â€¢ 60ì´ˆ ì•ˆì— ìµœëŒ€í•œ ë§ì€ ë‹¨ì–´ë¥¼ ì—°ê²°í•˜ì„¸ìš”</li>
                        <li>â€¢ ì—°ì† ì„±ê³µ ì‹œ ì½¤ë³´ ë³´ë„ˆìŠ¤ ì‹œê°„ +5ì´ˆ!</li>
                    </ul>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-xl">
                    <h3 class="font-bold text-lg mb-2 text-yellow-800">ğŸ¯ ì ìˆ˜ ì‹œìŠ¤í…œ</h3>
                    <ul class="text-gray-700 space-y-1">
                        <li>â€¢ 60~69ì : ê¸°ë³¸ +10ì </li>
                        <li>â€¢ 70~79ì : +15ì </li>
                        <li>â€¢ 80~89ì : +20ì </li>
                        <li>â€¢ 90ì  ì´ìƒ: +30ì </li>
                        <li>â€¢ 3ì½¤ë³´ ì´ìƒ: ì‹œê°„ +5ì´ˆ ë³´ë„ˆìŠ¤!</li>
                    </ul>
                </div>
            </div>
            
            <button onclick="closeInfoModal()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-bold transition-all">
                í™•ì¸
            </button>
        </div>
    </div>
    
    <!-- í†µê³„ ëª¨ë‹¬ -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <h2 class="title-font text-3xl text-center mb-6 text-gray-800">ğŸ“Š í†µê³„</h2>
            
            <div class="mb-4">
                <div class="flex justify-center gap-2 mb-4">
                    <button onclick="loadStats('easy')" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-all">ì‰¬ì›€</button>
                    <button onclick="loadStats('medium')" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-all">ì¤‘ê°„</button>
                    <button onclick="loadStats('hard')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">ì–´ë ¤ì›€</button>
                </div>
            </div>
            
            <div id="statsContent" class="mb-6 max-h-96 overflow-y-auto">
                <p class="text-center text-gray-500">ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
            </div>
            
            <button onclick="closeStatsModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-bold transition-all">
                ë‹«ê¸°
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // Firebase ì´ˆê¸°í™”
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCqCUBuYr3cDTQLYYxqW4J2CjOCxGo7oHs",
            authDomain: "galluadb.firebaseapp.com",
            databaseURL: "https://galluadb-default-rtdb.firebaseio.com",
            projectId: "galluadb",
            storageBucket: "galluadb.firebasestorage.app",
            messagingSenderId: "672000720701",
            appId: "1:672000720701:web:edc25a3e5e9e1c2e5b1f29",
            measurementId: "G-7WDXDVTX7M"
        };

        let database = null;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('âœ… Firebase ì—°ê²° ì„±ê³µ');
        } catch (error) {
            console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        }

        // ============================================
        // Worker API URL
        // ============================================
        const WORKER_API_URL = 'https://falling-pond-1450.tjdgus1121.workers.dev/';

        // ============================================
        // ê²Œì„ ìƒíƒœ
        // ============================================
        let gameState = {
            score: 0,
            currentWord: 'ì‹œì‘',
            currentCombo: 0,
            maxCombo: 0,
            timeLeft: 60,
            wordChain: [],
            similarities: []
        };

        let isGameActive = false;
        let timerInterval = null;
        let selectedDifficulty = 'easy';
        let playerName = '';
        let resultTimeout = null;

        // ============================================
        // ëª¨ë‹¬ ê´€ë¦¬
        // ============================================
        function showInfoModal() {
            document.getElementById('infoModal').style.display = 'block';
        }

        function closeInfoModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        function showStatsModal() {
            document.getElementById('statsModal').style.display = 'block';
        }

        function closeStatsModal() {
            document.getElementById('statsModal').style.display = 'none';
        }

        function showEndGameModal() {
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalWordCount').textContent = gameState.wordChain.length;
            document.getElementById('finalMaxCombo').textContent = gameState.maxCombo;
            document.getElementById('finalAvgSimilarity').textContent = 
                gameState.similarities.length > 0 
                    ? (gameState.similarities.reduce((a,b) => a+b, 0) / gameState.similarities.length).toFixed(4)
                    : '0';
            
            document.getElementById('endGameModal').style.display = 'block';
        }

        // ============================================
        // í†µê³„ ë¡œë“œ
        // ============================================
        function loadStats(difficulty) {
            if (!database) {
                document.getElementById('statsContent').innerHTML = '<p class="text-center text-red-500">Firebaseì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            document.getElementById('statsContent').innerHTML = '<p class="text-center">ë¡œë”© ì¤‘...</p>';
            
            const scoresRef = firebase.database().ref(`scores/${difficulty}`);
            
            scoresRef.orderByChild('score').limitToLast(10).once('value').then((snapshot) => {
                const scores = [];
                snapshot.forEach((child) => {
                    scores.push({
                        ...child.val(),
                        key: child.key
                    });
                });
                
                scores.reverse();
                
                if (scores.length === 0) {
                    document.getElementById('statsContent').innerHTML = '<p class="text-center text-gray-500">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                    return;
                }
                
                let html = '<div class="space-y-2">';
                scores.forEach((score, index) => {
                    const date = new Date(score.timestamp);
                    const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                    
                    let bgColor = 'bg-gray-50';
                    if (index === 0) bgColor = 'bg-yellow-50';
                    else if (index === 1) bgColor = 'bg-gray-100';
                    else if (index === 2) bgColor = 'bg-orange-50';
                    
                    html += `
                        <div class="${bgColor} p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span class="text-xl font-bold">${index + 1}</span>
                                    <span class="font-bold">${score.name}</span>
                                </div>
                                <span class="text-lg font-bold text-blue-600">${score.score}ì </span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">
                                ë‹¨ì–´: ${score.wordCount}ê°œ | ì½¤ë³´: ${score.maxCombo} | í‰ê· : ${score.avgSimilarity} | ${dateStr}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                document.getElementById('statsContent').innerHTML = html;
            }).catch((error) => {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('statsContent').innerHTML = '<p class="text-center text-red-500">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>';
            });
        }

        // ============================================
        // ê²Œì„ ì‹œì‘
        // ============================================
        function startGame() {
            const nameInput = document.getElementById('playerName');
            playerName = nameInput.value.trim();
            
            if (!playerName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
            
            gameState = {
                score: 0,
                currentWord: 'ì‹œì‘',
                currentCombo: 0,
                maxCombo: 0,
                timeLeft: 60,
                wordChain: [],
                similarities: []
            };
            
            isGameActive = true;
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            updateDisplay();
            document.getElementById('score').textContent = '0';
            document.getElementById('timer').textContent = '60';
            document.getElementById('wordChain').innerHTML = '';
            document.getElementById('wordInput').value = '';
            document.getElementById('wordInput').disabled = false;
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('wordInput').focus();
            
            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (!isGameActive) {
                    clearInterval(timerInterval);
                    return;
                }
                
                gameState.timeLeft--;
                document.getElementById('timer').textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        // ============================================
        // ë‹¨ì–´ ì œì¶œ
        // ============================================
        async function submitWord() {
            if (!isGameActive) return;
            
            const input = document.getElementById('wordInput');
            const newWord = input.value.trim();
            
            if (!newWord) {
                showResult('ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
                return;
            }
            
            if (gameState.wordChain.includes(newWord)) {
                showResult('ì´ë¯¸ ì‚¬ìš©í•œ ë‹¨ì–´ì…ë‹ˆë‹¤!', 'error');
                input.value = '';
                return;
            }
            
            input.disabled = true;
            document.getElementById('submitBtn').disabled = true;
            
            showResult('<span class="loading"></span> ìœ ì‚¬ë„ ê³„ì‚°í•˜ëŠ” ì¤‘...', 'loading');
            
            try {
                // Worker API í˜¸ì¶œ
                const response = await fetch(WORKER_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        word1: gameState.currentWord,
                        word2: newWord
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
                }
                
                const data = await response.json();
                
                console.log('Worker ì‘ë‹µ:', data);
                
                // ëª…ì‚¬ ì²´í¬ ì‹¤íŒ¨
                if (!data.isNoun) {
                    showResult(data.message || 'ì˜¬ë°”ë¥¸ ëª…ì‚¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
                    gameState.currentCombo = 0;
                    updateDisplay();
                    input.value = '';
                    input.disabled = false;
                    document.getElementById('submitBtn').disabled = false;
                    input.focus();
                    return;
                }
                
                const score = data.score;
                const similarity = data.similarity;
                
                console.log(`ìœ ì‚¬ë„: ${similarity.toFixed(4)}, ì ìˆ˜: ${score}`);
                
                // ë‚œì´ë„ë³„ ìµœì†Œ ì ìˆ˜
                const minScores = {
                    easy: 60,
                    medium: 70,
                    hard: 80
                };
                
                const minScore = minScores[selectedDifficulty];
                
                if (score >= minScore) {
                    // ì„±ê³µ
                    let pointsGained = 10;
                    if (score >= 90) pointsGained = 30;
                    else if (score >= 80) pointsGained = 20;
                    else if (score >= 70) pointsGained = 15;
                    
                    gameState.score += pointsGained;
                    gameState.currentCombo++;
                    gameState.maxCombo = Math.max(gameState.maxCombo, gameState.currentCombo);
                    gameState.currentWord = newWord;
                    gameState.wordChain.push(newWord);
                    gameState.similarities.push(similarity);
                    
                    document.getElementById('score').textContent = gameState.score;
                    
                    addWordToChain(newWord, true, score);
                    
                    if (gameState.currentCombo >= 3) {
                        gameState.timeLeft = Math.min(gameState.timeLeft + 5, 120);
                        document.getElementById('timer').textContent = gameState.timeLeft;
                        showComboBurst();
                        showResult(`âœ¨ ${score}ì ! +${pointsGained}ì ! ${gameState.currentCombo} ì½¤ë³´! (ì‹œê°„ +5ì´ˆ)`, 'combo');
                    } else {
                        showResult(`âœ… ${score}ì ! +${pointsGained}ì !`, 'success');
                    }
                    
                    updateDisplay();
                } else {
                    // ì‹¤íŒ¨
                    gameState.currentCombo = 0;
                    updateDisplay();
                    showResult(`âŒ ${score}ì  (ìµœì†Œ ${minScore}ì  í•„ìš”)`, 'error');
                }
                
            } catch (error) {
                console.error('API ì˜¤ë¥˜:', error);
                showResult('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                gameState.currentCombo = 0;
                updateDisplay();
            }
            
            input.value = '';
            input.disabled = false;
            document.getElementById('submitBtn').disabled = false;
            input.focus();
        }

        // Enter í‚¤ ì²˜ë¦¬
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('wordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitWord();
                }
            });
        });

        // ============================================
        // UI ì—…ë°ì´íŠ¸
        // ============================================
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            
            if (resultTimeout) {
                clearTimeout(resultTimeout);
                resultTimeout = null;
            }
            
            let bgColor = 'bg-blue-100 text-blue-800';
            if (type === 'success') bgColor = 'bg-green-100 text-green-800';
            else if (type === 'error') bgColor = 'bg-red-100 text-red-800';
            else if (type === 'combo') bgColor = 'bg-yellow-100 text-yellow-800 animate-celebrate';
            else if (type === 'loading') bgColor = 'bg-blue-100 text-blue-800';
            
            resultDiv.className = `mb-6 p-4 rounded-xl text-center font-bold text-lg ${bgColor}`;
            resultDiv.innerHTML = message;
            resultDiv.style.display = 'block';
            
            if (!message.includes('ê³„ì‚°í•˜ëŠ” ì¤‘')) {
                resultTimeout = setTimeout(() => {
                    resultDiv.style.display = 'none';
                    resultTimeout = null;
                }, 3000);
            }
        }

        function showComboBurst() {
            const comboBox = document.getElementById('comboBox');
            const burst = document.createElement('div');
            burst.className = 'combo-burst';
            burst.textContent = '+5ì´ˆ!';
            burst.style.left = '50%';
            burst.style.top = '50%';
            burst.style.transform = 'translate(-50%, -50%)';
            comboBox.style.position = 'relative';
            comboBox.appendChild(burst);
            
            setTimeout(() => burst.remove(), 1000);
        }
        
        function updateDisplay() {
            document.getElementById('currentCombo').textContent = gameState.currentCombo;
            document.getElementById('currentWord').textContent = gameState.currentWord;
            
            // ì½¤ë³´ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            const comboBox = document.getElementById('comboBox');
            if (gameState.currentCombo >= 3) {
                comboBox.classList.add('animate-glow');
            } else {
                comboBox.classList.remove('animate-glow');
            }
        }
        
        function addWordToChain(word, isValid, score) {
            const chain = document.getElementById('wordChain');
            const item = document.createElement('div');
            
            let bgColor = 'bg-gray-100 text-gray-800';
            if (isValid) {
                if (score >= 90) bgColor = 'bg-red-100 text-red-800';
                else if (score >= 80) bgColor = 'bg-orange-100 text-orange-800';
                else if (score >= 70) bgColor = 'bg-yellow-100 text-yellow-800';
                else if (score >= 60) bgColor = 'bg-green-100 text-green-800';
                else bgColor = 'bg-blue-100 text-blue-800';
            }
            
            item.className = `px-4 py-2 rounded-lg font-bold ${bgColor} animate-slideDown`;
            item.innerHTML = `${word}<span class="text-xs ml-1">(${score})</span>`;
            chain.appendChild(item);
            
            // ìŠ¤í¬ë¡¤
            chain.scrollTop = chain.scrollHeight;
        }
        
        // ============================================
        // ê²Œì„ ì¢…ë£Œ
        // ============================================
        function endGame() {
            isGameActive = false;
            clearInterval(timerInterval);
            
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('wordInput').disabled = true;
            
            console.log('ğŸ¯ ê²Œì„ ì¢…ë£Œ!');
            console.log('ìµœì¢… ì ìˆ˜:', gameState.score);
            console.log('ìµœëŒ€ ì½¤ë³´:', gameState.maxCombo);
            console.log('ì—°ê²°í•œ ë‹¨ì–´:', gameState.wordChain.length);
            
            saveScore();
        }
        
        function saveScore() {
            if (!database) {
                console.warn('âš ï¸ Firebase ë¯¸ì—°ê²°, ì ìˆ˜ ì €ì¥ ë¶ˆê°€');
                showEndGameModal();
                return;
            }
            
            const timestamp = Date.now();
            const scoreData = {
                name: playerName,
                score: gameState.score,
                difficulty: selectedDifficulty,
                wordCount: gameState.wordChain.length,
                maxCombo: gameState.maxCombo,
                avgSimilarity: gameState.similarities.length > 0 
                    ? parseFloat((gameState.similarities.reduce((a,b) => a+b, 0) / gameState.similarities.length).toFixed(4))
                    : 0,
                timestamp: timestamp
            };
            
            console.log('ğŸ’¾ ì ìˆ˜ ì €ì¥ ì¤‘...', scoreData);
            
            const difficultyPath = `scores/${selectedDifficulty}`;
            const newScoreRef = firebase.database().ref(difficultyPath).push();
            
            newScoreRef.set(scoreData).then(() => {
                console.log('âœ… ì ìˆ˜ ì €ì¥ ì™„ë£Œ:', difficultyPath);
                showEndGameModal();
            }).catch((error) => {
                console.error('âŒ ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:', error);
                showEndGameModal();
            });
        }

        // ============================================
        // ê²Œì„ ì¬ì‹œì‘ / í™ˆìœ¼ë¡œ
        // ============================================
        function restartGame() {
            document.getElementById('endGameModal').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
        }

        function goToHome() {
            document.getElementById('endGameModal').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
        }
    </script>
</body>
</html>